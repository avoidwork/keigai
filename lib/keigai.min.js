/*
 2014 Jason Mulligan
 @license BSD-3 <https://raw.github.com/avoidwork/keigai/master/LICENSE>
 @link http://keigai.io
 @module keigai
 @version 0.7.3
*/
(function(global){var document=global.document,location=global.location,navigator=global.navigator,server=typeof process!="undefined",webWorker=typeof Blob!="undefined"&&typeof Worker!="undefined",MAX=10,VERSIONS=100,CACHE=500,EVENTS=["readystatechange","abort","load","loadstart","loadend","error","progress","timeout"],format,http,https,lib,mongodb,url,RENDER,TIME,WORKER;if(server){url=require("url");http=require("http");https=require("https");mongodb=require("mongodb").MongoClient;format=require("util").format;
if(typeof Promise=="undefined")Promise=require("es6-promise").Promise;if(typeof Storage=="undefined")localStorage=require("localStorage");if(typeof XMLHttpRequest=="undefined")XMLHttpRequest=null;if(typeof btoa=="undefined")btoa=require("btoa")}else if(typeof Buffer=="undefined")Buffer=function(){};lib=function(){var external,has,slice;var regex={after_space:/\s+.*/,allow:/^allow$/i,allow_cors:/^access-control-allow-methods$/i,and:/^&/,args:/\((.*)\)/,auth:/\/\/(.*)\@/,bool:/^(true|false)?$/,caps:/[A-Z]/,
cdata:/\&|<|>|\"|\'|\t|\r|\n|\@|\$/,checked_disabled:/checked|disabled/i,complete_loaded:/^(complete|loaded)$/i,csv_quote:/^\s|\"|\n|,|\s$/,del:/^del/,domain:/^[\w.-_]+\.[A-Za-z]{2,}$/,down:/down/,endslash:/\/$/,eol_nl:/\n$/,element_update:/id|innerHTML|innerText|textContent|type|src/,get_headers:/^(head|get|options)$/,get_remove_set:/get|remove|set/,hash:/^\#/,header_replace:/:.*/,header_value_replace:/.*:\s+/,html:/^<.*>$/,http_body:/200|201|202|203|206/,http_ports:/80|443/,ie:/msie|ie/i,ip:/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,
is_xml:/^<\?xml.*\?>/,json_maybe:/json|plain|javascript/,json_wrap:/^[\[\{]/,klass:/^\./,no:/no-store|no-cache/i,not_dotnotation:/-|\s/,not_endpoint:/.*\//,null_undefined:/null|undefined/,number:/(^-?\d\d*\.\d*$)|(^-?\d\d*$)|(^-?\.\d\d*$)|number/,number_format_1:/.*\./,number_format_2:/\..*/,number_present:/\d{1,}/,number_string:/number|string/i,number_string_object:/number|object|string/i,object_type:/\[object Object\]/,patch:/^patch$/,primitive:/^(boolean|function|number|string)$/,priv:/private/,
put_post:/^(post|put)$/i,radio_checkbox:/^(radio|checkbox)$/i,root:/^\/[^\/]/,select:/select/i,selector_is:/^:/,selector_complex:/\s+|\>|\+|\~|\:|\[/,set_del:/^(set|del|delete)$/,space_hyphen:/\s|-/,string_object:/string|object/i,svg:/svg/,top_bottom:/top|bottom/i,url:/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/i,
word:/^\w+$/,xdomainrequest:/^(get|post)$/i,xml:/xml/i};var lru={factory:function(max){return new LRU(max)}};function LRU(max){this.cache={};this.max=max||1E3;this.first=null;this.last=null;this.length=0}LRU.prototype.constructor=LRU;LRU.prototype.evict=function(){if(this.last!==null)this.remove(this.last);return this};LRU.prototype.get=function(key){var item=this.cache[key];if(item===undefined)return;this.set(key,item.value);return item.value};LRU.prototype.remove=function(key){var item=this.cache[key];
if(item){delete this.cache[key];this.length--;if(item.previous!==null)this.cache[item.previous].next=item.next;if(item.next!==null)this.cache[item.next].previous=item.previous;if(this.first===key)this.first=item.previous;if(this.last===key)this.last=item.next}return item};LRU.prototype.set=function(key,value){var item=this.remove(key);if(item===undefined)item=new LRUItem(value);else item.value=value;item.next=null;item.previous=this.first;this.cache[key]=item;if(this.first!==null)this.cache[this.first].next=
key;this.first=key;if(this.last===null)this.last=key;if(++this.length>this.max)this.evict();return this};function LRUItem(value){this.next=null;this.previous=null;this.value=value}LRUItem.prototype.constructor=LRUItem;var observable={factory:function(arg){return new Observable(arg)}};function Observable(arg){this.limit=arg||MAX;this.listeners={};this.hooks={}}Observable.prototype.constructor=Observable;Observable.prototype.dispatch=function(){var args=array.cast(arguments),ev=args.shift();if(ev&&
this.listeners[ev])utility.iterate(this.listeners[ev],function(i){i.handler.apply(i.scope,args)});return this};Observable.prototype.hook=function(target,ev){var self=this;if(typeof target.addEventListener!="function")throw new Error(label.invalidArguments);utility.genId(target);this.hooks[target.id]=function(arg){self.dispatch(ev,arg)};target.addEventListener(ev,this.hooks[target.id],false);return target};Observable.prototype.off=function(ev,id){if(this.listeners[ev])if(id)delete this.listeners[ev][id];
else delete this.listeners[ev];return this};Observable.prototype.on=function(ev,handler,id,scope){id=id||utility.uuid();scope=scope||this;if(!this.listeners[ev])this.listeners[ev]={};if(array.keys(this.listeners[ev]).length>=this.limit)throw new Error("Possible memory leak, more than "+this.limit+" listeners for event: "+ev);this.listeners[ev][id]={scope:scope,handler:handler};return this};Observable.prototype.once=function(ev,handler,id,scope){var self=this;id=id||utility.uuid();scope=scope||this;
return this.on(ev,function(){handler.apply(scope,[].concat(array.cast(arguments)));self.off(ev,id)},id,scope)};Observable.prototype.unhook=function(target,ev){target.removeEventListener(ev,this.hooks[target.id],false);delete this.hooks[target.id];return target};var base={factory:function(){return new Base}};function Base(){this.observer=null}Base.prototype.constructor=Base;Base.prototype.addEventListener=function(ev,listener,id,scope){this.observer.on(ev,listener,id,scope||this);return this};Base.prototype.addListener=
function(ev,listener,id,scope){this.observer.on(ev,listener,id,scope||this);return this};Base.prototype.dispatch=function(){this.observer.dispatch.apply(this.observer,[].concat(array.cast(arguments)));return this};Base.prototype.dispatchEvent=function(){this.observer.dispatch.apply(this.observer,[].concat(array.cast(arguments)));return this};Base.prototype.emit=function(){this.observer.dispatch.apply(this.observer,[].concat(array.cast(arguments)));return this};Base.prototype.hook=function(){this.observer.hook.apply(this.observer,
[].concat(array.cast(arguments)));return this};Base.prototype.listeners=function(ev){return ev?this.observer.listeners[ev]:this.listeners};Base.prototype.off=function(ev,id){this.observer.off(ev,id);return this};Base.prototype.on=function(ev,listener,id,scope){this.observer.on(ev,listener,id,scope||this);return this};Base.prototype.once=function(ev,listener,id,scope){this.observer.once(ev,listener,id,scope||this);return this};Base.prototype.removeEventListener=function(ev,id){this.observer.off(ev,
id);return this};Base.prototype.removeListener=function(ev,id){this.observer.off(ev,id);return this};var array={add:function(obj,arg){if(!array.contains(obj,arg))obj.push(arg);return obj},binIndex:function(obj,arg){var min=0,max=obj.length-1,idx,val;while(min<=max){idx=Math.floor((min+max)/2);val=obj[idx];if(val<arg)min=idx+1;else if(val>arg)max=idx-1;else return idx}return-1},cast:function(obj,key){key=key===true;var o=[];if(!isNaN(obj.length))o=slice.call(obj);else if(key)o=array.keys(obj);else utility.iterate(obj,
function(i){o.push(i)});return o},chunk:function(obj,size){var result=[],nth=number.round(obj.length/size,"up"),start=0,i=-1;while(++i<nth){start=i*size;result.push(array.limit(obj,start,size))}return result},clear:function(obj){return obj.length>0?array.remove(obj,0,obj.length):obj},clone:function(obj){return obj.slice()},contains:function(obj,arg){return obj.indexOf(arg)>-1},collect:function(obj,fn){var result=[];array.each(obj,function(i){result.push(fn(i))});return result},compact:function(obj,
diff){var result=[];result=obj.filter(function(i){return!regex.null_undefined.test(i)});return!diff?result:result.length<obj.length?result:null},count:function(obj,value){return obj.filter(function(i){return i===value}).length},diff:function(obj1,obj2){var result=[];array.each(obj1,function(i){if(!array.contains(obj2,i))array.add(result,i)});array.each(obj2,function(i){if(!array.contains(obj1,i))array.add(result,i)});return result},each:function(obj,fn,async,size){var nth=obj.length,i,offset;if(async!==
true){i=-1;while(++i<nth)if(fn.call(obj,obj[i],i)===false)break}else{size=size||10;offset=0;if(size>nth)size=nth;utility.repeat(function(){var i=-1,idx;while(++i<size){idx=i+offset;if(idx===nth||fn.call(obj,obj[idx],idx)===false)return false}offset+=size;if(offset>=nth)return false},undefined,undefined,false)}return obj},empty:function(obj){return obj.length===0},equal:function(obj1,obj2){return json.encode(obj1)===json.encode(obj2)},fib:function(arg){var result=[1,1],first=result[0],second=result[1],
sum;arg=(arg||100)-1;if(isNaN(arg)||arg<2)throw new Error(label.invalidArguments);while(--arg){sum=first+second;first=second;second=sum;result.push(sum)}return result},fill:function(obj,arg,start,offset){var fn=typeof arg=="function",l=obj.length,i=!isNaN(start)?start:0,nth=!isNaN(offset)?i+offset:l-1;if(nth>l-1)nth=l-1;while(i<=nth){obj[i]=fn?arg(obj[i]):arg;i++}return obj},first:function(obj){return obj[0]},flat:function(obj){var result=[];result=obj.reduce(function(a,b){return a.concat(b)},result);
return result},forEach:function(obj,fn,async,size){return array.each(obj,fn,async,size)},fromObject:function(obj){return array.mingle(array.keys(obj),array.cast(obj))},index:function(obj,arg){return obj.indexOf(arg)},indexed:function(obj){var indexed=[];utility.iterate(obj,function(v){indexed.push(v)});return indexed},intersect:function(obj1,obj2){var a=obj1.length>obj2.length?obj1:obj2,b=a===obj1?obj2:obj1;return a.filter(function(key){return array.contains(b,key)})},keepIf:function(obj,fn){if(typeof fn!=
"function")throw new Error(label.invalidArguments);var result=[],remove=[];result=obj.filter(fn);remove=array.diff(obj,result);array.each(remove,function(i){array.remove(obj,array.index(obj,i))});return obj},keys:function(obj){return Object.keys(obj)},keySort:function(obj,query,sub){query=query.replace(/\s*asc/ig,"").replace(/\s*desc/ig," desc");var queries=string.explode(query).map(function(i){return i.split(" ")}),sorts=[],braceS='["',braceE='"]';if(sub&&sub!=="")sub="."+sub;else sub="";array.each(queries,
function(i){var s=".",e="";if(regex.not_dotnotation.test(i[0])){s=braceS;e=braceE}sorts.push("try {");if(i[1]==="desc"){sorts.push("if ( a"+sub+s+i[0]+e+" < b"+sub+s+i[0]+e+" ) return 1;");sorts.push("if ( a"+sub+s+i[0]+e+" > b"+sub+s+i[0]+e+" ) return -1;")}else{sorts.push("if ( a"+sub+s+i[0]+e+" < b"+sub+s+i[0]+e+" ) return -1;");sorts.push("if ( a"+sub+s+i[0]+e+" > b"+sub+s+i[0]+e+" ) return 1;")}sorts.push("} catch (e) {");sorts.push("try {");sorts.push("if ( a"+sub+s+i[0]+e+" !== undefined ) return "+
(i[1]==="desc"?"-1":"1")+";");sorts.push("} catch (e) {}");sorts.push("try {");sorts.push("if ( b"+sub+s+i[0]+e+" !== undefined ) return "+(i[1]==="desc"?"1":"-1")+";");sorts.push("} catch (e) {}");sorts.push("}")});sorts.push("return 0;");return obj.sort(new Function("a","b",sorts.join("\n")))},last:function(obj,arg){var n=obj.length-1;if(arg>=n+1)return obj;else if(isNaN(arg)||arg===1)return obj[n];else return array.limit(obj,n- --arg,n)},limit:function(obj,start,offset){var result=[],i=start-1,
nth=start+offset,max=obj.length;if(max>0)while(++i<nth&&i<max)result.push(obj[i]);return result},max:function(obj){return array.last(obj.sort(array.sort))},mean:function(obj){return obj.length>0?array.sum(obj)/obj.length:undefined},median:function(obj){var nth=obj.length,mid=number.round(nth/2,"down"),sorted=obj.sort(array.sort);return number.odd(nth)?sorted[mid]:(sorted[mid-1]+sorted[mid])/2},merge:function(obj1,obj2){array.each(obj2,function(i){array.add(obj1,i)});return obj1},min:function(obj){return obj.sort(array.sort)[0]},
mingle:function(obj1,obj2){var result;result=obj1.map(function(i,idx){return[i,obj2[idx]]});return result},mode:function(obj){var values={},count=0,nth=0,mode=[],result;array.each(obj,function(i){if(!isNaN(values[i]))values[i]++;else values[i]=1});count=array.max(array.cast(values));utility.iterate(values,function(v,k){if(v===count)mode.push(number.parse(k))});nth=mode.length;if(nth>0)result=nth===1?mode[0]:mode;return result},percents:function(obj,precision,total){var result=[],custom=false,last,
padding,sum;precision=precision||0;if(total===undefined)total=array.sum(obj);else custom=true;array.each(obj,function(i){result.push(number.parse((i/total*100).toFixed(precision)))});if(!custom){sum=array.sum(result);if(sum<100){padding=number.parse(number.diff(sum,100).toFixed(precision));last=array.last(result)+padding;result[result.length-1]=last}else if(sum>100){padding=number.parse(number.diff(sum,100).toFixed(precision));last=number.parse((array.last(result)-padding).toFixed(precision));result[result.length-
1]=last}}return result},range:function(obj){return array.max(obj)-array.min(obj)},rassoc:function(obj,arg){var result;array.each(obj,function(i,idx){if(i[1]===arg){result=obj[idx];return false}});return result},reject:function(obj,fn){return array.diff(obj,obj.filter(fn))},remove:function(obj,start,end){if(isNaN(start)){start=obj.indexOf(start);if(start===-1)return obj}else start=start||0;var length=obj.length,remaining=obj.slice((end||start)+1||length);obj.length=start<0?length+start:start;obj.push.apply(obj,
remaining);return obj},removeIf:function(obj,fn){var remove;if(typeof fn!="function")throw new Error(label.invalidArguments);remove=obj.filter(fn);array.each(remove,function(i){array.remove(obj,array.index(obj,i))});return obj},removeWhile:function(obj,fn){if(typeof fn!="function")throw new Error(label.invalidArguments);var remove=[];array.each(obj,function(i){if(fn(i)!==false)remove.push(i);else return false});array.each(remove,function(i){array.remove(obj,array.index(obj,i))});return obj},replace:function(obj1,
obj2){array.remove(obj1,0,obj1.length);array.each(obj2,function(i){obj1.push(i)});return obj1},rest:function(obj,arg){arg=arg||1;if(arg<1)arg=1;return array.limit(obj,arg,obj.length)},rindex:function(obj,arg){var result=-1;array.each(obj,function(i,idx){if(i===arg)result=idx});return result},rotate:function(obj,arg){var nth=obj.length,result;if(arg===0)result=obj;else{if(arg<0)arg+=nth;else arg--;result=array.limit(obj,arg,nth);result=result.concat(array.limit(obj,0,arg))}return result},series:function(start,
end,offset){start=start||0;end=end||start;offset=offset||1;var result=[],n=-1,nth=Math.max(0,Math.ceil((end-start)/offset));while(++n<nth){result[n]=start;start+=offset}return result},sort:function(a,b){var types={a:typeof a,b:typeof b},c,d,result;if(types.a==="number"&&types.b==="number")result=a-b;else{c=a.toString();d=b.toString();if(c<d)result=-1;else if(c>d)result=1;else if(types.a===types.b)result=0;else if(types.a==="boolean")result=-1;else result=1}return result},sorted:function(obj){return obj.sort(array.sort)},
split:function(obj,divisor){var result=[],total=obj.length,nth=Math.ceil(total/divisor),low=Math.floor(total/divisor),lower=Math.ceil(total/nth),lowered=false,start=0,i=-1;if(number.diff(total,divisor*nth)>nth)lower=total-low*divisor+low-1;else if(total%divisor>0&&lower*nth>=total)lower--;while(++i<divisor){if(i>0)start=start+nth;if(!lowered&&(lower<divisor&&i===lower)){--nth;lowered=true}result.push(array.limit(obj,start,nth))}return result},stddev:function(obj){return Math.sqrt(array.variance(obj))},
sum:function(obj){var result=0;if(obj.length>0)result=obj.reduce(function(prev,cur){return prev+cur});return result},take:function(obj,n){return array.limit(obj,0,n)},toObject:function(ar){var obj={},i=ar.length;while(i--)obj[i.toString()]=ar[i];return obj},total:function(obj){return array.indexed(obj).length},unique:function(obj){var result=[];array.each(obj,function(i){array.add(result,i)});return result},variance:function(obj){var nth=obj.length,n=0,mean;if(nth>0){mean=array.mean(obj);array.each(obj,
function(i){n+=math.sqr(i-mean)});return n/nth}else return n},zip:function(obj,args){var result=[];if(!(args instanceof Array))args=typeof args=="object"?array.cast(args):[args];array.each(args,function(i,idx){if(!(i instanceof Array))this[idx]=[i]});array.each(obj,function(i,idx){result[idx]=[i];array.each(args,function(x){result[idx].push(x[idx]||null)})});return result}};var cache={lru:lru.factory(CACHE),clean:function(){array.each(array.keys(cache.lru.cache),function(i){if(cache.expired(i))cache.expire(i)})},
expire:function(uri){if(cache.lru.cache[uri]){cache.lru.remove(uri);return true}else return false},expired:function(uri){var item=cache.lru.cache[uri];return item&&item.value.expires<(new Date).getTime()},get:function(uri,expire){uri=utility.parse(uri).href;var item=cache.lru.get(uri);if(!item)return false;if(expire!==false&&cache.expired(uri)){cache.expire(uri);return false}return utility.clone(item,true)},set:function(uri,property,value){uri=utility.parse(uri).href;var item=cache.lru.get(uri);if(!item)item=
{permission:0};if(property==="permission")item.permission|=value;else if(property==="!permission")item.permission&=~value;else item[property]=value;cache.lru.set(uri,item);return item}};function KXMLHttpRequest(xhr){this.observer=observable.factory();this.defer=deferred.factory();this.xhr=xhr}KXMLHttpRequest.prototype=base.factory();KXMLHttpRequest.prototype.constructor=KXMLHttpRequest;var client={ie:function(){return!server&&regex.ie.test(navigator.userAgent)}(),version:function(){var version=0;
if(this.ie){version=navigator.userAgent.replace(/(.*msie|;.*)/gi,"");version=number.parse(string.trim(version))}return version},allows:function(uri,verb){if(string.isEmpty(uri)||string.isEmpty(verb))throw new Error(label.invalidArguments);uri=utility.parse(uri).href;verb=verb.toLowerCase();var result=false,bit=0;if(!cache.get(uri,false))result=undefined;else{if(regex.del.test(verb))bit=1;else if(regex.get_headers.test(verb))bit=4;else if(regex.put_post.test(verb))bit=2;else if(regex.patch.test(verb))bit=
8;result=Boolean(client.permissions(uri,verb).bit&bit)}return result},bit:function(args){var result=0;array.each(args,function(verb){verb=verb.toLowerCase();if(regex.get_headers.test(verb))result|=4;else if(regex.put_post.test(verb))result|=2;else if(regex.patch.test(verb))result|=8;else if(regex.del.test(verb))result|=1});return result},cors:function(uri){return!server&&(uri.indexOf("//")>-1&&uri.indexOf("//"+location.host)===-1)},headers:function(xhr,uri,type){var headers=string.trim(xhr.getAllResponseHeaders()).split("\n"),
items={},o={},allow=null,expires=new Date,cors=client.cors(uri);array.each(headers,function(i){var header=i.split(": ");items[header[0].toLowerCase()]=string.trim(header[1]);if(allow===null)if(!cors&&regex.allow.test(header)||cors&&regex.allow_cors.test(header))allow=header[1]});if(regex.no.test(items["cache-control"]))expires=expires.getTime();else if(items["cache-control"]&&regex.number_present.test(items["cache-control"]))expires=expires.setSeconds(expires.getSeconds()+number.parse(regex.number_present.exec(items["cache-control"])[0],
10));else if(items.expires)expires=(new Date(items.expires)).getTime();else expires=expires.getTime();o.expires=expires;o.headers=items;o.timestamp=new Date;o.permission=client.bit(allow!==null?string.explode(allow):[type]);if(type==="get"){cache.set(uri,"expires",o.expires);cache.set(uri,"headers",o.headers);cache.set(uri,"timestamp",o.timestamp);cache.set(uri,"permission",o.permission)}return o},parse:function(xhr,type){type=type||"";var result,obj;if((regex.json_maybe.test(type)||string.isEmpty(type))&&
(regex.json_wrap.test(xhr.responseText)&&Boolean(obj=json.decode(xhr.responseText,true))))result=obj;else if(type==="text/csv")result=csv.decode(xhr.responseText);else if(type==="text/tsv")result=csv.decode(xhr.responseText,"\t");else if(regex.xml.test(type)){if(type!=="text/xml")xhr.overrideMimeType("text/xml");result=xhr.responseXML}else if(type==="text/plain"&&(regex.is_xml.test(xhr.responseText)&&xml.valid(xhr.responseText)))result=xml.decode(xhr.responseText);else result=xhr.responseText;return result},
permissions:function(uri){var cached=cache.get(uri,false),bit=!cached?0:cached.permission,result={allows:[],bit:bit,map:{partial:8,read:4,write:2,"delete":1,unknown:0}};if(bit&1)result.allows.push("DELETE");if(bit&2){result.allows.push("POST");result.allows.push("PUT")}if(bit&4)result.allows.push("GET");if(bit&8)result.allows.push("PATCH");return result},jsonp:function(uri,args){var defer=deferred.factory(),callback="callback",cbid,s;if(external===undefined){if(!global.keigai)global.keigai={callback:{}};
external="keigai"}if(args instanceof Object&&!args.callback)callback=args.callback;do cbid=utility.genId().slice(0,10);while(global.callback[cbid]);uri=uri.replace(callback+"=?",callback+"="+external+".callback."+cbid);global.callback[cbid]=function(arg){utility.clearTimers(cbid);delete global.callback[cbid];defer.resolve(arg);element.destroy(s)};s=element.create("script",{src:uri,type:"text/javascript"},utility.dom("head")[0]);utility.defer(function(){defer.reject(undefined)},3E4,cbid);return defer},
kxhr:function(xhr){var obj=new KXMLHttpRequest(xhr);array.each(array.keys(Deferred.prototype),function(i){obj[i]=function(){return obj.defer[i].apply(obj.defer,array.cast(arguments))}});array.each(EVENTS,function(i){obj.hook(obj.xhr,i)});return obj},request:function(uri,type,args,headers){var cors,kxhr,payload,cached,contentType,doc,ab,blob;type=type||"GET";if((regex.put_post.test(type)||regex.patch.test(type))&&args===undefined)throw new Error(label.invalidArguments);uri=utility.parse(uri).href;
type=type.toLowerCase();headers=headers instanceof Object?headers:null;cors=client.cors(uri);kxhr=client.kxhr(!client.ie||(!cors||client.version>9)?new XMLHttpRequest:new XDomainRequest);payload=(regex.put_post.test(type)||regex.patch.test(type))&&args?args:null;cached=type==="get"?cache.get(uri):false;contentType=null;doc=typeof Document!="undefined";ab=typeof ArrayBuffer!="undefined";blob=typeof Blob!="undefined";if(cors&&(client.ie&&(client.version===9&&!regex.xdomainrequest.test(type))))throw new Error(label.notAvailable);
kxhr.on("readystatechange",function(ev){switch(this.xhr.readyState){case 1:this.dispatch("beforeXHR",this.xhr,ev);break;case 4:this.dispatch("afterXHR",this.xhr,ev);break}});if(!cors&&(!regex.get_headers.test(type)&&client.allows(uri,type)===false)){utility.delay(function(){kxhr.dispatch("beforeXHR",kxhr.xhr,null);kxhr.dispatch("afterXHR",kxhr.xhr,null)});kxhr.xhr.status=405;kxhr.reject(null)}if(type==="get"&&Boolean(cached)){if(server){kxhr.xhr.readyState=4;kxhr.xhr.status=200;kxhr.xhr._resheaders=
cached.headers}utility.delay(function(){kxhr.dispatch("beforeXHR",kxhr.xhr,null);kxhr.dispatch("afterXHR",kxhr.xhr,null)});kxhr.resolve(cached.response)}else utility.delay(function(){kxhr.xhr.open(type.toUpperCase(),uri,true);if(headers!==null&&headers.hasOwnProperty("content-type"))contentType=headers["content-type"];if(cors&&contentType===null)contentType="text/plain";if(payload!==null){if(payload.hasOwnProperty("xml"))payload=payload.xml;if(doc&&payload instanceof Document)payload=xml.decode(payload);
if(typeof payload=="string"&&regex.is_xml.test(payload))contentType="application/xml";if(!(ab&&payload instanceof ArrayBuffer)&&(!(blob&&payload instanceof Blob)&&(!(payload instanceof Buffer)&&payload instanceof Object))){contentType="application/json";payload=json.encode(payload)}if(contentType===null&&(ab&&payload instanceof ArrayBuffer||blob&&payload instanceof Blob))contentType="application/octet-stream";if(contentType===null)contentType="application/x-www-form-urlencoded; charset=UTF-8"}if(!client.ie||
(!cors||client.version>9)){if(headers===null)headers={};if(typeof cached=="object"&&cached.headers.hasOwnProperty("etag"))headers.etag=cached.headers.etag;if(contentType!==null)headers["content-type"]=contentType;if(headers.hasOwnProperty("callback"))delete headers.callback;headers["x-requested-with"]="XMLHttpRequest";utility.iterate(headers,function(v,k){if(v!==null&&k!=="withCredentials")kxhr.xhr.setRequestHeader(k,v)});if(typeof kxhr.xhr.withCredentials=="boolean"&&(headers!==null&&typeof headers.withCredentials==
"boolean"))kxhr.xhr.withCredentials=headers.withCredentials}kxhr.on("load",function(){var self=this,xdr=client.ie&&this.xhr.readyState===undefined,shared=true,o,r,t,redirect;if(!xdr&&this.xhr.readyState===4)switch(this.xhr.status){case 200:case 201:case 202:case 203:case 204:case 205:case 206:o=client.headers(this.xhr,uri,type);if(type==="head")return this.resolve(o.headers);else if(type==="options")return this.resolve(o.headers);else if(type!=="delete"){if(server&&regex.priv.test(o.headers["cache-control"]))shared=
false;if(regex.http_body.test(this.xhr.status)){t=o.headers["content-type"]||"";r=client.parse(this.xhr,t);if(r===undefined)this.reject(new Error(label.serverError))}if(type==="get"&&shared)cache.set(uri,"response",o.response=utility.clone(r,true));else cache.expire(uri,true)}else if(type==="delete")cache.expire(uri,true);switch(this.xhr.status){case 200:case 202:case 203:case 206:this.resolve(r);break;case 201:if((o.headers.location===undefined||string.isEmpty(o.headers.location))&&!string.isUrl(r))this.resolve(r);
else{redirect=string.trim(o.headers.Location||r);client.request(redirect).then(function(arg){self.resolve(arg)},function(e){self.reject(e)})}break;case 204:case 205:this.resolve(null);break}break;case 304:this.resolve(r);break;case 401:this.reject(new Error(this.xhr.responseText||label.serverUnauthorized));break;case 403:cache.set(uri,"!permission",client.bit([type]));this.reject(new Error(this.xhr.responseText||label.serverForbidden));break;case 405:cache.set(uri,"!permission",client.bit([type]));
this.reject(new Error(this.xhr.responseText||label.serverInvalidMethod));break;default:this.reject(new Error(this.xhr.responseText||label.serverError))}else if(xdr){r=client.parse(this.xhr,"text/plain");cache.set(uri,"permission",client.bit(["get"]));cache.set(uri,"response",r);this.resolve(r)}});kxhr.on("error",function(e){this.reject(e)});kxhr.xhr.send(payload!==null?payload:undefined)});return kxhr},scroll:function(dest,ms){var defer=deferred(),start=client.scrollPos(),t=0;ms=(!isNaN(ms)?ms:250)/
100;utility.repeat(function(){var pos=math.bezier(start[0],start[1],dest[0],dest[1],++t/100);window.scrollTo(pos[0],pos[1]);if(t===100){defer.resolve(true);return false}},ms,"scrolling");return defer},scrollPos:function(){return[window.scrollX||0,window.scrollY||0]}};var csv={decode:function(arg,delimiter){delimiter=delimiter||",";var regex=new RegExp(delimiter+'(?=(?:[^"]|"(?:[^"])[^"]*")*$)'),rows=string.trim(arg).split("\n"),keys=rows.shift().split(delimiter),result=[],nth=rows.length,x=keys.length,
i=-1,n,obj,row;while(++i<nth){obj={};row=rows[i].split(regex);n=-1;while(++n<x)obj[keys[n]]=utility.coerce((row[n]||"").replace(/^"|"$/g,""));result.push(obj)}return result},encode:function(arg,delimiter,header){var obj=json.decode(arg,true)||arg,result="";delimiter=delimiter||",";header=header!==false;function prepare(input){var output;if(input instanceof Array){output='"'+input.toString()+'"';if(regex.object_type.test(output))output='"'+csv.encode(input,delimiter)+'"'}else if(input instanceof Object)output=
'"'+csv.encode(input,delimiter)+'"';else if(regex.csv_quote.test(input))output='"'+input.replace(/"/g,'""')+'"';else output=input;return output}if(obj instanceof Array)if(obj[0]instanceof Object){if(header)result=array.keys(obj[0]).join(delimiter)+"\n";result+=obj.map(function(i){return csv.encode(i,delimiter,false)}).join("\n")}else result+=prepare(obj,delimiter)+"\n";else{if(header)result=array.keys(obj).join(delimiter)+"\n";result+=array.cast(obj).map(prepare).join(delimiter)+"\n"}return result.replace(regex.eol_nl,
"")}};var filter={factory:function(target,list,filters,debounce){var ref=[list],obj;debounce=debounce||250;if(!(target instanceof Element)||(list&&!list.store||(typeof filters!="string"||string.isEmpty(filters))))throw new Error(label.invalidArguments);obj=(new DataListFilter(target,ref[0],debounce)).set(filters);element.attr(target,"type","text");obj.observer.hook(obj.element,"keyup");obj.observer.hook(obj.element,"input");obj.on("keyup",obj.update,"keyup");obj.on("input",obj.update,"input");return obj}};
function DataListFilter(element,list,debounce){this.debounce=debounce;this.element=element;this.filters={};this.list=list;this.observer=observable.factory()}DataListFilter.prototype=base.factory();DataListFilter.prototype.constructor=DataListFilter;DataListFilter.prototype.set=function(fields){var obj={};array.each(string.explode(fields),function(v){obj[v]=""});this.filters=obj;return this};DataListFilter.prototype.teardown=function(){this.observer.unhook(this.element,"keyup");this.observer.unhook(this.element,
"input");return this};DataListFilter.prototype.update=function(){var self=this;utility.defer(function(){var val=element.val(self.element).toString();self.list.dispatch("beforeFilter",self.element,val);if(!string.isEmpty(val)){utility.iterate(self.filters,function(v,k){var queries=string.explode(val);queries=queries.filter(function(i){return!string.isEmpty(i)});array.each(queries,function(i,idx){this[idx]="^.*"+string.escape(i).replace(/(^\*|\*$)/g,"").replace(/\*/g,".*")+".*"});this[k]=queries.join(",")});
self.list.filter=self.filters}else self.list.filter=null;self.list.pageIndex=1;self.list.refresh();self.list.dispatch("afterFilter",self.element)},this.debounce,this.element.id+"Debounce");return this};var grid={factory:function(target,store,fields,sortable,options,filtered,debounce){var ref=[store],obj,template,header,width,css,sort;obj=new DataGrid(target,ref[0],fields,sortable,options,filtered);template="";header=element.create("li",{},element.create("ul",{"class":"header"},obj.element));width=
100/obj.fields.length+"%";css="display:inline-block;width:"+width;sort=obj.options.order?string.explode(obj.options.order):[];array.each(obj.fields,function(i){var trimmed=i.replace(/.*\./g,""),el=element.create("span",{innerHTML:string.capitalize(string.unCamelCase(string.unhyphenate(trimmed,true)).replace(/_|-/g," "),true),style:css,"data-field":i},header);if(array.contains(obj.sortable,i)){element.klass(el,"sortable",true);if(sort.filter(function(x){return x.indexOf(i)===0}).length>0)element.data(el,
"sort",array.contains(sort,i+" desc")?"desc":"asc")}template+='<span class="'+i+'" data-field="'+i+'" style="'+css+'">{{'+i+"}}</span>"});if(obj.sortable.length>0)obj.observer.hook(header.parentNode,"click",obj.sort,"sort",obj);ref.push(list.factory(obj.element,ref[0],template,obj.options));obj.list=ref[1];if(obj.filtered===true){ref.push(filter.factory(element.create("input",{"class":"filter",placeholder:"Filter"},obj.element,"first"),ref[1],obj.fields.join(","),debounce||250));obj.filter=ref[2]}obj.on("beforeRefresh",
function(arg){element.dispatch(arg,"beforeRefresh")},"bubble");obj.on("afterRefresh",function(arg){element.dispatch(arg,"afterRefresh")},"bubble");obj.on("click",function(e){if(element.hasClass(e.currentTarget,"header"))obj.sort(e)},"header");obj.list.on("change",function(){obj.dispatch.apply(obj,["change"].concat(array.cast(arguments)))},"change");obj.list.on("beforeFilter",function(){obj.dispatch.apply(obj,["beforeFilter"].concat(array.cast(arguments)))},"beforeFilter");obj.list.on("afterFilter",
function(){obj.dispatch.apply(obj,["afterFilter"].concat(array.cast(arguments)))},"afterFilter");return obj}};function DataGrid(target,store,fields,sortable,options,filtered){var sortOrder;if(options.order&&!string.isEmpty(options.order))sortOrder=string.explode(options.order).map(function(i){return i.replace(regex.after_space,"")});this.element=element.create("section",{"class":"grid"},target);this.fields=fields;this.filter=null;this.filtered=filtered===true;this.list=null;this.observer=observable.factory();
this.options=options||{};this.store=store;this.sortable=sortable||[];this.sortOrder=sortOrder||(sortable||[])}DataGrid.prototype=base.factory();DataGrid.prototype.constructor=DataGrid;DataGrid.prototype.add=function(record){var self=this;this.store.set(null,record).then(null,function(e){utility.error(e);self.dispatch("error",e)});return this};DataGrid.prototype.dump=function(){return this.store.dump(this.list.records,this.fields)};DataGrid.prototype.refresh=function(){var sort=[],self=this;this.dispatch("beforeRefresh",
this.element);if(this.sortOrder.length>0){array.each(this.sortOrder,function(i){var obj=element.find(self.element,".header span[data-field='"+i+"']")[0];sort.push(string.trim(i+" "+(element.data(obj,"sort")||"")))});this.options.order=this.list.order=sort.join(", ")}this.list.where=null;utility.merge(this.list,this.options);this.list.refresh();this.dispatch("afterRefresh",this.element);return this};DataGrid.prototype.remove=function(record){var self=this;this.store.del(record).then(null,function(e){utility.error(e);
self.dispatch("error",e)});return this};DataGrid.prototype.sort=function(ev){var target=utility.target(ev),field;utility.stop(ev);if(element.hasClass(target,"sortable")){field=element.data(target,"field");element.data(target,"sort",element.data(target,"sort")==="asc"?"desc":"asc");array.remove(this.sortOrder,field);this.sortOrder.splice(0,0,field);this.refresh()}return this};DataGrid.prototype.teardown=function(){if(this.filter!==null){this.filter.teardown();this.filter=null}this.list.teardown();
this.observer.unhook(element.find(this.element,".header")[0],"click");element.destroy(this.element);this.element=null;return this};DataGrid.prototype.update=function(key,data){var self=this;this.store.update(key,data).then(null,function(e){utility.error(e);self.dispatch("error",e)});return this};var list={factory:function(target,store,template,options){var ref=[store],obj;if(!(target instanceof Element)||(typeof store!="object"||!regex.string_object.test(typeof template)))throw new Error(label.invalidArguments);
obj=new DataList(element.create("ul",{"class":"list"},target),ref[0],template);if(options instanceof Object)utility.merge(obj,options);obj.store.lists.push(obj);obj.on("beforeRefresh",function(arg){element.dispatch(arg,"beforeRefresh")},"bubble");obj.on("afterRefresh",function(arg){element.dispatch(arg,"afterRefresh")},"bubble");obj.on("change",function(arg){element.dispatch(obj.element,"change",arg)},"change");obj.on("click",function(e){var target=utility.target(e),page;utility.stop(e);if(target.nodeName===
"A"){page=element.data(target,"page");if(!isNaN(page))obj.page(page)}},"pagination");if(typeof MutationObserver=="function"){obj.mutation=new MutationObserver(function(arg){obj.dispatch("change",arg)});obj.mutation.observe(obj.element,{childList:true,subtree:true})}if(obj.store.uri===null||obj.store.loaded)obj.refresh();return obj},pages:function(){if(isNaN(this.pageSize))throw new Error(label.invalidArguments);return Math.ceil((!this.filter?this.total:this.filtered.length)/this.pageSize)},range:function(){var start=
this.pageIndex*this.pageSize-this.pageSize,end=this.pageSize;return[start,end]}};function DataList(element,store,template){this.callback=null;this.current=[];this.element=element;this.emptyMsg=label.noData;this.filter=null;this.filtered=[];this.id=utility.genId();this.items=[];this.mutation=null;this.observer=observable.factory();this.pageIndex=1;this.pageSize=null;this.pageRange=5;this.pagination="bottom";this.placeholder="";this.order="";this.records=[];this.template=template;this.total=0;this.store=
store;this.where=null}DataList.prototype=base.factory();DataList.prototype.constructor=DataList;DataList.prototype.add=function(record){var self=this;this.store.set(null,record).then(null,function(e){utility.error(e);self.dispatch("error",e)});return this};DataList.prototype.dump=function(){return this.store.dump(this.records)};DataList.prototype.page=function(n){this.pageIndex=n;return this.refresh()};DataList.prototype.pages=function(){var self=this,obj=this.element,page=this.pageIndex,pos=this.pagination,
range=this.pageRange,mid=Math.floor(range/2),start=page-mid,end=page+mid,total=list.pages.call(this),diff;if(!regex.top_bottom.test(pos))throw new Error(label.invalidArguments);array.each(utility.dom("#"+obj.id+"-pages-top, #"+obj.id+"-pages-bottom"),function(i){if(i){self.observer.unhook(i,"click");element.destroy(i)}});if(this.filter&&this.filtered.length===0||(this.total===0||total===1))return this;if(start<1){diff=number.diff(start,1);start=start+diff;end=end+diff}if(end>total){end=total;start=
end-range+1;if(start<1)start=1}if(number.diff(start,end)>=range)--end;array.each(string.explode(pos),function(i){var current=false,more=page>1,next=page+1<=total,last=page>=total,el,n;el=element.create("ul",{"class":"list pages hidden "+i,id:obj.id+"-pages-"+i},obj,i==="bottom"?"after":"before");element.create(more?"a":"span",{"class":"first page","data-page":1,innerHTML:"&lt;&lt;"},element.create("li",{},el));element.create(more?"a":"span",{"class":"prev page","data-page":page-1,innerHTML:"&lt;"},
element.create("li",{},el));for(n=start;n<=end;n++){current=n===page;element.create(current?"span":"a",{"class":current?"current page":"page","data-page":n,innerHTML:n},element.create("li",{},el))}element.create(next?"a":"span",{"class":"next page","data-page":next?page+1:null,innerHTML:"&gt;"},element.create("li",{},el));element.create(last?"span":"a",{"class":"last page","data-page":last?null:total,innerHTML:"&gt;&gt;"},element.create("li",{},el));element.klass(el,"hidden",false);self.observer.hook(el,
"click")});return this};DataList.prototype.refresh=function(create){var self=this,el=this.element,template=typeof this.template=="object",filter=this.filter!==null,items=[],callback=typeof this.callback=="function",reg=new RegExp,registry=[],range=[],fn,ceiling,next;create=create===true;this.dispatch("beforeRefresh",el);if(!template)fn=function(i){var html=self.template,items=array.unique(html.match(/\{\{[\w\.\-\[\]]+\}\}/g));html=html.replace("{{"+self.store.key+"}}",i.key);array.each(items,function(attr){var key=
attr.replace(/\{\{|\}\}/g,""),value=utility.walk(i.data,key);if(value===undefined)value="";reg.compile(string.escape(attr),"g");html=html.replace(reg,value)});html=html.replace(/\{\{.*\}\}/g,self.placeholder);return'<li data-key="'+i.key+'">'+html+"</li>"};else fn=function(i){var obj=json.encode(self.template),items=array.unique(obj.match(/\{\{[\w\.\-\[\]]+\}\}/g));obj=obj.replace("{{"+self.store.key+"}}",i.key);array.each(items,function(attr){var key=attr.replace(/\{\{|\}\}/g,""),value=utility.walk(i.data,
key)||"";reg.compile(string.escape(attr),"g");obj=obj.replace(reg,json.encode(value).replace(/(^")|("$)/g,""))});obj=json.decode(obj.replace(/\{\{.*\}\}/g,self.placeholder));return{li:obj}};next=function(args){self.records=args;self.total=self.records.length;self.filtered=[];self.current=[];if(filter)array.each(self.records,function(i){utility.iterate(self.filter,function(v,k){var reg,key;if(array.contains(registry,i.key))return false;v=string.explode(v);reg=new RegExp,key=k===self.store.key;array.each(v,
function(query){var value=!key?utility.walk(i.data,k):"";utility.compile(reg,query,"i");if(key&&reg.test(i.key)||reg.test(value)){registry.push(i.key);self.filtered.push(i);return false}})})});if(self.pageSize!==null&&(!isNaN(self.pageIndex)&&!isNaN(self.pageSize))){ceiling=list.pages.call(self);if(ceiling>0&&self.pageIndex>ceiling)return self.page(ceiling);else if(self.total>0){range=list.range.call(self);self.current=array.limit(!filter?self.records:self.filtered,range[0],range[1])}}else self.current=
!filter?self.records:self.filtered;array.each(self.current,function(i){var html=fn(i),hash=btoa(html);items.push({key:i.key,template:html,hash:hash})});utility.render(function(){var destroy=[],callbacks=[],i,nth;if(items.length===0)element.html(el,'<li class="empty">'+self.emptyMsg+"</li>");else if(self.items.length===0){element.html(el,items.map(function(i){return i.template}).join(""));if(callback)array.each(array.cast(el.childNodes),function(i){self.callback(i)})}else{array.each(items,function(i,
idx){if(self.items[idx]!==undefined&&self.items[idx].hash!==i.hash){element.data(element.html(el.childNodes[idx],i.template.replace(/<li data-key=\"\d+\">|<\/li>/g,"")),"key",i.key);callbacks.push(idx)}else if(self.items[idx]===undefined){element.create(i.template,null,el);callbacks.push(idx)}});if(items.length<self.items.length){i=items.length-1;nth=self.items.length;while(++i<nth)destroy.push(i);array.each(destroy.reverse(),function(i){element.destroy(el.childNodes[i])})}if(callback)array.each(callbacks,
function(i){self.callback(el.childNodes[i])})}self.items=items;if(self.pageSize!==null&&(regex.top_bottom.test(self.pagination)&&(!isNaN(self.pageIndex)&&!isNaN(self.pageSize))))self.pages();else array.each(utility.$("#"+el.id+"-pages-top, #"+el.id+"-pages-bottom"),function(i){element.destroy(i)});self.dispatch("afterRefresh",el)})};if(this.where===null)string.isEmpty(this.order)?next(this.store.get()):this.store.sort(this.order,create).then(next,function(e){utility.error(e);self.dispatch("error",
e)});else if(string.isEmpty(this.order))this.store.select(this.where).then(next,function(e){utility.error(e);self.dispatch("error",e)});else this.store.sort(this.order,create,this.where).then(next,function(e){utility.error(e);self.dispatch("error",e)});return this};DataList.prototype.remove=function(record){var self=this;this.store.del(record).then(null,function(e){utility.error(e);self.dispatch("error",e)});return this};DataList.prototype.sort=function(order){this.order=order;return this.refresh()};
DataList.prototype.teardown=function(destroy){destroy=destroy===true;var self=this;array.each(this.store.lists,function(i,idx){if(i.id===self.id){this.remove(idx);return false}});delete this.observer.hooks[this.element.id];if(destroy){element.destroy(this.element);this.element=null}return this};DataList.prototype.update=function(key,data){var self=this;this.store.update(key,data).then(null,function(e){utility.error(e);self.dispatch("error",e)});return this};var deferred={factory:function(){return new Deferred}};
function Deferred(){var self=this;this.promise=promise.factory();this.onDone=[];this.onAlways=[];this.onFail=[];this.promise.then(function(arg){array.each(self.onDone,function(i){i(arg)});array.each(self.onAlways,function(i){i(arg)});self.onAlways=[];self.onDone=[];self.onFail=[]},function(arg){array.each(self.onFail,function(i){i(arg)});array.each(self.onAlways,function(i){i(arg)});self.onAlways=[];self.onDone=[];self.onFail=[]})}Deferred.prototype.constructor=Deferred;Deferred.prototype.always=
function(arg){this.onAlways.push(arg);return this};Deferred.prototype.done=function(arg){this.onDone.push(arg);return this};Deferred.prototype.fail=function(arg){this.onFail.push(arg);return this};Deferred.prototype.reject=function(arg){this.promise.reject.call(this.promise,arg);return this};Deferred.prototype.resolve=function(arg){this.promise.resolve.call(this.promise,arg);return this};Deferred.prototype.then=function(success,failure){return this.promise.then(success,failure)};var element={appendTo:function(obj,
child){obj.appendChild(child);return obj},attr:function(obj,key,value){var target,result;if(regex.svg.test(obj.namespaceURI))if(value===undefined){result=obj.getAttributeNS(obj.namespaceURI,key);if(result===null||string.isEmpty(result))result=undefined;else result=utility.coerce(result)}else obj.setAttributeNS(obj.namespaceURI,key,value);else{if(typeof value=="string")value=string.trim(value);if(regex.checked_disabled.test(key)&&value===undefined)return utility.coerce(obj[key]);else if(regex.checked_disabled.test(key)&&
value!==undefined)obj[key]=value;else if(obj.nodeName==="SELECT"&&(key==="selected"&&value===undefined))return utility.dom("#"+obj.id+' option[selected="selected"]')[0]||utility.dom("#"+obj.id+" option")[0];else if(obj.nodeName==="SELECT"&&(key==="selected"&&value!==undefined)){target=utility.dom("#"+obj.id+' option[selected="selected"]')[0];if(target!==undefined){target.selected=false;target.removeAttribute("selected")}target=utility.dom("#"+obj.id+' option[value="'+value+'"]')[0];target.selected=
true;target.setAttribute("selected","selected")}else if(value===undefined){result=obj.getAttribute(key);if(result===null||string.isEmpty(result))result=undefined;else result=utility.coerce(result);return result}else obj.setAttribute(key,value)}return obj},clear:function(obj){if(typeof obj.reset=="function")obj.reset();else if(obj.value!==undefined)element.update(obj,{innerHTML:"",value:""});else element.update(obj,{innerHTML:""});return obj},create:function(type,args,obj,pos){var svg=false,frag=false,
fragment,uid,result;type=type.replace(/\t|\n|\r/g,"");if(obj)svg=obj.namespaceURI&&regex.svg.test(obj.namespaceURI);else obj=document.body;if(args instanceof Object&&(args.id&&!utility.dom("#"+args.id))){uid=args.id;delete args.id}else if(!svg)uid=utility.genId(undefined,true);if(regex.html.test(type)){frag=true;fragment=element.frag(type);result=fragment.childNodes.length===1?fragment.childNodes[0]:array.cast(fragment.childNodes)}else{if(!svg&&!regex.svg.test(type))fragment=document.createElement(type);
else fragment=document.createElementNS("http://www.w3.org/2000/svg",type);if(uid)fragment.id=uid;if(args instanceof Object)element.update(fragment,args)}if(!pos||pos==="last")obj.appendChild(fragment);else if(pos==="first")element.prependChild(obj,fragment);else if(pos==="after"){pos={after:obj};obj=obj.parentNode;obj.insertBefore(fragment,pos.after.nextSibling)}else if(pos.after)obj.insertBefore(fragment,pos.after.nextSibling);else if(pos==="before"){pos={before:obj};obj=obj.parentNode;obj.insertBefore(fragment,
pos.before)}else if(pos.before)obj.insertBefore(fragment,pos.before);else obj.appendChild(fragment);return!frag?fragment:result},css:function(obj,key,value){if(!regex.caps.test(key))key=string.toCamelCase(key);if(value!==undefined){obj.style[key]=value;return obj}else return obj.style[key]},data:function(obj,key,value){if(value!==undefined){obj.setAttribute("data-"+key,regex.json_wrap.test(value)?json.encode(value):value);return obj}else return utility.coerce(obj.getAttribute("data-"+key))},destroy:function(obj){if(obj.parentNode!==
null)obj.parentNode.removeChild(obj);return undefined},disable:function(obj){if(typeof obj.disabled=="boolean"&&!obj.disabled)obj.disabled=true;return obj},dispatch:function(obj,type,data,bubbles,cancelable){var ev;try{ev=new CustomEvent(type)}catch(e){ev=document.createEvent("CustomEvent")}bubbles=bubbles!==false;cancelable=cancelable!==false;ev.initCustomEvent(type,bubbles,cancelable,data||{});obj.dispatchEvent(ev);return obj},enable:function(obj){if(typeof obj.disabled=="boolean"&&obj.disabled)obj.disabled=
false;return obj},find:function(obj,arg){var result=[];utility.genId(obj,true);array.each(string.explode(arg),function(i){result=result.concat(utility.dom("#"+obj.id+" "+i))});return result},frag:function(arg){var obj=document.createDocumentFragment();if(arg){array.each(array.cast(element.create("div",{innerHTML:arg},obj).childNodes),function(i){obj.appendChild(i)});obj.removeChild(obj.childNodes[0])}return obj},has:function(obj,arg){var result=element.find(obj,arg);return!isNaN(result.length)&&result.length>
0},hasClass:function(obj,arg){return obj.classList.contains(arg)},hidden:function(obj){return obj.style.display==="none"||typeof obj.hidden=="boolean"&&obj.hidden},html:function(obj,arg){if(arg===undefined)return obj.innerHTML;else{obj.innerHTML=arg;return obj}},is:function(obj,arg){if(regex.selector_is.test(arg))return element.find(obj.parentNode,obj.nodeName.toLowerCase()+arg).filter(function(i){return i.id===obj.id}).length===1;else return(new RegExp(arg,"i")).test(obj.nodeName)},klass:function(obj,
arg,add){add=add!==false;arg=string.explode(arg," ");if(add)array.each(arg,function(i){obj.classList.add(i)});else array.each(arg,function(i){if(i!=="*")obj.classList.remove(i);else{array.each(obj.classList,function(x){this.remove(x)});return false}});return obj},position:function(obj){obj=obj||document.body;var left,top,right,bottom,height,width;left=top=0;width=obj.offsetWidth;height=obj.offsetHeight;if(obj.offsetParent){top=obj.offsetTop;left=obj.offsetLeft;while(obj=obj.offsetParent){left+=obj.offsetLeft;
top+=obj.offsetTop}right=document.body.offsetWidth-(left+width);bottom=document.body.offsetHeight-(top+height)}else{right=width;bottom=height}return[left,top,right,bottom]},prependChild:function(obj,child){return obj.childNodes.length===0?obj.appendChild(child):obj.insertBefore(child,obj.childNodes[0])},removeAttr:function(obj,key){var target;if(regex.svg.test(obj.namespaceURI))obj.removeAttributeNS(obj.namespaceURI,key);else if(obj.nodeName==="SELECT"&&key==="selected"){target=utility.dom("#"+obj.id+
' option[selected="selected"]')[0];if(target){target.selected=false;target.removeAttribute("selected")}}else obj.removeAttribute(key);return obj},scrollTo:function(obj,ms,offsetTop,offsetLeft){var pos=array.remove(element.position(obj),2,3);if(!isNaN(offsetTop))pos[0]+=offsetTop;if(!isNaN(offsetLeft))pos[1]+=offsetLeft;return client.scroll(pos,ms)},serialize:function(obj,string,encode){string=string===true;encode=encode!==false;var children=[],registry={},result;children=obj.nodeName==="FORM"?obj.elements?
array.cast(obj.elements):obj.find("button, input, select, textarea"):[obj];array.each(children,function(i){if(i.nodeName==="FORM")utility.merge(registry,json.decode(element.serialize(i)));else if(!registry[i.name])registry[i.name]=element.val(i)});if(!string)result=json.encode(registry);else{result="";utility.iterate(registry,function(v,k){encode?result+="&"+encodeURIComponent(k)+"="+encodeURIComponent(v):result+="&"+k+"="+v});result=result.replace(regex.and,"?")}return result},size:function(obj){return[obj.offsetWidth+
number.parse(obj.style.paddingLeft||0)+number.parse(obj.style.paddingRight||0)+number.parse(obj.style.borderLeft||0)+number.parse(obj.style.borderRight||0),obj.offsetHeight+number.parse(obj.style.paddingTop||0)+number.parse(obj.style.paddingBottom||0)+number.parse(obj.style.borderTop||0)+number.parse(obj.style.borderBottom||0)]},text:function(obj,arg){var key=obj.textContent?"textContent":"innerText",payload={},set=false;if(typeof arg!="undefined"){set=true;payload[key]=arg}return set?element.update(obj,
payload):obj[key]},toggleClass:function(obj,arg){obj.classList.toggle(arg);return obj},update:function(obj,args){utility.iterate(args,function(v,k){if(regex.element_update.test(k))obj[k]=v;else if(k==="class")!string.isEmpty(v)?element.klass(obj,v):element.klass(obj,"*",false);else if(k.indexOf("data-")===0)element.data(obj,k.replace("data-",""),v);else element.attr(obj,k,v)});return obj},val:function(obj,value){var ev="input",output;if(value===undefined){if(regex.radio_checkbox.test(obj.type)){if(string.isEmpty(obj.name))throw new Error(label.expectedProperty);
array.each(utility.dom("input[name='"+obj.name+"']"),function(i){if(i.checked){output=i.value;return false}})}else if(regex.select.test(obj.type))output=obj.options[obj.selectedIndex].value;else if(obj.value)output=obj.value;else output=element.text(obj);if(output!==undefined){output=utility.coerce(output);if(typeof output=="string")output=string.trim(output)}else output=""}else{value=value.toString();if(regex.radio_checkbox.test(obj.type)){ev="click";array.each(utility.dom("input[name='"+obj.name+
"']"),function(i){if(i.value===value){i.checked=true;output=i;return false}})}else if(regex.select.test(obj.type)){ev="change";array.each(element.find(obj,"> *"),function(i){if(i.value===value){i.selected=true;output=i;return false}})}else obj.value!==undefined?obj.value=value:element.text(obj,value);element.dispatch(obj,ev);output=obj}return output}};var json={decode:function(arg,silent){try{return JSON.parse(arg)}catch(e){if(silent!==true)utility.error(e,arguments,this);return undefined}},encode:function(arg,
silent){try{return JSON.stringify(arg)}catch(e){if(silent!==true)utility.error(e,arguments,this);return undefined}}};var label={expectedNumber:"Expected a Number",expectedProperty:"Expected a property, and it was not set",expectedObject:"Expected an Object",invalidArguments:"One or more arguments is invalid",invalidStateNoHeaders:"INVALID_STATE_ERR: Headers have not been received",invalidStateNoSync:"Synchronous XMLHttpRequest requests are not supported",invalidStateNotOpen:"INVALID_STATE_ERR: Object is not open",
invalidStateNotSending:"INVALID_STATE_ERR: Object is sending",invalidStateNotUsable:"INVALID_STATE_ERR: Object is not usable",noData:"Nothing to display",notAvailable:"Requested method is not available",datastoreNoPrevVersion:"No previous version found",serverError:"Server error has occurred",serverForbidden:"Forbidden to access URI",serverInvalidMethod:"Method not allowed",serverUnauthorized:"Authorization required to access URI",upgrade:"Your browser is too old to use keigai, please upgrade"};var math=
{bezier:function(){var a=array.cast(arguments),t=a.pop(),P=array.chunk(a,2),n=P.length,c,S0,Q0,Q1,Q2,C0,C1,C2,C3;if(n<2||n>4)throw new Error(label.invalidArguments);c=[];S0=1-t;Q0=math.sqr(S0);Q1=2*S0*t;Q2=math.sqr(t);C0=Math.pow(S0,3);C1=3*Q0*t;C2=3*S0*Q2;C3=Math.pow(t,3);if(n===2){c.push(S0*P[0][0]+t*P[1][0]);c.push(S0*P[0][1]+t*P[1][1])}else if(n===3){c.push(Q0*P[0][0]+Q1*P[1][0]+(Q2+P[2][0]));c.push(Q0*P[0][1]+Q1*P[1][1]+(Q2+P[2][1]))}else if(n===4){c.push(C0*P[0][0]+C1*P[1][0]+C2*P[2][0]+C3*
P[3][0]);c.push(C0*P[0][1]+C1*P[1][1]+C2*P[2][1]+C3*P[3][1])}return c},dist:function(a,b){return Math.sqrt(math.sqr(b[0]-a[0])+math.sqr(b[1]-a[1]))},sqr:function(n){return Math.pow(n,2)}};var number={diff:function(num1,num2){if(isNaN(num1)||isNaN(num2))throw new Error(label.expectedNumber);return Math.abs(num1-num2)},even:function(arg){return arg%2===0},format:function(arg,delimiter,every){if(isNaN(arg))throw new Error(label.expectedNumber);arg=arg.toString();delimiter=delimiter||",";every=every||
3;var d=arg.indexOf(".")>-1?"."+arg.replace(regex.number_format_1,""):"",a=arg.replace(regex.number_format_2,"").split("").reverse(),p=Math.floor(a.length/every),i=1,n,b;for(b=0;b<p;b++){n=i===1?every:every*i+(i===2?1:i-1);a.splice(n,0,delimiter);i++}a=a.reverse().join("");if(a.charAt(0)===delimiter)a=a.substring(1);return a+d},half:function(a,b){return b?a/b===0.5:a/2},odd:function(arg){return!number.even(arg)},parse:function(arg,base){return base===undefined?parseFloat(arg):parseInt(arg,base)},
random:function(arg){arg=arg||100;return Math.floor(Math.random()*(arg+1))},round:function(arg,direction){arg=number.parse(arg);if(direction===undefined||string.isEmpty(direction))return number.parse(arg.toFixed(0));else if(regex.down.test(direction))return~~arg;else return Math.ceil(arg)}};var promise={factory:function(){var promise,pCatch,pResolve,pReject,pThen;promise=new Promise(function(resolve,reject){pResolve=resolve;pReject=reject});pCatch=function(){return promise["catch"].apply(promise,
arguments)};pThen=function(){return promise.then.apply(promise,arguments)};return{"catch":pCatch,resolve:pResolve,reject:pReject,then:pThen}}};var store={factory:function(recs,args){var obj=new DataStore;if(args instanceof Object)utility.merge(obj,args);if(recs!==null&&typeof recs=="object")obj.batch("set",recs);return obj},worker:function(ev){var cmd=ev.data.cmd,clauses,cond,result,where,functions;if(cmd==="select"){where=JSON.parse(ev.data.where);functions=ev.data.functions;clauses=array.fromObject(where);
cond="return ( ";if(clauses.length>1)array.each(clauses,function(i,idx){var b1="( ";if(idx>0)b1=" && ( ";if(array.contains(functions,i[0]))cond+=b1+i[1]+'( rec.data["'+i[0]+'"] ) )';else if(!isNaN(i[1]))cond+=b1+'rec.data["'+i[0]+'"] === '+i[1]+" )";else cond+=b1+'rec.data["'+i[0]+'"] === "'+i[1]+'" )'});else if(array.contains(functions,clauses[0][0]))cond+=clauses[0][1]+'( rec.data["'+clauses[0][0]+'"] )';else if(!isNaN(clauses[0][1]))cond+='rec.data["'+clauses[0][0]+'"] === '+clauses[0][1];else cond+=
'rec.data["'+clauses[0][0]+'"] === "'+clauses[0][1]+'"';cond+=" );";result=ev.data.records.filter(new Function("rec",cond))}else if(cmd==="sort")result=array.keySort(ev.data.records,ev.data.query,"data");postMessage(result)}};function DataStore(){this.autosave=false;this.callback=null;this.collections=[];this.credentials=null;this.lists=[];this.depth=0;this.events=true;this.expires=null;this.headers={Accept:"application/json"};this.ignore=[];this.key=null;this.keys={};this.leafs=[];this.loaded=false;
this.maxDepth=0;this.mongodb="";this.observer=observable.factory();this.records=[];this.retrieve=false;this.source=null;this.total=0;this.versions={};this.versioning=true;this.views={};this.uri=null}DataStore.prototype=base.factory();DataStore.prototype.constructor=DataStore;DataStore.prototype.batch=function(type,data,sync){sync=sync===true;var self=this,events=this.events,defer=deferred.factory(),deferreds=[];if(!regex.set_del.test(type)||(sync&&regex.del.test(type)||typeof data!="object"))defer.reject(new Error(label.invalidArguments));
else{if(events)this.dispatch("beforeBatch",data);if(sync)this.clear(sync);if(data.length===0){this.loaded=true;if(events)this.dispatch("afterBatch",this.records);defer.resolve(this.records)}else{if(type==="del")array.each(data,function(i){deferreds.push(self.del(i,false,true))});else array.each(data,function(i){deferreds.push(self.set(null,i,true))});utility.when(deferreds).then(function(args){self.loaded=true;if(events)self.dispatch("afterBatch",args);array.each(self.lists,function(i){i.refresh(true)});
if(type==="del")self.reindex();if(self.autosave)self.save();defer.resolve(args)},function(e){if(events)self.dispatch("failedBatch",e);defer.reject(e)})}}return defer};DataStore.prototype.buildUri=function(key){var parsed=utility.parse(this.uri);return parsed.protocol+"//"+parsed.host+parsed.pathname+(regex.endslash.test(parsed.pathname)?"":"/")+key};DataStore.prototype.clear=function(sync){sync=sync===true;var events=this.events===true,resave=this.autosave===true;if(!sync){if(events)this.dispatch("beforeClear");
array.each(this.lists,function(i){i.teardown(true)});this.autosave=false;this.callback=null;this.collections=[];this.credentials=null;this.lists=[];this.depth=0;this.events=true;this.expires=null;this.headers={Accept:"application/json"};this.ignore=[];this.key=null;this.keys={};this.leafs=[];this.loaded=false;this.maxDepth=0;this.records=[];this.retrieve=false;this.source=null;this.total=0;this.versions={};this.versioning=true;this.views={};this.uri=null;if(events)this.dispatch("afterClear")}else{this.collections=
[];this.keys={};this.loaded=false;this.records=[];this.total=0;this.views={};array.each(this.lists,function(i){i.refresh()})}if(resave)this.save();return this};DataStore.prototype.crawl=function(arg){var self=this,events=this.events===true,record=arg instanceof Object?arg:this.get(arg),defer=deferred.factory(),deferreds=[],parsed=utility.parse(this.uri||""),clone;if(this.uri===null||record===undefined)defer.reject(new Error(label.invalidArguments));else{if(events)this.dispatch("beforeRetrieve",record);
if(record.data instanceof Array){clone=utility.clone(record.data);record.data={};array.each(clone,function(i){var key=i.replace(/.*\//,""),uri;record.data[key]=store.factory(null,{id:record.key+"-"+key,key:self.key,pointer:self.pointer,source:self.source,ignore:self.ignore.slice(),leafs:self.leafs.slice(),depth:self.depth+1,maxDepth:self.maxDepth,headers:self.headers,retrieve:true});if(i.indexOf("//")===-1)if(i.charAt(0)!=="/")uri=self.buildUri(i);else uri=parsed.protocol+"//"+parsed.host+i;else uri=
i;deferreds.push(record.data[key].data.setUri(uri))})}else utility.iterate(record.data,function(v,k){var uri;if(array.contains(self.ignore,k)||(array.contains(self.leafs,k)||(self.depth>=self.maxDepth||(!(v instanceof Array)&&typeof v!="string"||v.indexOf("//")===-1&&v.charAt(0)!=="/"))))return;array.add(self.collections,k);record.data[k]=store.factory(null,{id:record.key+"-"+k,key:self.key,source:self.source,ignore:self.ignore.slice(),leafs:self.leafs.slice(),depth:self.depth+1,maxDepth:self.maxDepth,
headers:self.headers,retrieve:true});if(!array.contains(self.leafs,k)&&(record.data[k].data.maxDepth===0||record.data[k].data.depth<=record.data[k].data.maxDepth))if(v instanceof Array)deferreds.push(record.data[k].data.batch("set",v));else{if(v.indexOf("//")===-1)if(v.charAt(0)!=="/")uri=self.buildUri(v);else uri=parsed.protocol+"//"+parsed.host+v;else uri=v;deferreds.push(record.data[k].data.setUri(uri))}});if(deferreds.length>0)utility.when(deferreds).then(function(){if(events)self.dispatch("afterRetrieve",
record);defer.resolve(record)},function(e){if(events)self.dispatch("failedRetrieve",record);defer.reject(e)});else{if(events)self.dispatch("afterRetrieve",record);defer.resolve(record)}}return defer};DataStore.prototype.del=function(record,reindex,batch){record=record.key?record:this.get(record);reindex=reindex!==false;batch=batch===true;var self=this,defer=deferred.factory();if(record===undefined)defer.reject(new Error(label.invalidArguments));else{if(this.events)self.dispatch("beforeDelete",record);
if(this.uri===null||this.callback!==null)this.delComplete(record,reindex,batch,defer);else client.request(this.buildUri(record.key),"DELETE",null,utility.merge({withCredentials:this.credentials},this.headers)).then(function(){self.delComplete(record,reindex,batch,defer)},function(e){self.dispatch("failedDelete",e);defer.reject(e)})}return defer};DataStore.prototype.delComplete=function(record,reindex,batch,defer){delete this.keys[record.key];delete this.versions[record.key];array.remove(this.records,
record.index);this.total--;this.views={};array.each(this.collections,function(i){record.data[i].teardown()});if(!batch){if(reindex)this.reindex();if(this.autosave)this.purge(record.key);if(this.events)this.dispatch("afterDelete",record);array.each(this.lists,function(i){i.refresh()})}return defer.resolve(record.key)};DataStore.prototype.dump=function(args,fields){args=args||this.records;var self=this,custom=fields instanceof Array&&fields.length>0,key=this.key!==null,fn;if(custom)fn=function(i){var record=
{};array.each(fields,function(f){record[f]=f===self.key?i.key:!array.contains(self.collections,f)?utility.clone(i.data[f],true):i.data[f].uri});return record};else fn=function(i){var record={};if(key)record[self.key]=i.key;utility.iterate(i.data,function(v,k){record[k]=!array.contains(self.collections,k)?utility.clone(v,true):v.data.uri});return record};return args.map(fn)};DataStore.prototype.get=function(record,offset){var records=this.records,type=typeof record,self=this,r;if(type==="undefined")r=
records;else if(type==="string")if(record.indexOf(",")===-1)r=records[self.keys[record]];else r=string.explode(record).map(function(i){if(!isNaN(i))return records[parseInt(i,10)];else return records[self.keys[i]]});else if(type==="number")if(isNaN(offset))r=records[parseInt(record,10)];else r=array.limit(records,parseInt(record,10),parseInt(offset,10));return r},DataStore.prototype.join=function(arg,field,join){join=join||"inner";var self=this,defer=deferred.factory(),results=[],deferreds=[],key=
field===this.key,keys=array.merge(array.cast(this.records[0].data,true),array.cast(arg.records[0].data,true)),fn;if(join==="inner")fn=function(i){var where={},record=utility.clone(i.data,true),defer=deferred.factory();where[field]=key?i.key:record[field];arg.select(where).then(function(match){if(match.length>2)defer.reject(new Error(label.databaseMoreThanOne));else if(match.length===1){results.push(utility.merge(record,match[0].data));defer.resolve(true)}else defer.resolve(false)});deferreds.push(defer)};
else if(join==="left")fn=function(i){var where={},record=utility.clone(i.data,true),defer=deferred.factory();where[field]=key?i.key:record[field];arg.select(where).then(function(match){if(match.length>2)defer.reject(new Error(label.databaseMoreThanOne));else if(match.length===1){results.push(utility.merge(record,match[0].data));defer.resolve(true)}else{array.each(keys,function(i){if(record[i]===undefined)record[i]=null});results.push(record);defer.resolve(true)}});deferreds.push(defer)};else if(join===
"right")fn=function(i){var where={},record=utility.clone(i.data,true),defer=deferred.factory();where[field]=key?i.key:record[field];self.select(where).then(function(match){if(match.length>2)defer.reject(new Error(label.databaseMoreThanOne));else if(match.length===1){results.push(utility.merge(record,match[0].data));defer.resolve(true)}else{array.each(keys,function(i){if(record[i]===undefined)record[i]=null});results.push(record);defer.resolve(true)}});deferreds.push(defer)};array.each(join==="right"?
arg.records:this.records,fn);utility.when(deferreds).then(function(){defer.resolve(results)},function(e){defer.reject(e)});return defer};DataStore.prototype.only=function(arg){if(arg===this.key)return this.records.map(function(i){return i.key});else return this.records.map(function(i){return i.data[arg]})};DataStore.prototype.purge=function(arg){return this.storage(arg||this,"remove")};DataStore.prototype.reindex=function(){var nth=this.total,i=-1;this.views={};if(nth>0)while(++i<nth){this.records[i].index=
i;this.keys[this.records[i].key]=i}return this};DataStore.prototype.restore=function(arg){return this.storage(arg||this,"get")};DataStore.prototype.save=function(arg){return this.storage(arg||this,"set")};DataStore.prototype.select=function(where){var defer=deferred.factory(),clauses,cond,functions,worker;if(!(where instanceof Object))defer.reject(new Error(label.invalidArguments));else if(webWorker){functions=[];utility.iterate(where,function(v,k){if(typeof v=="function"){this[k]=v.toString();functions.push(k)}});
try{worker=utility.worker(defer);worker.postMessage({cmd:"select",records:this.records,where:json.encode(where),functions:functions})}catch(e){webWorker=false;this.select(where).then(function(arg){defer.resolve(arg)},function(e){defer.reject(e)})}}else{clauses=array.fromObject(where);cond="return ( ";if(clauses.length>1)array.each(clauses,function(i,idx){var b1="( ";if(idx>0)b1=" && ( ";if(i[1]instanceof Function)cond+=b1+i[1].toString()+'( rec.data["'+i[0]+'"] ) )';else if(!isNaN(i[1]))cond+=b1+
'rec.data["'+i[0]+'"] === '+i[1]+" )";else cond+=b1+'rec.data["'+i[0]+'"] === "'+i[1]+'" )'});else if(clauses[0][1]instanceof Function)cond+=clauses[0][1].toString()+'( rec.data["'+clauses[0][0]+'"] )';else if(!isNaN(clauses[0][1]))cond+='rec.data["'+clauses[0][0]+'"] === '+clauses[0][1];else cond+='rec.data["'+clauses[0][0]+'"] === "'+clauses[0][1]+'"';cond+=" );";defer.resolve(this.records.slice().filter(new Function("rec",cond)))}return defer};DataStore.prototype.set=function(key,data,batch,overwrite){data=
utility.clone(data,true);batch=batch===true;overwrite=overwrite===true;var self=this,events=this.events,defer=deferred.factory(),record=key!==null?this.get(key)||null:data[this.key]?this.get(data[this.key])||null:null,method="POST",parsed=utility.parse(self.uri||""),uri;if(typeof data=="string"){if(data.indexOf("//")===-1)if(data.charAt(0)!=="/")uri=this.buildUri(data);else if(self.uri!==null&&regex.root.test(data))uri=parsed.protocol+"//"+parsed.host+data;else uri=data;else uri=data;key=uri.replace(regex.not_endpoint,
"");if(string.isEmpty(key))defer.reject(new Error(label.invalidArguments));else{if(!batch&&events)self.dispatch("beforeSet",{key:key,data:data});client.request(uri,"GET",null,utility.merge({withCredentials:self.credentials},self.headers)).then(function(arg){self.setComplete(record,key,self.source?utility.walk(arg,self.source):arg,batch,overwrite,defer)},function(e){self.dispatch("failedSet",e);defer.reject(e)})}}else{if(!batch&&events)self.dispatch("beforeSet",{key:key,data:data});if(batch||this.uri===
null)this.setComplete(record,key,data,batch,overwrite,defer);else{if(key!==null){method="PUT";uri=this.buildUri(key);if(client.allows(uri,"patch"))method="PATCH";else if(record!==null&&!overwrite)utility.iterate(record.data,function(v,k){if(!array.contains(self.collections,k)&&!data[k])data[k]=v})}else uri=this.uri;client.request(uri,method,data,utility.merge({withCredentials:this.credentials},this.headers)).then(function(arg){self.setComplete(record,key,self.source?utility.walk(arg,self.source):
arg,batch,overwrite,defer)},function(e){self.dispatch("failedSet",e);defer.reject(e)})}}return defer};DataStore.prototype.setComplete=function(record,key,data,batch,overwrite,defer){var self=this,deferreds=[];this.views={};if(!key)if(this.key!==null&&data[this.key])key=data[this.key].toString();else key=utility.uuid();if(this.key)delete data[this.key];if(record===null){record={index:this.total++,key:key,data:data};this.keys[key]=record.index;this.records[record.index]=record;if(this.versioning){this.versions[record.key]=
lru.factory(VERSIONS);this.versions[record.key].nth=0}if(this.retrieve)deferreds.push(this.crawl(record))}else{if(this.versioning){if(this.versions[record.key]===undefined){this.versions[record.key]=lru.factory(VERSIONS);this.versions[record.key].nth=0}this.versions[record.key].set("v"+ ++this.versions[record.key].nth,this.dump([record])[0])}if(overwrite){array.each(this.collections,function(i){if(record.data[i]&&typeof record.data[i].teardown=="function")record.data[i].teardown()});record.data={}}utility.iterate(data,
function(v,k){if(!array.contains(self.collections,k))record.data[k]=v;else if(typeof v=="string")deferreds.push(record.data[k].setUri(record.data[k].uri+"/"+v,true));else deferreds.push(record.data[k].batch("set",v,true))})}if(!batch){if(this.autosave)this.save(record);if(this.events)this.dispatch("afterSet",record);array.each(this.lists,function(i){i.refresh()})}if(deferreds.length===0)defer.resolve(record);else utility.when(deferreds).then(function(){defer.resolve(record)});return this};DataStore.prototype.setExpires=
function(arg){if(arg!==null&&this.uri===null||arg!==null&&(isNaN(arg)||arg<1E3))throw new Error(label.invalidArguments);if(this.expires===arg)return;this.expires=arg;var id=this.id+"Expire",expires=arg,self=this;utility.clearTimers(id);if(arg===null)return;utility.repeat(function(){if(self.uri===null){self.setExpires(null);return false}self.dispatch("beforeExpire");cache.expire(self.uri);self.dispatch("expire");self.dispatch("afterExpire")},expires,id,false)};DataStore.prototype.setUri=function(arg){var defer=
deferred.factory(),parsed;if(arg!==null&&string.isEmpty(arg))defer.reject(new Error(label.invalidArguments));if(arg===null)this.uri=arg;else{parsed=utility.parse(arg);this.uri=parsed.protocol+"//"+parsed.host+parsed.path;if(!string.isEmpty(parsed.auth)&&(!this.headers.authorization&&!this.headers.Authorization))this.headers.Authorization="Basic "+btoa(decodeURIComponent(parsed.auth));this.on("expire",function(){this.sync()},"resync",this);cache.expire(this.uri);this.sync().then(function(arg){defer.resolve(arg)},
function(e){defer.reject(e)})}return defer};DataStore.prototype.sort=function(query,create,where){create=create===true||where instanceof Object;var self=this,view=string.toCamelCase(string.explode(query).join(" ")),defer=deferred.factory(),next,worker;next=function(records){if(self.total===0)defer.resolve([]);else if(!create&&self.views[view])defer.resolve(self.views[view]);else if(webWorker){defer.then(function(arg){self.views[view]=arg;return self.views[view]},function(e){throw e;});try{worker=
utility.worker(defer);worker.postMessage({cmd:"sort",records:records,query:query})}catch(e){webWorker=false;self.views[view]=array.keySort(records.slice(),query,"data");defer.resolve(self.views[view])}}else{self.views[view]=array.keySort(records.slice(),query,"data");defer.resolve(self.views[view])}};if(!where)next(this.records);else this.select(where).then(next);return defer};DataStore.prototype.storage=function(obj,op,type){var self=this,record=false,mongo=!string.isEmpty(this.mongodb),session=
type==="session"&&typeof sessionStorage!="undefined",defer=deferred.factory(),data,key,result;if(!regex.number_string_object.test(typeof obj)||!regex.get_remove_set.test(op))defer.reject(new Error(label.invalidArguments));else{record=regex.number_string.test(typeof obj)||obj.hasOwnProperty("data");if(op!=="remove"){if(record&&!(obj instanceof Object))obj=this.get(obj);key=record?obj.key:obj.id}else if(op==="remove"&&record)key=obj.key||obj;if(mongo)mongodb.connect(this.mongodb,function(e,db){if(e){if(db)db.close();
return defer.reject(e)}db.collection(self.id,function(e,collection){if(e){db.close();return defer.reject(e)}if(op==="get")if(record)collection.find({_id:obj.key}).limit(1).toArray(function(e,recs){db.close();if(e)defer.reject(e);else if(recs.length===0)defer.resolve(null);else{delete recs[0]._id;self.set(key,recs[0],true).then(function(rec){defer.resolve(rec)},function(e){defer.reject(e)})}});else collection.find({}).toArray(function(e,recs){var i,nth;if(e){db.close();return defer.reject(e)}i=-1;
nth=recs.length;if(nth>0){self.records=recs.map(function(r){var rec={key:r._id,index:++i,data:{}};self.keys[rec.key]=rec.index;rec.data=r;delete rec.data._id;return rec});self.total=nth}db.close();defer.resolve(self.records)});else if(op==="remove")collection.remove(record?{_id:key}:{},{safe:true},function(e,arg){db.close();if(e)defer.reject(e);else defer.resolve(arg)});else if(op==="set")if(record)collection.update({_id:obj.key},obj.data,{w:1,safe:true,upsert:true},function(e,arg){db.close();if(e)defer.reject(e);
else defer.resolve(arg)});else collection.remove({},{w:1,safe:true},function(e){var deferreds;if(e){db.close();return defer.reject(e)}else{deferreds=[];array.each(self.records,function(i){var data={},defer2=deferred.factory();deferreds.push(defer2);utility.iterate(i.data,function(v,k){if(!array.contains(self.collections,k))data[k]=v});collection.update({_id:i.key},data,{w:1,safe:true,upsert:true},function(e,arg){if(e)defer2.reject(e);else defer2.resolve(arg)})});utility.when(deferreds).then(function(result){db.close();
defer.resolve(result)},function(e){db.close();defer.reject(e)})}});else{db.close();defer.reject(null)}})});else if(op==="get"){result=session?sessionStorage.getItem(key):localStorage.getItem(key);if(result!==null){result=json.decode(result);if(record)self.set(key,result,true).then(function(rec){defer.resolve(rec)},function(e){defer.reject(e)});else{utility.merge(self,result);defer.resolve(self)}}else defer.resolve(self)}else if(op==="remove"){session?sessionStorage.removeItem(key):localStorage.removeItem(key);
defer.resolve(this)}else if(op==="set"){data=json.encode(record?obj.data:{total:this.total,keys:this.keys,records:this.records});session?sessionStorage.setItem(key,data):localStorage.setItem(key,data);defer.resolve(this)}else defer.reject(null)}return defer};DataStore.prototype.sync=function(){var self=this,events=this.events===true,defer=deferred.factory(),success,failure;success=function(arg){var data;if(typeof arg!="object")return failure(new Error(label.expectedObject));if(self.source!==null)arg=
utility.walk(arg,self.source);if(arg instanceof Array)data=arg;else data=[arg];self.batch("set",data,true).then(function(arg){if(events)self.dispatch("afterSync",arg);defer.resolve(arg)},failure)};failure=function(e){if(events)self.dispatch("failedSync",e);defer.reject(e)};if(this.uri===null||string.isEmpty(this.uri))defer.reject(new Error(label.invalidArguments));else{if(events)this.dispatch("beforeSync",this.uri);if(this.callback!==null)client.jsonp(this.uri,{callback:this.callback}).then(success,
failure);else client.request(this.uri,"GET",null,utility.merge({withCredentials:this.credentials},this.headers)).then(success,failure)}return defer};DataStore.prototype.teardown=function(){var uri=this.uri,id;if(uri!==null){cache.expire(uri,true);id=this.id+"DataExpire";utility.clearTimers(id);array.each(this.records,function(i){var recordUri=uri+"/"+i.key;cache.expire(recordUri,true);utility.iterate(i.data,function(v){if(v===null)return;if(v&&typeof v.teardown=="function")v.teardown()})})}array.each(this.lists,
function(i){i.teardown()});this.clear(true);this.dispatch("afterTeardown");return this};DataStore.prototype.undo=function(key,version){var record=this.get(key),defer=deferred.factory(),versions=this.versions[record.key],previous;if(record===undefined)defer.reject(new Error(label.invalidArguments));else if(versions){previous=versions.get(version||versions.first);if(previous===undefined)defer.reject(label.datastoreNoPrevVersion);else this.set(key,previous).then(function(arg){defer.resolve(arg)},function(e){defer.reject(e)})}else defer.reject(label.datastoreNoPrevVersion);
return defer};DataStore.prototype.unique=function(key){return array.unique(this.records.map(function(i){return i.data[key]}))};DataStore.prototype.update=function(key,data){var record=this.get(key),defer=deferred.factory();if(record===undefined)defer.reject(new Error(label.invalidArguments));else this.set(key,utility.merge(record.data,data)).then(function(arg){defer.resolve(arg)},function(e){defer.reject(e)});return defer};var string={capitalize:function(obj,all){all=all===true;var result;if(all)result=
string.explode(obj," ").map(function(i){return i.charAt(0).toUpperCase()+i.slice(1)}).join(" ");else result=obj.charAt(0).toUpperCase()+obj.slice(1);return result},escape:function(obj){return obj.replace(/[\-\[\]{}()*+?.,\\\/\^\$|#\s]/g,"\\$&")},explode:function(obj,arg){arg=arg||",";return string.trim(obj).split(new RegExp("\\s*"+arg+"\\s*"))},fromObject:function(obj,name){var result=(name?name+" = {":"{")+"\n";utility.iterate(obj,function(v,k){result+='"'+k+'":'+v.toString()+",\n"});result=result.replace(/\[object Object\]/g,
"{}").replace(/,\n$/,"\n")+"}";return result},hyphenate:function(obj,camel){var result=string.trim(obj).replace(/\s+/g,"-");if(camel===true)result=result.replace(/([A-Z])/g,"-$1").toLowerCase();return result},isBoolean:function(obj){return regex.bool.test(obj)},isEmpty:function(obj){return string.trim(obj)===""},isNumber:function(obj){return regex.number.test(obj)},isUrl:function(obj){return regex.url.test(obj)},toCamelCase:function(obj){var s=string.trim(obj).replace(/\.|_|-|\@|\[|\]|\(|\)|\#|\$|\%|\^|\&|\*|\s+/g,
" ").toLowerCase().split(regex.space_hyphen),r=[];array.each(s,function(i,idx){r.push(idx===0?i:string.capitalize(i))});return r.join("")},singular:function(obj){return obj.replace(/oe?s$/,"o").replace(/ies$/,"y").replace(/ses$/,"se").replace(/s$/,"")},toFunction:function(obj){var args=string.trim(obj.replace(/^.*\(/,"").replace(/[\t|\r|\n|\"|\']+/g,"").replace(/\).*/,"")),body=string.trim(obj.replace(/^.*\{/,"").replace(/\}$/,""));return Function.apply(Function,string.explode(args).concat([body]))},
trim:function(obj){return obj.replace(/^(\s+|\t+|\n+)|(\s+|\t+|\n+)$/g,"")},unCamelCase:function(obj){return string.trim(obj.replace(/([A-Z])/g," $1").toLowerCase())},uncapitalize:function(obj){obj=string.trim(obj);return obj.charAt(0).toLowerCase()+obj.slice(1)},unhyphenate:function(obj,caps){if(caps!==true)return string.explode(obj,"-").join(" ");else return string.explode(obj,"-").map(function(i){return string.capitalize(i)}).join(" ")}};var utility={timer:{},repeating:{},$:function(arg){var result;
if(!arg);else if(regex.html.test(arg))result=[element.create(arg)];else{arg=string.trim(arg);if(arg.indexOf(",")===-1){result=utility.dom(arg);if(result){if(isNaN(result.length))result=[result]}else result=[]}else{result=[];array.each(string.explode(arg),function(query){var obj=utility.dom(query);if(obj instanceof Array)result=result.concat(obj);else if(obj)result.push(obj)})}}return result},base:function(arg){var obj=new Base;if(arg instanceof Object)utility.merge(obj,arg);obj.observer=observable.factory();
return obj},blob:function(arg){var obj;try{obj=new Blob([arg],{type:"application/javascript"})}catch(e){if(!global.BlobBuilder)global.BlobBuilder=global.MSBlobBuilder||(global.WebKitBlobBuilder||global.MozBlobBuilder);obj=(new global.BlobBuilder).append(arg).getBlob()}return obj},clearTimers:function(id){if(id===undefined||string.isEmpty(id))throw new Error(label.invalidArguments);if(utility.timer[id]){clearTimeout(utility.timer[id]);delete utility.timer[id]}if(utility.repeating[id]){clearTimeout(utility.repeating[id]);
delete utility.repeating[id]}},clone:function(obj,shallow){var clone;if(shallow===true)return json.decode(json.encode(obj));else if(!obj||(regex.primitive.test(typeof obj)||obj instanceof RegExp))return obj;else if(obj instanceof Array)return obj.slice();else if(!server&&(!client.ie&&obj instanceof Document))return xml.decode(xml.encode(obj));else if(typeof obj.__proto__!="undefined")return utility.extend(obj.__proto__,obj);else if(obj instanceof Object){clone=json.encode(obj,true);if(clone!==undefined){clone=
json.decode(clone);utility.iterate(obj,function(v,k){if(typeof v=="function")clone[k]=v})}else clone=obj;return clone}else return obj},coerce:function(value){var tmp;if(value===null||value===undefined)return undefined;else if(value==="true")return true;else if(value==="false")return false;else if(value==="null")return null;else if(value==="undefined")return undefined;else if(value==="")return value;else if(!isNaN(tmp=Number(value)))return tmp;else if(regex.json_wrap.test(value))return json.decode(value,
true)||value;else return value},compile:function(reg,pattern,modifiers){reg.compile(pattern,modifiers);return true},curry:function(){var args=array.cast(arguments),fn=args.shift(),cfn=fn.apply(fn,args);return function(){return cfn.apply(cfn,arguments)}},defer:function(fn,ms,id,repeat){var op;ms=ms||0;repeat=repeat===true;if(id!==undefined)utility.clearTimers(id);else id=utility.uuid(true);op=function(){utility.clearTimers(id);fn()};utility[repeat?"repeating":"timer"][id]=setTimeout(op,ms);return id},
delay:function(){if(typeof setImmediate!="undefined")return function(arg){setImmediate(arg)};else if(typeof process!="undefined")return process.nextTick;else return function(arg){setTimeout(arg,0)}}(),dom:function(arg){var result;if(!regex.selector_complex.test(arg))if(regex.hash.test(arg))result=document.getElementById(arg.replace(regex.hash,""))||undefined;else if(regex.klass.test(arg))result=array.cast(document.getElementsByClassName(arg.replace(regex.klass,"")));else if(regex.word.test(arg))result=
array.cast(document.getElementsByTagName(arg));else result=array.cast(document.querySelectorAll(arg));else result=array.cast(document.querySelectorAll(arg));return result},domId:function(arg){return"a"+arg.replace(/-/g,"").slice(1)},error:function(e,args,scope,warning){var o={"arguments":args?array.cast(args):[],message:e.message||e,number:e.number?e.number&65535:undefined,scope:scope,stack:e.stack||undefined,timestamp:(new Date).toUTCString(),type:e.type||"TypeError"};utility.log(o.stack||o.message,
warning!==true?"error":"warn");return undefined},extend:function(obj,arg){var o;if(obj===undefined)throw new Error(label.invalidArguments);o=Object.create(obj);if(arg instanceof Object)utility.merge(o,arg);return o},genId:function(obj,dom){dom=dom===true;var id;if(obj&&(obj.id||(obj instanceof Array||(typeof obj=="string"||obj instanceof String))))return obj;if(dom){do id=utility.domId(utility.uuid(true));while(utility.dom("#"+id))}else id=utility.domId(utility.uuid(true));if(typeof obj=="object"){obj.id=
id;return obj}else return id},iterate:function(obj,fn){if(typeof fn!="function")throw new Error(label.invalidArguments);array.each(Object.keys(obj),function(i){return fn.call(obj,obj[i],i)});return obj},log:function(arg,target){var ts,msg;if(typeof console!="undefined"){ts=typeof arg!="object";msg=ts?"["+(new Date).toLocaleTimeString()+"] "+arg:arg;console[target||"log"](msg)}},merge:function(obj,arg){utility.iterate(arg,function(v,k){if(obj[k]instanceof Array&&v instanceof Array)array.merge(obj[k],
v);else if(obj[k]instanceof Object&&v instanceof Object)utility.iterate(v,function(x,y){obj[k][y]=utility.clone(x)});else obj[k]=utility.clone(v)});return obj},parse:function(uri){var obj={},parsed={};if(uri===undefined)uri=!server?location.href:"";if(!server){obj=document.createElement("a");obj.href=uri}else obj=url.parse(uri);if(server)utility.iterate(obj,function(v,k){if(v===null)obj[k]=undefined});parsed={auth:server?null:regex.auth.exec(uri),protocol:obj.protocol||"http:",hostname:obj.hostname||
"localhost",port:obj.port?number.parse(obj.port,10):"",pathname:obj.pathname,search:obj.search||"",hash:obj.hash||"",host:obj.host||"localhost"};if(client.ie){if(parsed.protocol===":")parsed.protocol=location.protocol;if(string.isEmpty(parsed.hostname))parsed.hostname=location.hostname;if(string.isEmpty(parsed.host))parsed.host=location.host;if(parsed.pathname.charAt(0)!=="/")parsed.pathname="/"+parsed.pathname}parsed.auth=obj.auth||(parsed.auth===null?"":parsed.auth[1]);parsed.href=obj.href||parsed.protocol+
"//"+(string.isEmpty(parsed.auth)?"":parsed.auth+"@")+parsed.host+parsed.pathname+parsed.search+parsed.hash;parsed.path=obj.path||parsed.pathname+parsed.search;parsed.query=utility.queryString(null,parsed.search);return parsed},partial:function(){var args=array.cast(arguments),fn=args.shift();return function(){return fn.apply(fn,args.concat(array.cast(arguments)))}},prevent:function(ev){if(typeof ev.preventDefault=="function")ev.preventDefault();return ev},queryString:function(arg,qstring){var obj=
{},result=qstring!==undefined?qstring.indexOf("?")>-1?qstring.replace(/.*\?/,""):null:server||string.isEmpty(location.search)?null:location.search.replace("?","");if(result!==null&&!string.isEmpty(result)){result=result.split("&");array.each(result,function(prop){var item=prop.split("=");if(string.isEmpty(item[0]))return;if(item[1]===undefined)item[1]="";else item[1]=utility.coerce(decodeURIComponent(item[1]));if(obj[item[0]]===undefined)obj[item[0]]=item[1];else if(!(obj[item[0]]instanceof Array)){obj[item[0]]=
[obj[item[0]]];obj[item[0]].push(item[1])}else obj[item[0]].push(item[1])})}if(arg!==null&&arg!==undefined)obj=obj[arg];return obj},race:function(){var defer=deferred.factory(),args=array.cast(arguments);if(args[0]instanceof Array)args=args[0];if(args.length===0)defer.resolve(null);else Promise.race(args).then(function(results){defer.resolve(results)},function(e){defer.reject(e)});return defer},render:function(fn){var defer=deferred.factory();RENDER(function(arg){try{defer.resolve(fn(arg))}catch(e){defer.reject(e)}});
return defer},repeat:function(fn,ms,id,now){ms=ms||10;id=id||utility.uuid(true);now=now!==false;if(now&&fn()===false)return;utility.defer(function(){var recursive=function(fn,ms,id){var recursive=this;if(fn()!==false)utility.repeating[id]=setTimeout(function(){recursive.call(recursive,fn,ms,id)},ms);else delete utility.repeating[id]};recursive.call(recursive,fn,ms,id)},ms,id,true);return id},stop:function(ev){if(typeof ev.stopPropagation=="function")ev.stopPropagation();utility.prevent(ev);return ev},
target:function(ev){return ev.target||ev.srcElement},uuid:function(strip){var s=function(){return((1+Math.random())*65536|0).toString(16).substring(1)},r=[8,9,"a","b"],o;o=s()+s()+"-"+s()+"-4"+s().substr(0,3)+"-"+r[Math.floor(Math.random()*4)]+s().substr(0,3)+"-"+s()+s()+s();if(strip===true)o=o.replace(/-/g,"");return o},walk:function(obj,arg){var output=obj;array.each(arg.replace(/\]$/,"").replace(/\]/g,".").replace(/\.\./g,".").split(/\.|\[/),function(i){if(output[i]===undefined||output[i]===null){output=
undefined;return false}output=output[i]});return output},when:function(){var defer=deferred.factory(),args=array.cast(arguments);if(args[0]instanceof Array)args=args[0];if(args.length===0)defer.resolve(null);else Promise.all(args).then(function(results){defer.resolve(results)},function(e){defer.reject(e)});return defer},worker:function(defer){var obj=new Worker(WORKER);obj.onerror=function(err){defer.reject(err);obj.terminate()};obj.onmessage=function(ev){defer.resolve(ev.data);obj.terminate()};return obj}};
function xhr(){var UNSENT=0,OPENED=1,HEADERS_RECEIVED=2,LOADING=3,DONE=4,ERR_REFUSED=/ECONNREFUSED/,ready=new RegExp(HEADERS_RECEIVED+"|"+LOADING),XMLHttpRequest,headers,dispatch,success,failure,state;headers={"user-agent":"keigai/0.7.3 node.js/"+process.versions.node.replace(/^v/,"")+" ("+string.capitalize(process.platform)+" V8/"+process.versions.v8+" )","content-type":"text/plain","accept":"*/*"};dispatch=function(arg){var fn="on"+arg;if(typeof this[fn]=="function")this[fn]();this.dispatchEvent(arg);
return this};state=function(arg){if(this.readyState!==arg){this.readyState=arg;dispatch.call(this,"readystatechange");if(this.readyState===DONE&&!this._error){dispatch.call(this,"load");dispatch.call(this,"loadend")}}return this};success=function(res){var self=this;state.call(this,HEADERS_RECEIVED);this.status=res.statusCode;this._resheaders=res.headers;if(this._resheaders["set-cookie"]&&this._resheaders["set-cookie"]instanceof Array)this._resheaders["set-cookie"]=this._resheaders["set-cookie"].join(";");
res.on("data",function(arg){res.setEncoding("utf8");if(self._send){if(arg)self.responseText+=arg;state.call(self,LOADING)}});res.on("end",function(){if(self._send){state.call(self,DONE);self._send=false}})};failure=function(e){this.status=ERR_REFUSED.test(e.message)?503:500;this.statusText="";this.responseText=e.message;this._error=true;this._send=false;dispatch.call(this,"error");state.call(this,DONE)};XMLHttpRequest=function(){this.onabort=null;this.onerror=null;this.onload=null;this.onloadend=
null;this.onloadstart=null;this.onreadystatechange=null;this.readyState=UNSENT;this.response=null;this.responseText="";this.responseType="";this.responseXML=null;this.status=UNSENT;this.statusText="";this.observer=observable.factory();this._error=false;this._headers={};this._params={};this._request=null;this._resheaders={};this._send=false};XMLHttpRequest.prototype=base.factory();XMLHttpRequest.prototype.constructor=XMLHttpRequest;XMLHttpRequest.prototype.abort=function(){if(this._request!==null){this._request.abort();
this._request=null;this.responseText="";this.responseXML="";this._error=true;this._headers={};if(this._send===true||ready.test(this.readyState)){this._send=false;state.call(this,DONE)}dispatch.call(this,"abort");this.readyState=UNSENT}return this};XMLHttpRequest.prototype.getAllResponseHeaders=function(){var result="";if(this.readyState<HEADERS_RECEIVED)throw new Error(label.invalidStateNoHeaders);utility.iterate(this._resheaders,function(v,k){result+=k+": "+v+"\n"});return result};XMLHttpRequest.prototype.getResponseHeader=
function(header){var result;if(this.readyState<HEADERS_RECEIVED||this._error)throw new Error(label.invalidStateNoHeaders);result=this._resheaders[header]||this._resheaders[header.toLowerCase()];return result};XMLHttpRequest.prototype.open=function(method,url,async,user,password){var self=this;if(async!==true)throw new Error(label.invalidStateNoSync);this.abort();this._error=false;this._params={method:method,url:url,async:async||true,user:user||null,password:password||null};utility.iterate(headers,
function(v,k){self._headers[k]=v});this.readyState=OPENED;return this};XMLHttpRequest.prototype.overrideMimeType=function(mime){this._headers["content-type"]=mime;return this};XMLHttpRequest.prototype.send=function(data){data=data||null;var self=this,options,parsed,request,obj;if(this.readyState<OPENED)throw new Error(label.invalidStateNotOpen);else if(this._send)throw new Error(label.invalidStateNotSending);parsed=utility.parse(this._params.url);parsed.port=parsed.port||(parsed.protocol==="https:"?
443:80);if(this._params.user!==null&&this._params.password!==null)parsed.auth=this._params.user+":"+this._params.password;if(regex.put_post.test(this._params.method))if(data===null)this._headers["content-length"]=0;else if(typeof data=="string")this._headers["content-length"]=Buffer.byteLength(data);else if(data instanceof Buffer||typeof data.toString=="function"){data=data.toString();this._headers["content-length"]=Buffer.byteLength(data)}else throw new Error(label.invalidArguments);this._headers.host=
parsed.host;if(this._headers["x-requested-with"]==="XMLHttpRequest")delete this._headers["x-requested-with"];options={hostname:parsed.hostname,path:parsed.path,port:parsed.port,method:this._params.method,headers:this._headers};if(parsed.protocol==="https:"){options.rejectUnauthorized=false;options.agent=false}if(parsed.auth)options.auth=parsed.auth;this._send=true;dispatch.call(this,"readystatechange");obj=parsed.protocol==="http:"?http:https;request=obj.request(options,function(arg){success.call(self,
arg)}).on("error",function(e){failure.call(self,e)});data===null?request.setSocketKeepAlive(true):request.write(data,"utf8");this._request=request;request.end();dispatch.call(this,"loadstart");return this};XMLHttpRequest.prototype.setRequestHeader=function(header,value){if(this.readyState!==OPENED)throw new Error(label.invalidStateNotUsable);else if(this._send)throw new Error(label.invalidStateNotSending);this._headers[header.toLowerCase()]=value;return this};return XMLHttpRequest}var xml={decode:function(arg){if(typeof arg!=
"string"||string.isEmpty(arg))throw new Error(label.invalidArguments);return(new DOMParser).parseFromString(arg,"text/xml")},encode:function(arg,wrap){try{if(arg===undefined)throw new Error(label.invalidArguments);wrap=wrap!==false;var x=wrap?"<xml>":"",top=arguments[2]!==false,node;node=function(name,value){var output="<n>v</n>";output=output.replace("v",regex.cdata.test(value)?"<![CDATA["+value+"]]\x3e":value);return output.replace(/<(\/)?n>/g,"<$1"+name+">")};if(arg!==null&&arg.xml)arg=arg.xml;
if(arg instanceof Document)arg=(new XMLSerializer).serializeToString(arg);if(regex.boolean_number_string.test(typeof arg))x+=node("item",arg);else if(typeof arg=="object")utility.iterate(arg,function(v,k){x+=xml.encode(v,typeof v=="object",false).replace(/item|xml/g,isNaN(k)?k:"item")});x+=wrap?"</xml>":"";if(top)x='<?xml version="1.0" encoding="UTF8"?>'+x;return x}catch(e){utility.error(e,arguments,this);return undefined}},valid:function(arg){return xml.decode(arg).getElementsByTagName("parsererror").length===
0}};function bootstrap(){function init(){TIME=(new Date).getTime();utility.repeat(function(){cache.clean()},6E4,"cacheGarbageCollector")}function fn(){if(regex.complete_loaded.test(document.readyState)){init();return false}}if(!server){client.version=client.version();if(client.ie&&client.version<9)throw new Error(label.upgrade);if(Element.prototype.getElementsByClassName===undefined)Element.prototype.getElementsByClassName=function(arg){return document.querySelectorAll("."+arg)};if(!document.documentElement.classList)(function(view){var ClassList,
getter,proto,target,descriptor;if(!("HTMLElement"in view)&&!("Element"in view))return;ClassList=function(obj){var classes=string.explode(obj.className," "),self=this;array.each(classes,function(i){self.push(i)});this.updateClassName=function(){obj.className=this.join(" ")}};getter=function(){return new ClassList(this)};proto=ClassList.prototype=[];target=(view.HTMLElement||view.Element).prototype;proto.add=function(arg){if(!array.contains(this,arg)){this.push(arg);this.updateClassName()}};proto.contains=
function(arg){return array.contains(this,arg)};proto.remove=function(arg){if(array.contains(this,arg)){array.remove(this,arg);this.updateClassName()}};proto.toggle=function(arg){array[array.contains(this,arg)?"remove":"add"](this,arg);this.updateClassName()};if(Object.defineProperty){descriptor={get:getter,enumerable:true,configurable:true};Object.defineProperty(target,"classList",descriptor)}else if(Object.prototype.__defineGetter__)target.__defineGetter__("classList",getter);else throw new Error("Could not create classList shim");
})(global)}else XMLHttpRequest=xhr();has=Object.prototype.hasOwnProperty;slice=Array.prototype.slice;if(webWorker)WORKER=global.URL.createObjectURL(utility.blob("var "+string.fromObject(array,"array")+", "+string.fromObject(regex,"regex")+", "+string.fromObject(string,"string")+", "+string.fromObject(utility,"utility")+"; onmessage = "+store.worker.toString()+";"));RENDER=global.requestAnimationFrame||function(fn){var offset=(new Date).getTime()-TIME;utility.defer(function(){fn(offset)},16,offset)};
if(typeof exports!="undefined"||(typeof define=="function"||regex.complete_loaded.test(document.readyState)))init();else if(typeof document.addEventListener=="function")document.addEventListener("DOMContentLoaded",function(){init()},false);else if(typeof document.attachEvent=="function")document.attachEvent("onreadystatechange",fn);else utility.repeat(fn)}bootstrap();return{filter:filter.factory,list:list.factory,grid:grid.factory,store:store.factory,util:{$:utility.$,array:array,base:utility.base,
clone:utility.clone,coerce:utility.coerce,curry:utility.curry,csv:csv,defer:deferred.factory,element:element,extend:utility.extend,iterate:utility.iterate,json:json,jsonp:client.jsonp,log:utility.log,lru:lru.factory,math:math,merge:utility.merge,number:number,observer:observable.factory,parse:utility.parse,partial:utility.partial,prevent:utility.prevent,race:utility.race,render:utility.render,repeat:utility.repeat,request:client.request,stop:utility.stop,string:string,target:utility.target,uuid:utility.uuid,
walk:utility.walk,when:utility.when},version:"0.7.3"}}();if(typeof exports!="undefined")module.exports=lib;else if(typeof define=="function")define(function(){return lib});else global.keigai=lib})(this);
//# sourceMappingURL=keigai.map
