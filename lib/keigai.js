"use strict";var _inherits=function(subClass, superClass){if(typeof superClass !== "function" && superClass !== null){throw new TypeError("Super expression must either be null or a function, not " + typeof superClass);}subClass.prototype = Object.create(superClass && superClass.prototype, {constructor:{value:subClass, enumerable:false, writable:true, configurable:true}});if(superClass)subClass.__proto__ = superClass;};var _createClass=(function(){function defineProperties(target, props){for(var key in props) {var prop=props[key];prop.configurable = true;if(prop.value)prop.writable = true;}Object.defineProperties(target, props);}return function(Constructor, protoProps, staticProps){if(protoProps)defineProperties(Constructor.prototype, protoProps);if(staticProps)defineProperties(Constructor, staticProps);return Constructor;};})();var _classCallCheck=function(instance, Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}};(function(global){var document=global.document;var location=global.location;var navigator=global.navigator;var server=typeof process != "undefined";var MAX=10;var VERSIONS=100;var CACHE=500;var EVENTS=["readystatechange", "abort", "load", "loadstart", "loadend", "error", "progress", "timeout"];var Buffer=function(){};var Promise=global.Promise || undefined;var localStorage=global.localStorage || undefined;var XMLHttpRequest=global.XMLHttpRequest || null;var WeakMap=global.WeakMap || null;var btoa=global.btoa || undefined;var webWorker=typeof Blob != "undefined" && typeof Worker != "undefined";var external=undefined, format=undefined, http=undefined, https=undefined, mongodb=undefined, url=undefined, RENDER=undefined, TIME=undefined, WORKER=undefined;if(server){url = require("url");http = require("http");https = require("https");mongodb = require("mongodb").MongoClient;format = require("util").format;Buffer = require("buffer").Buffer;if(typeof Promise === "undefined"){Promise = require("es6-promise").Promise;}if(typeof localStorage === "undefined"){localStorage = require("localStorage");}if(typeof btoa === "undefined"){btoa = require("btoa");}}var lib=(function(){var regex={after_space:/\s+.*/, allow:/^allow$/i, allow_cors:/^access-control-allow-methods$/i, and:/^&/, args:/\((.*)\)/, auth:/\/\/(.*)\@/, bool:/^(true|false)?$/, caps:/[A-Z]/, cdata:/\&|<|>|\"|\'|\t|\r|\n|\@|\$/, checked_disabled:/checked|disabled/i, complete_loaded:/^(complete|loaded)$/i, csv_quote:/^\s|\"|\n|,|\s$/, del:/^del/, domain:/^[\w.-_]+\.[A-Za-z]{2,}$/, down:/down/, endslash:/\/$/, eol_nl:/\n$/, element_update:/id|innerHTML|innerText|textContent|type|src/, get_headers:/^(head|get|options)$/, get_remove_set:/get|remove|set/, hash:/^\#/, header_replace:/:.*/, header_value_replace:/.*:\s+/, html:/^<.*>$/, http_body:/200|201|202|203|206/, http_ports:/80|443/, host:/\/\/(.*)\//, ie:/msie|ie|\.net|windows\snt/i, ip:/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/, is_xml:/^<\?xml.*\?>/, json_maybe:/json|plain|javascript/, json_wrap:/^[\[\{]/, klass:/^\./, no:/no-store|no-cache/i, not_dotnotation:/-|\s/, not_endpoint:/.*\//, null_undefined:/null|undefined/, number:/(^-?\d\d*\.\d*$)|(^-?\d\d*$)|(^-?\.\d\d*$)|number/, number_format_1:/.*\./, number_format_2:/\..*/, number_present:/\d{1,}/, number_string:/number|string/i, number_string_object:/number|object|string/i, object_type:/\[object Object\]/, patch:/^patch$/, primitive:/^(boolean|function|number|string)$/, priv:/private/, protocol:/^(.*)\/\//, put_post:/^(post|put)$/i, radio_checkbox:/^(radio|checkbox)$/i, root:/^\/[^\/]/, select:/select/i, selector_is:/^:/, selector_complex:/\s+|\>|\+|\~|\:|\[/, set_del:/^(set|del|delete)$/, space_hyphen:/\s|-/, string_object:/string|object/i, svg:/svg/, top_bottom:/top|bottom/i, url:/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]+-?)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/i, word:/^\w+$/, xdomainrequest:/^(get|post)$/i, xml:/xml/i};var LRU=(function(){function LRU(){var max=arguments[0] === undefined?1000:arguments[0];_classCallCheck(this, LRU);this.cache = {};this.max = max;this.first = null;this.last = null;this.length = 0;}_createClass(LRU, {evict:{value:function evict(){if(this.last !== null){this.remove(this.last);}return this;}}, get:{value:function get(key){var item=this.cache[key];if(item === undefined){return;}this.set(key, item.value);return item.value;}}, remove:{value:function remove(key){var item=this.cache[key];if(item){delete this.cache[key];this.length--;if(item.previous !== null){this.cache[item.previous].next = item.next;}if(item.next !== null){this.cache[item.next].previous = item.previous;}if(this.first === key){this.first = item.previous;}if(this.last === key){this.last = item.next;}}return item;}}, set:{value:function set(key, value){var item=this.remove(key);if(item === undefined){item = new LRUItem(value);}else {item.value = value;}item.next = null;item.previous = this.first;this.cache[key] = item;if(this.first !== null){this.cache[this.first].next = key;}this.first = key;if(this.last === null){this.last = key;}if(++this.length > this.max){this.evict();}return this;}}});return LRU;})();var LRUItem=function LRUItem(value){_classCallCheck(this, LRUItem);this.next = null;this.previous = null;this.value = value;};var lru={factory:function(max){return new LRU(max);}};var Observable=(function(){function Observable(){var arg=arguments[0] === undefined?MAX:arguments[0];_classCallCheck(this, Observable);this.limit = arg;this.listeners = {};this.hooks = new WeakMap();}_createClass(Observable, {dispatch:{value:function dispatch(ev){for(var _len=arguments.length, args=Array(_len > 1?_len - 1:0), _key=1; _key < _len; _key++) {args[_key - 1] = arguments[_key];}if(ev && this.listeners[ev]){utility.iterate(this.listeners[ev], function(i){i.handler.apply(i.scope, args);});}return this;}}, hook:{value:function hook(target, ev){if(typeof target.addEventListener != "function"){throw new Error(label.invalidArguments);}var self=this;var obj=this.hooks.get(target) || {};obj[ev] = function(arg){self.dispatch(ev, arg);};this.hooks.set(target, obj);target.addEventListener(ev, this.hooks.get(target)[ev], false);return target;}}, off:{value:function off(ev, id){if(this.listeners[ev]){if(id){delete this.listeners[ev][id];}else {delete this.listeners[ev];}}return this;}}, on:{value:function on(ev, handler, _x3, scope){var id=arguments[2] === undefined?utility.uuid():arguments[2];if(!this.listeners[ev]){this.listeners[ev] = {};}if(array.keys(this.listeners[ev]).length >= this.limit){throw new Error("Possible memory leak, more than " + this.limit + " listeners for event: " + ev);}this.listeners[ev][id] = {scope:scope || this, handler:handler};return this;}}, once:{value:function once(ev, handler, _x3, scope){var id=arguments[2] === undefined?utility.uuid():arguments[2];scope = scope || this;var self=this;return this.on(ev, function(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}handler.apply(scope, args);self.off(ev, id);}, id, scope);}}, unhook:{value:function unhook(target, ev){var obj=this.hooks.get(target);if(obj){target.removeEventListener(ev, obj[ev], false);delete obj[ev];if(array.keys(obj).length === 0){this.hooks["delete"](target);}else {this.hooks.set(target, obj);}}return target;}}});return Observable;})();var observable={factory:function(arg){return new Observable(arg);}};var Base=(function(){function Base(){_classCallCheck(this, Base);this.observer = null;}_createClass(Base, {addEventListener:{value:function addEventListener(ev, listener, id, scope){this.observer.on(ev, listener, id, scope || this);return this;}}, addListener:{value:function addListener(ev, listener, id, scope){this.observer.on(ev, listener, id, scope || this);return this;}}, dispatch:{value:function dispatch(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}this.observer.dispatch.apply(this.observer, args);return this;}}, dispatchEvent:{value:function dispatchEvent(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}this.observer.dispatch.apply(this.observer, args);return this;}}, emit:{value:function emit(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}this.observer.dispatch.apply(this.observer, args);return this;}}, hook:{value:function hook(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}this.observer.hook.apply(this.observer, args);return this;}}, listeners:{value:function listeners(ev){return ev?this.observer.listeners[ev]:this.observer.listeners;}}, off:{value:function off(ev, id){this.observer.off(ev, id);return this;}}, on:{value:function on(ev, listener, id, scope){this.observer.on(ev, listener, id, scope || this);return this;}}, once:{value:function once(ev, listener, id, scope){this.observer.once(ev, listener, id, scope || this);return this;}}, removeEventListener:{value:function removeEventListener(ev, id){this.observer.off(ev, id);return this;}}, removeListener:{value:function removeListener(ev, id){this.observer.off(ev, id);return this;}}});return Base;})();var base={factory:function(){return new Base();}};var array={add:function(obj, arg){if(!array.contains(obj, arg)){obj.push(arg);}return obj;}, binIndex:function(obj, arg){var max=obj.length - 1;var min=0;var idx=0;var val=0;while(min <= max) {idx = Math.floor((min + max) / 2);val = obj[idx];if(val < arg){min = idx + 1;}else if(val > arg){max = idx - 1;}else {return idx;}}return -1;}, cast:function(obj, key){var o=[];if(!isNaN(obj.length)){o = Array.from(obj);}else if(key === true){o = array.keys(obj);}else {utility.iterate(obj, function(i){o.push(i);});}return o;}, chunk:function(obj, size){var result=[];var nth=number.round(obj.length / size, "up");var start=0;var i=-1;while(++i < nth) {start = i * size;result.push(array.limit(obj, start, size));}return result;}, clear:function(obj){return obj.length > 0?array.remove(obj, 0, obj.length):obj;}, clone:function(obj){var shallow=arguments[1] === undefined?true:arguments[1];return utility.clone(obj, shallow);}, contains:function(obj, arg){return obj.indexOf(arg) > -1;}, collect:function(obj, fn){return obj.map(fn);}, compact:function(obj, diff){var result=obj.filter(function(i){return !regex.null_undefined.test(i);});return diff !== true?result:result.length < obj.length?result:null;}, count:function(obj, value){return obj.filter(function(i){return i === value;}).length;}, diff:function(obj1, obj2){var result=[];array.iterate(obj1, function(i){if(!array.contains(obj2, i)){array.add(result, i);}});array.iterate(obj2, function(i){if(!array.contains(obj1, i)){array.add(result, i);}});return result;}, each:function(obj, fn, async){var size=arguments[3] === undefined?10:arguments[3];var nth=obj.length;var i=undefined, offset=undefined;if(async !== true){i = -1;while(++i < nth) {if(fn.call(obj, obj[i], i) === false){break;}}}else {offset = 0;if(size > nth){size = nth;}utility.repeat(function(){var i=-1;var idx=undefined;while(++i < size) {idx = i + offset;if(idx === nth || fn.call(obj, obj[idx], idx) === false){return false;}}offset += size;if(offset >= nth){return false;}}, undefined, undefined, false);}return obj;}, eachReverse:function(obj, fn, async, size){var nth=obj.length;var i=undefined, offset=undefined;if(async !== true){i = nth;while(--i > -1) {if(fn.call(obj, obj[i], i) === false){break;}}}else {size = size || 10;offset = nth - 1;if(size > nth){size = nth;}utility.repeat(function(){var i=-1;var idx=undefined;while(++i < size) {idx = offset - i;if(idx < 0 || fn.call(obj, obj[idx], idx) === false){return false;}}offset -= size;if(offset < 0){return false;}}, undefined, undefined, false);}return obj;}, empty:function(obj){return obj.length === 0;}, equal:function(obj1, obj2){return json.encode(obj1) === json.encode(obj2);}, fill:function(obj, arg, start, offset){var fn=typeof arg === "function";var l=obj.length;var i=!isNaN(start)?start:0;var nth=!isNaN(offset)?i + offset:l - 1;if(nth > l - 1){nth = l - 1;}if(fn){while(i <= nth) {obj[i] = arg(obj[i]);i++;}}else {while(i <= nth) {obj[i] = arg;i++;}}return obj;}, first:function(obj){return obj[0];}, flat:function(obj){var result=[];result = obj.reduce(function(a, b){return a.concat(b);}, result);return result;}, forEach:function(obj, fn, async, size){return array.each(obj, fn, async, size);}, fromObject:function(obj){return array.mingle(array.keys(obj), array.cast(obj));}, index:function(obj, arg){return obj.indexOf(arg);}, indexed:function(obj){var result=[];utility.iterate(obj, function(v){result.push(v);});return result;}, intersect:function(obj1, obj2){var a=obj1.length > obj2.length?obj1:obj2;var b=a === obj1?obj2:obj1;return a.filter(function(key){return array.contains(b, key);});}, iterate:function(obj, fn){var itr=array.iterator(obj);var i=-1;var item=undefined, next=undefined;do{item = itr.next();if(!item.done){next = fn(item.value, ++i);}else {next = false;}}while(next !== false);return obj;}, iterator:function(obj){var i=-1;var n=obj.length;return {next:function next(){if(++i < n){return {done:false, value:obj[i]};}else {return {done:true};}}};}, keepIf:function(obj, fn){var result=undefined, remove=undefined;result = obj.filter(fn);remove = array.diff(obj, result);array.iterate(remove, function(i){array.remove(obj, array.index(obj, i));});return obj;}, keys:function(obj){return Array.keys(obj);}, keySort:function(obj, query, sub){query = query.replace(/\s*asc/ig, "").replace(/\s*desc/ig, " desc");var queries=string.explode(query).map(function(i){return i.split(" ");});var sorts=[];var braceS="[\"";var braceE="\"]";if(sub && sub !== ""){sub = "." + sub;}else {sub = "";}array.iterate(queries, function(i){var s=".";var e="";if(regex.not_dotnotation.test(i[0])){s = braceS;e = braceE;}sorts.push("try {");if(i[1] === "desc"){sorts.push("if ( a" + sub + s + i[0] + e + " < b" + sub + s + i[0] + e + " ) return 1;");sorts.push("if ( a" + sub + s + i[0] + e + " > b" + sub + s + i[0] + e + " ) return -1;");}else {sorts.push("if ( a" + sub + s + i[0] + e + " < b" + sub + s + i[0] + e + " ) return -1;");sorts.push("if ( a" + sub + s + i[0] + e + " > b" + sub + s + i[0] + e + " ) return 1;");}sorts.push("} catch (e) {");sorts.push("try {");sorts.push("if ( a" + sub + s + i[0] + e + " !== undefined ) return " + (i[1] === "desc"?"-1":"1") + ";");sorts.push("} catch (e) {}");sorts.push("try {");sorts.push("if ( b" + sub + s + i[0] + e + " !== undefined ) return " + (i[1] === "desc"?"1":"-1") + ";");sorts.push("} catch (e) {}");sorts.push("}");});sorts.push("return 0;");return obj.sort(new Function("a", "b", sorts.join("\n")));}, last:function(obj, arg){var n=obj.length - 1;if(arg >= n + 1){return obj;}else if(isNaN(arg) || arg === 1){return obj[n];}else {return array.limit(obj, n - --arg, n);}}, limit:function(obj, start, offset){var result=[];var i=start - 1;var nth=start + offset;var max=obj.length;if(max > 0){while(++i < nth && i < max) {result.push(obj[i]);}}return result;}, max:function(obj){return array.last(array.sorted(array.clone(obj)));}, mean:function(obj){return obj.length > 0?array.sum(obj) / obj.length:undefined;}, median:function(obj){var dupe=array.sorted(array.clone(obj));var nth=dupe.length;var mid=number.round(nth / 2, "down");return number.odd(nth)?dupe[mid]:(dupe[mid - 1] + dupe[mid]) / 2;}, merge:function(obj1, obj2){array.iterate(obj2, function(i){array.add(obj1, i);});return obj1;}, min:function(obj){return array.sorted(array.clone(obj))[0];}, mingle:function(obj1, obj2){var result=obj1.map(function(i, idx){return [i, obj2[idx]];});return result;}, mode:function(obj){var values={};var count=0;var mode=[];var nth=undefined, result=undefined;array.iterate(obj, function(i){if(!isNaN(values[i])){values[i]++;}else {values[i] = 1;}});count = array.max(array.cast(values));utility.iterate(values, function(v, k){if(v === count){mode.push(number.parse(k));}});nth = mode.length;if(nth > 0){result = nth === 1?mode[0]:mode;}return result;}, range:function(obj){return array.max(obj) - array.min(obj);}, rassoc:function(obj, arg){var result=undefined;array.iterate(obj, function(i, idx){if(i[1] === arg){result = utility.clone(obj[idx], true);return false;}});return result;}, reject:function(obj, fn){return array.diff(obj, obj.filter(fn));}, remove:function(obj, start, end){if(isNaN(start)){start = array.index(obj, start);if(start === -1){return obj;}}else {start = start || 0;}var length=obj.length;var remaining=obj.slice((end || start) + 1 || length);obj.length = start < 0?length + start:start;obj.push.apply(obj, remaining);return obj;}, removeIf:function(obj, fn){var remove=obj.filter(fn);array.iterate(remove, function(i){array.remove(obj, array.index(obj, i));});return obj;}, removeWhile:function(obj, fn){var remove=[];array.iterate(obj, function(i){if(fn(i) !== false){remove.push(i);}else {return false;}});array.iterate(remove, function(i){array.remove(obj, array.index(obj, i));});return obj;}, replace:function(obj1, obj2){array.remove(obj1, 0, obj1.length);array.iterate(obj2, function(i){obj1.push(i);});return obj1;}, rest:function(obj){var arg=arguments[1] === undefined?1:arguments[1];if(arg < 1){arg = 1;}return array.limit(obj, arg, obj.length);}, rindex:function(obj, arg){var result=-1;array.iterate(obj, function(i, idx){if(i === arg){result = idx;}});return result;}, rotate:function(obj, arg){var nth=obj.length;var result=undefined;if(arg === 0){result = obj;}else {if(arg < 0){arg += nth;}else {arg--;}result = array.limit(obj, arg, nth);result = result.concat(array.limit(obj, 0, arg));}return result;}, series:function(_x3, end){var start=arguments[0] === undefined?0:arguments[0];var offset=arguments[2] === undefined?1:arguments[2];end = end || start;var result=[];var n=-1;var nth=Math.max(0, Math.ceil((end - start) / offset));while(++n < nth) {result[n] = start;start += offset;}return result;}, sort:function(a, b){var types={a:typeof a, b:typeof b};var c=undefined, d=undefined, result=undefined;if(types.a === "number" && types.b === "number"){result = a - b;}else {c = a.toString();d = b.toString();if(c < d){result = -1;}else if(c > d){result = 1;}else if(types.a === types.b){result = 0;}else if(types.a === "boolean"){result = -1;}else {result = 1;}}return result;}, sorted:function(obj){return obj.sort(array.sort);}, split:function(obj, divisor){var result=[];var total=obj.length;var nth=Math.ceil(total / divisor);var low=Math.floor(total / divisor);var lower=Math.ceil(total / nth);var lowered=false;var start=0;var i=-1;if(number.diff(total, divisor * nth) > nth){lower = total - low * divisor + low - 1;}else if(total % divisor > 0 && lower * nth >= total){lower--;}while(++i < divisor) {if(i > 0){start = start + nth;}if(!lowered && lower < divisor && i === lower){--nth;lowered = true;}result.push(array.limit(obj, start, nth));}return result;}, stddev:function(obj){return Math.sqrt(array.variance(obj));}, sum:function(obj){var result=0;if(obj.length > 0){result = obj.reduce(function(prev, cur){return prev + cur;});}return result;}, take:function(obj, n){return array.limit(obj, 0, n);}, toObject:function(ar){var obj={};var i=ar.length;while(i--) {obj[i.toString()] = ar[i];}return obj;}, total:function(obj){return array.indexed(obj).length;}, unique:function(obj){var result=[];array.iterate(obj, function(i){array.add(result, i);});return result;}, variance:function(obj){var nth=obj.length;var n=0;var mean=undefined;if(nth > 0){mean = array.mean(obj);array.iterate(obj, function(i){n += math.sqr(i - mean);});return n / nth;}else {return n;}}, zip:function(obj, args){var result=[];if(!(args instanceof Array)){args = typeof args === "object"?array.cast(args):[args];}array.iterate(args, function(i, idx){if(!(i instanceof Array)){args[idx] = [i];}});array.iterate(obj, function(i, idx){result[idx] = [i];array.iterate(args, function(x){result[idx].push(x[idx] || null);});});return result;}};var cache={lru:lru.factory(CACHE), expire:function(uri){if(cache.lru.cache[uri]){cache.lru.remove(uri);return true;}return false;}, expired:function(uri){var item=cache.lru.cache[uri];return item && item.value.expires < new Date().getTime();}, get:function(uri, expire, headers){uri = utility.parse(uri).href;var item=cache.lru.get(uri);if(!item){return false;}if(expire !== false && cache.expired(uri) || !utility.equal(item.request_headers, headers)){cache.expire(uri);return false;}return utility.clone(item, true);}, set:function(uri, property, value){uri = utility.parse(uri).href;var item=cache.lru.get(uri);if(!item){item = {permission:0};}if(property === "permission"){item.permission |= value;}else if(property === "!permission"){item.permission &= ~value;}else {item[property] = value;}cache.lru.set(uri, item);return item;}};var KXMLHttpRequest=(function(_Base){function KXMLHttpRequest(xhr){_classCallCheck(this, KXMLHttpRequest);var self=this;this.observer = observable.factory();this.defer = deferred.factory();this.xhr = xhr;array.iterate(EVENTS, function(i){self.hook(self.xhr, i);});}_inherits(KXMLHttpRequest, _Base);_createClass(KXMLHttpRequest, {always:{value:function always(arg){return this.defer.always.call(this.defer, arg);}}, done:{value:function done(arg){return this.defer.done.call(this.defer, arg);}}, fail:{value:function fail(arg){return this.defer.fail.call(this.defer, arg);}}, reject:{value:function reject(arg){return this.defer.reject.call(this.defer, arg);}}, resolve:{value:function resolve(arg){return this.defer.resolve.call(this.defer, arg);}}, then:{value:function then(success, failure){return this.defer.then.call(this.defer, success, failure);}}});return KXMLHttpRequest;})(Base);var client={ab:typeof ArrayBuffer != "undefined", blob:typeof Blob != "undefined", doc:typeof Document != "undefined", ie:(function(){return !server && regex.ie.test(navigator.userAgent);})(), version:function(){var result=0;if(client.ie){result = number.parse(string.trim(navigator.userAgent.replace(/( .*msie|;.*)/gi, "")) || 9, 10);}return result;}, allows:function(uri, verb, headers){uri = utility.parse(uri).href;verb = verb.toLowerCase();var result=false;var bit=0;if(!cache.get(uri, false, headers)){result = undefined;}else {if(regex.del.test(verb)){bit = 1;}else if(regex.get_headers.test(verb)){bit = 4;}else if(regex.put_post.test(verb)){bit = 2;}else if(regex.patch.test(verb)){bit = 8;}result = Boolean(client.permissions(uri, headers).bit & bit);}return result;}, bit:function(args){var result=0;array.iterate(args, function(verb){verb = verb.toLowerCase();if(regex.get_headers.test(verb)){result |= 4;}else if(regex.put_post.test(verb)){result |= 2;}else if(regex.patch.test(verb)){result |= 8;}else if(regex.del.test(verb)){result |= 1;}});return result;}, cors:function(uri){return !server && uri.indexOf("//") > -1 && uri.indexOf("//" + location.host) === -1;}, headers:function(xhr, uri, type, request_headers){var headers=string.trim(xhr.getAllResponseHeaders()).split("\n");var items={};var o={};var allow=null;var expires=new Date();var cors=client.cors(uri);var cachable=true;array.iterate(headers, function(i){var header=i.split(": ");items[header[0].toLowerCase()] = string.trim(header[1]);if(allow === null){if(!cors && regex.allow.test(header[0]) || cors && regex.allow_cors.test(header[0])){allow = header[1];return false;}}});if(regex.no.test(items["cache-control"])){expires = expires.getTime();}else if(items["cache-control"] && regex.number_present.test(items["cache-control"])){expires = expires.setSeconds(expires.getSeconds() + number.parse(regex.number_present.exec(items["cache-control"])[0], 10));}else if(items.expires){expires = new Date(items.expires).getTime();}else {cachable = false;expires = expires.getTime();}o.cachable = cachable;o.expires = expires;o.headers = items;o.timestamp = new Date();o.permission = client.bit(allow !== null?string.explode(allow):[type]);if(type === "get" && cachable){cache.set(uri, "expires", o.expires);cache.set(uri, "headers", o.headers);cache.set(uri, "timestamp", o.timestamp);cache.set(uri, "permission", o.permission);cache.set(uri, "request_headers", request_headers);}return o;}, parse:function(xhr){var type=arguments[1] === undefined?"":arguments[1];var result=undefined, obj=undefined;if((regex.json_maybe.test(type) || string.isEmpty(type)) && (regex.json_wrap.test(xhr.responseText) && Boolean(obj = json.decode(xhr.responseText, true)))){result = obj;}else if(type === "text/csv"){result = csv.decode(xhr.responseText);}else if(type === "text/tsv"){result = csv.decode(xhr.responseText, "\t");}else if(regex.xml.test(type)){if(type !== "text/xml"){xhr.overrideMimeType("text/xml");}result = xhr.responseXML;}else if(type === "text/plain" && regex.is_xml.test(xhr.responseText) && xml.valid(xhr.responseText)){result = xml.decode(xhr.responseText);}else {result = xhr.responseText;}return result;}, permissions:function(uri, headers){var cached=cache.get(uri, false, headers);var bit=!cached?0:cached.permission;var result={allows:[], bit:bit, map:{partial:8, read:4, write:2, "delete":1, unknown:0}};if(bit & 1){result.allows.push("DELETE");}if(bit & 2){result.allows.push("POST");result.allows.push("PUT");}if(bit & 4){result.allows.push("GET");}if(bit & 8){result.allows.push("PATCH");}return result;}, jsonp:function(uri, args){var defer=deferred.factory();var callback="callback";var cbid=undefined, s=undefined;if(external === undefined){if(!global.keigai){global.keigai = {callback:{}};}external = "keigai";}if(args instanceof Object && !args.callback){callback = args.callback;}do{cbid = utility.genId().slice(0, 10);}while(global.callback[cbid]);uri = uri.replace(callback + "=?", callback + "=" + external + ".callback." + cbid);global.callback[cbid] = function(arg){utility.clearTimers(cbid);delete global.callback[cbid];defer.resolve(arg);element.destroy(s);};s = element.create("script", {src:uri, type:"text/javascript"}, utility.dom("head")[0]);utility.defer(function(){defer.reject(new Error(label.requestTimeout));}, 30000, cbid);return defer;}, kxhr:function(xhr){return new KXMLHttpRequest(xhr);}, request:function(uri, _x3, args, headers){var type=arguments[1] === undefined?"GET":arguments[1];uri = utility.parse(uri).href;type = type.toLowerCase();headers = headers instanceof Object?headers:null;var cors=client.cors(uri);var kxhr=client.kxhr(!client.ie || (!cors || client.version > 9)?new XMLHttpRequest():new XDomainRequest());var payload=(regex.put_post.test(type) || regex.patch.test(type)) && args?args:null;var cached=type === "get"?cache.get(uri, false, headers):false;var contentType=null;var doc=client.doc;var ab=client.ab;var blob=client.blob;if(client.ie && client.version === 9 && cors && !regex.xdomainrequest.test(type)){throw new Error(label.notAvailable);}kxhr.on("readystatechange", function(ev){var state=kxhr.xhr.readyState;if(state === 1){kxhr.dispatch("beforeXHR", kxhr.xhr, ev);}else if(state === 4){kxhr.dispatch("afterXHR", kxhr.xhr, ev);}});if(client.allows(uri, type, headers) === false){kxhr.dispatch("beforeXHR", kxhr.xhr, null);kxhr.xhr.status = 405;kxhr.reject(new Error(label.methodNotAllowed));utility.delay(function(){kxhr.dispatch("afterXHR", kxhr.xhr, null);});return;}if(type === "get" && Boolean(cached)){if(server){kxhr.xhr.readyState = 4;kxhr.xhr.status = 200;kxhr.xhr._resheaders = cached.headers;}kxhr.dispatch("beforeXHR", kxhr.xhr, null);kxhr.resolve(cached.response);utility.delay(function(){kxhr.dispatch("afterXHR", kxhr.xhr, null);});return;}utility.delay(function(){kxhr.xhr.open(type.toUpperCase(), uri, true);if(headers !== null && headers.hasOwnProperty("content-type")){contentType = headers["content-type"];}if(cors && contentType === null){contentType = "text/plain";}if(payload !== null){if(payload.hasOwnProperty("xml")){payload = payload.xml;}if(doc && payload instanceof Document){payload = xml.decode(payload);}if(typeof payload === "string" && regex.is_xml.test(payload)){contentType = "application/xml";}if(!(ab && payload instanceof ArrayBuffer) && !(blob && payload instanceof Blob) && !(payload instanceof Buffer) && payload instanceof Object){contentType = "application/json";payload = json.encode(payload);}if(contentType === null && (ab && payload instanceof ArrayBuffer || blob && payload instanceof Blob)){contentType = "application/octet-stream";}if(contentType === null){contentType = "application/x-www-form-urlencoded; charset=UTF-8";}}if(!client.ie || (!cors || client.version > 9)){if(headers === null){headers = {};}if(typeof cached === "object" && cached.headers.hasOwnProperty("etag")){headers.etag = cached.headers.etag;}if(contentType !== null){headers["content-type"] = contentType;}if(headers.hasOwnProperty("callback")){delete headers.callback;}headers["x-requested-with"] = "XMLHttpRequest";utility.iterate(headers, function(v, k){if(v !== null && k !== "withCredentials"){kxhr.xhr.setRequestHeader(k, v);}});if(typeof kxhr.xhr.withCredentials === "boolean" && headers !== null && typeof headers.withCredentials === "boolean"){kxhr.xhr.withCredentials = headers.withCredentials;}}kxhr.on("load", function(){var self=kxhr;var xdr=client.ie && self.xhr.readyState === undefined;var shared=true;var o=undefined, r=undefined, t=undefined, redirect=undefined;if(!xdr && kxhr.xhr.readyState === 4){switch(kxhr.xhr.status){case 200:case 201:case 202:case 203:case 204:case 205:case 206:o = client.headers(kxhr.xhr, uri, type, headers);if(type === "head"){return kxhr.resolve(o.headers);}else if(type === "options"){return kxhr.resolve(o.headers);}else if(type !== "delete"){if(server && regex.priv.test(o.headers["cache-control"])){shared = false;}if(regex.http_body.test(kxhr.xhr.status)){t = o.headers["content-type"] || "";r = client.parse(kxhr.xhr, t);if(r === undefined){kxhr.reject(new Error(label.serverError));}}if(type === "get" && shared && o.cachable){cache.set(uri, "response", o.response = utility.clone(r, true));}else {cache.expire(uri, true);}}else if(type === "delete"){cache.expire(uri, true);}switch(kxhr.xhr.status){case 200:case 202:case 203:case 206:kxhr.resolve(r);break;case 201:if((o.headers.location === undefined || string.isEmpty(o.headers.location)) && !string.isUrl(r)){kxhr.resolve(r);}else {redirect = string.trim(o.headers.Location || r);client.request(redirect).then(function(arg){if(type === "get" && shared && o.cachable){cache.set(uri, "response", arg);}self.resolve(arg);}, function(e){self.reject(e);});}break;case 204:case 205:kxhr.resolve(null);break;}break;case 304:kxhr.resolve(r);break;case 401:kxhr.reject(new Error(kxhr.xhr.responseText || label.serverUnauthorized));break;case 403:cache.set(uri, "!permission", client.bit([type]));kxhr.reject(new Error(kxhr.xhr.responseText || label.serverForbidden));break;case 405:cache.set(uri, "!permission", client.bit([type]));kxhr.reject(new Error(kxhr.xhr.responseText || label.serverInvalidMethod));break;default:kxhr.reject(new Error(kxhr.xhr.responseText || label.serverError));}}else if(xdr){r = client.parse(kxhr.xhr, "text/plain");cache.set(uri, "permission", client.bit(["get"]));cache.set(uri, "response", r);kxhr.resolve(r);}});kxhr.on("error", function(e){kxhr.reject(e);});kxhr.xhr.send(payload !== null?payload:undefined);});return kxhr;}, scroll:function(dest, ms){var defer=deferred();var start=client.scrollPos();var t=0;ms = (!isNaN(ms)?ms:250) / 100;utility.repeat(function(){var pos=math.bezier(start[0], start[1], dest[0], dest[1], ++t / 100);window.scrollTo(pos[0], pos[1]);if(t === 100){defer.resolve(true);return false;}}, ms, "scrolling");return defer;}, scrollPos:function(){return [window.scrollX || 0, window.scrollY || 0];}};var csv={decode:function(arg){var delimiter=arguments[1] === undefined?",":arguments[1];var regex=new RegExp(delimiter + "(?=(?:[^\"]|\"(?:[^\"])[^\"]*\")*$)");var rows=string.trim(arg).split("\n");var keys=rows.shift().split(delimiter);var result=[];var nth=rows.length;var x=keys.length;var i=-1;var n=undefined, obj=undefined, row=undefined;while(++i < nth) {obj = {};row = rows[i].split(regex);n = -1;while(++n < x) {obj[keys[n]] = utility.coerce((row[n] || "").replace(/^"|"$/g, ""));}result.push(obj);}return result;}, encode:function(arg){var delimiter=arguments[1] === undefined?",":arguments[1];var header=arguments[2] === undefined?true:arguments[2];var obj=json.decode(arg, true) || arg;var result="";var prepare=function(input){var output=undefined;if(input instanceof Array){output = "\"" + input.toString() + "\"";if(regex.object_type.test(output)){output = "\"" + csv.encode(input, delimiter) + "\"";}}else if(input instanceof Object){output = "\"" + csv.encode(input, delimiter) + "\"";}else if(regex.csv_quote.test(input)){output = "\"" + input.replace(/"/g, "\"\"") + "\"";}else {output = input;}return output;};if(obj instanceof Array){if(obj[0] instanceof Object){if(header){result = array.keys(obj[0]).join(delimiter) + "\n";}result += obj.map(function(i){return csv.encode(i, delimiter, false);}).join("\n");}else {result += prepare(obj, delimiter) + "\n";}}else {if(header){result = array.keys(obj).join(delimiter) + "\n";}result += array.cast(obj).map(prepare).join(delimiter) + "\n";}return result.replace(regex.eol_nl, "");}};var DataListFilter=(function(_Base2){function DataListFilter(element, list, debounce){_classCallCheck(this, DataListFilter);this.debounce = debounce;this.element = element;this.filters = {};this.list = list;this.observer = observable.factory();}_inherits(DataListFilter, _Base2);_createClass(DataListFilter, {set:{value:function set(fields){var self=this;this.filters = {};array.iterate(string.explode(fields), function(v){self.filters[v] = "";});return this;}}, teardown:{value:function teardown(){this.observer.unhook(this.element, "keyup");this.observer.unhook(this.element, "input");this.element = null;return this;}}, update:{value:function update(){var self=this;utility.defer(function(){var val=element.val(self.element).toString();self.list.dispatch("beforeFilter", self.element, val);if(!string.isEmpty(val)){utility.iterate(self.filters, function(v, k){var queries=string.explode(val);queries = queries.filter(function(i){return !string.isEmpty(i);});array.iterate(queries, function(i, idx){queries[idx] = "^.*" + string.escape(i).replace(/(^\*|\*$)/g, "").replace(/\*/g, ".*") + ".*";});self.filters[k] = queries.join(",");});self.list.filter = self.filters;}else {self.list.filter = null;}self.list.pageIndex = 1;self.list.refresh();self.list.dispatch("afterFilter", self.element);}, this.debounce, this.element.id + "Debounce");return this;}}});return DataListFilter;})(Base);var filter={factory:function(target, list, filters){var debounce=arguments[3] === undefined?250:arguments[3];var ref=[list];var obj=new DataListFilter(target, ref[0], debounce).set(filters);element.attr(target, "type", "text");obj.observer.hook(obj.element, "keyup");obj.observer.hook(obj.element, "input");obj.on("keyup", obj.update, "keyup");obj.on("input", obj.update, "input");return obj;}};var DataGrid=(function(_Base3){function DataGrid(target, store, fields){var sortable=arguments[3] === undefined?[]:arguments[3];var options=arguments[4] === undefined?{}:arguments[4];var filtered=arguments[5] === undefined?false:arguments[5];_classCallCheck(this, DataGrid);var sortOrder=undefined;if(options.order && !string.isEmpty(options.order)){sortOrder = string.explode(options.order).map(function(i){return i.replace(regex.after_space, "");});}this.element = element.create("section", {"class":"grid"}, target);this.fields = fields;this.filtered = filtered;this.list = null;this.observer = observable.factory();this.options = options;this.store = store;this.sortable = sortable;this.sortOrder = sortOrder || sortable;}_inherits(DataGrid, _Base3);_createClass(DataGrid, {add:{value:function add(record){var self=this;this.store.set(null, record).then(null, function(e){utility.error(e);self.dispatch("error", e);});return this;}}, dump:{value:function dump(){return this.store.dump(this.list.records, this.fields);}}, refresh:{value:function refresh(){var sort=[];var self=this;this.dispatch("beforeRefresh", this.element);if(this.sortOrder.length > 0){array.iterate(this.sortOrder, function(i){var obj=element.find(self.element, ".header span[data-field='" + i + "']")[0];sort.push(string.trim(i + " " + (element.data(obj, "sort") || "")));});this.options.order = this.list.order = sort.join(", ");}this.list.where = null;utility.merge(this.list, this.options);this.list.refresh();this.dispatch("afterRefresh", this.element);return this;}}, remove:{value:function remove(record){var self=this;this.store.del(record).then(null, function(e){utility.error(e);self.dispatch("error", e);});return this;}}, sort:{value:function sort(ev){var target=utility.target(ev);var field=undefined;utility.stop(ev);if(element.hasClass(target, "sortable")){field = element.data(target, "field");element.data(target, "sort", element.data(target, "sort") === "asc"?"desc":"asc");array.remove(this.sortOrder, field);this.sortOrder.splice(0, 0, field);this.refresh();}return this;}}, teardown:{value:function teardown(){this.observer.unhook(element.find(this.element, "ul.header")[0], "click");this.list.teardown();element.destroy(this.element);this.element = null;return this;}}, update:{value:function update(key, data){var self=this;this.store.update(key, data).then(null, function(e){utility.error(e);self.dispatch("error", e);});return this;}}});return DataGrid;})(Base);var grid={factory:function(target, store, fields, sortable, options, filtered, debounce){var ref=[store];var obj=new DataGrid(target, ref[0], fields, sortable, options, filtered);var template="";var header=element.create("li", {}, element.create("ul", {"class":"header"}, obj.element));var width=100 / obj.fields.length + "%";var css="display:inline-block;width:" + width;var sort=obj.options.order?string.explode(obj.options.order):[];array.iterate(obj.fields, function(i){var trimmed=i.replace(/.*\./g, "");var el=element.create("span", {innerHTML:string.capitalize(string.unCamelCase(string.unhyphenate(trimmed, true)).replace(/_|-/g, " "), true), style:css, "data-field":i}, header);if(array.contains(obj.sortable, i)){element.addClass(el, "sortable");if(sort.filter(function(x){return x.indexOf(i) === 0;}).length > 0){element.data(el, "sort", array.contains(sort, i + " desc")?"desc":"asc");}}template += "<span class=\"" + i + "\" data-field=\"" + i + "\" style=\"" + css + "\">{{" + i + "}}</span>";});if(obj.sortable.length > 0){obj.observer.hook(header.parentNode, "click", obj.sort, "sort", obj);}if(obj.filtered === true){obj.options.listFiltered = true;obj.options.listFilter = obj.fields.join(",");}ref.push(list.factory(obj.element, ref[0], template, obj.options));obj.list = ref[1];obj.on("beforeRefresh", function(arg){element.dispatch(arg, "beforeRefresh");}, "bubble");obj.on("afterRefresh", function(arg){element.dispatch(arg, "afterRefresh");}, "bubble");obj.on("click", function(e){if(element.hasClass(e.currentTarget, "header")){obj.sort(e);}}, "header");obj.list.on("change", function(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}obj.dispatch.apply(obj, ["change"].concat(args));}, "change");obj.list.on("beforeFilter", function(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}obj.dispatch.apply(obj, ["beforeFilter"].concat(args));}, "beforeFilter");obj.list.on("afterFilter", function(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}obj.dispatch.apply(obj, ["afterFilter"].concat(args));}, "afterFilter");return obj;}};var DataList=(function(_Base4){function DataList(element, store, template){_classCallCheck(this, DataList);this.callback = null;this.current = [];this.element = element;this.emptyMsg = label.noData;this.filter = null;this.filtered = [];this.id = utility.genId();this.items = [];this.listFilter = null;this.mutation = null;this.observer = observable.factory();this.pageIndex = 1;this.pageSize = null;this.pageRange = 5;this.pagination = "bottom";this.placeholder = "";this.order = "";this.records = [];this.template = template;this.total = 0;this.store = store;this.where = null;}_inherits(DataList, _Base4);_createClass(DataList, {add:{value:function add(record){var self=this;this.store.set(null, record).then(null, function(e){utility.error(e);self.dispatch("error", e);});return this;}}, dump:{value:function dump(){return this.store.dump(this.records);}}, page:{value:function page(n){this.pageIndex = n;return this.refresh();}}, pages:{value:function pages(){var self=this;var obj=this.element;var page=this.pageIndex;var pos=this.pagination;var range=this.pageRange;var mid=Math.floor(range / 2);var start=page - mid;var end=page + mid;var total=list.pages(this);var diff=undefined;array.iterate(utility.dom("#" + obj.id + "-pages-top, #" + obj.id + "-pages-bottom"), function(i){if(i){self.observer.unhook(i, "click");element.destroy(i);}});if(this.filter && this.filtered.length === 0 || this.total === 0 || total === 1){return this;}if(start < 1){diff = number.diff(start, 1);start = start + diff;end = end + diff;}if(end > total){end = total;start = end - range + 1;if(start < 1){start = 1;}}if(number.diff(start, end) >= range){--end;}array.iterate(string.explode(pos), function(i){var current=false;var more=page > 1;var next=page + 1 <= total;var last=page >= total;var el=undefined, n=undefined;el = element.create("ul", {"class":"list pages hidden " + i, id:obj.id + "-pages-" + i}, obj, i === "bottom"?"after":"before");element.create(more?"a":"span", {"class":"first page", "data-page":1, innerHTML:"&lt;&lt;"}, element.create("li", {}, el));element.create(more?"a":"span", {"class":"prev page", "data-page":page - 1, innerHTML:"&lt;"}, element.create("li", {}, el));n = start - 1;while(++n <= end) {current = n === page;element.create(current?"span":"a", {"class":current?"current page":"page", "data-page":n, innerHTML:n}, element.create("li", {}, el));}element.create(next?"a":"span", {"class":"next page", "data-page":next?page + 1:null, innerHTML:"&gt;"}, element.create("li", {}, el));element.create(last?"span":"a", {"class":"last page", "data-page":last?null:total, innerHTML:"&gt;&gt;"}, element.create("li", {}, el));element.removeClass(el, "hidden");self.observer.hook(el, "click");});return this;}}, refresh:{value:function refresh(create){create = create === true;var self=this;var el=this.element;var template=typeof this.template === "object";var filter=this.filter !== null;var items=[];var callback=typeof this.callback === "function";var reg=new RegExp();var registry=[];var range=[];var fn=undefined, ceiling=undefined, next=undefined;this.dispatch("beforeRefresh", el);if(!template){fn = function(i){var html=self.template;var items=array.unique(html.match(/\{\{[\w\.\-\[\]]+\}\}/g));html = html.replace("{{" + self.store.key + "}}", i.key);array.iterate(items, function(attr){var key=attr.replace(/\{\{|\}\}/g, ""), value=utility.walk(i.data, key);if(value === undefined){value = "";}reg.compile(string.escape(attr), "g");html = html.replace(reg, value);});html = html.replace(/\{\{.*\}\}/g, self.placeholder);return "<li data-key=\"" + i.key + "\">" + html + "</li>";};}else {fn = function(i){var obj=json.encode(self.template);var items=array.unique(obj.match(/\{\{[\w\.\-\[\]]+\}\}/g));obj = obj.replace("{{" + self.store.key + "}}", i.key);array.iterate(items, function(attr){var key=attr.replace(/\{\{|\}\}/g, "");var value=utility.walk(i.data, key) || "";reg.compile(string.escape(attr), "g");obj = obj.replace(reg, json.encode(value).replace(/(^")|("$)/g, ""));});obj = json.decode(obj.replace(/\{\{.*\}\}/g, self.placeholder));return {li:obj};};}next = function(args){self.records = args;self.total = self.records.length;self.filtered = [];self.current = [];if(filter){array.iterate(self.records, function(i){utility.iterate(self.filter, function(v, k){var key=undefined;if(array.contains(registry, i.key)){return false;}key = k === self.store.key;array.iterate(string.explode(v), function(query){var reg=new RegExp(query, "i");var value=!key?utility.walk(i.data, k):"";if(key && reg.test(i.key) || reg.test(value)){registry.push(i.key);self.filtered.push(i);return false;}});});});}if(self.pageSize !== null && !isNaN(self.pageIndex) && !isNaN(self.pageSize)){ceiling = list.pages(self);if(ceiling > 0 && self.pageIndex > ceiling){return self.page(ceiling);}else if(self.total > 0){range = list.range(self);self.current = array.limit(!filter?self.records:self.filtered, range[0], range[1]);}}else {self.current = !filter?self.records:self.filtered;}array.iterate(self.current, function(i){var html=fn(i);var hash=btoa(html);items.push({key:i.key, template:html, hash:hash});});utility.render(function(){var destroy=[];var callbacks=[];var i=undefined, nth=undefined;if(items.length === 0){element.html(el, "<li class=\"empty\">" + self.emptyMsg + "</li>");}else {if(self.items.length === 0){element.html(el, items.map(function(i){return i.template;}).join(""));if(callback){array.iterate(array.cast(el.childNodes), function(i){self.callback(i);});}}else {array.iterate(items, function(i, idx){if(self.items[idx] !== undefined && self.items[idx].hash !== i.hash){element.data(element.html(el.childNodes[idx], i.template.replace(/<li data-key=\"\d+\">|<\/li>/g, "")), "key", i.key);callbacks.push(idx);}else if(self.items[idx] === undefined){element.create(i.template, null, el);callbacks.push(idx);}});if(items.length < self.items.length){i = items.length - 1;nth = self.items.length;while(++i < nth) {destroy.push(i);}array.iterate(destroy.reverse(), function(i){element.destroy(el.childNodes[i]);});}if(callback){array.iterate(callbacks, function(i){self.callback(el.childNodes[i]);});}}}self.items = items;if(self.pageSize !== null && regex.top_bottom.test(self.pagination) && !isNaN(self.pageIndex) && !isNaN(self.pageSize)){self.pages();}else {array.iterate(utility.$("#" + el.id + "-pages-top, #" + el.id + "-pages-bottom"), function(i){element.destroy(i);});}self.dispatch("afterRefresh", el);});};if(this.where === null){string.isEmpty(this.order)?next(this.store.get()):this.store.sort(this.order, create).then(next, function(e){utility.error(e);self.dispatch("error", e);});}else if(string.isEmpty(this.order)){this.store.select(this.where).then(next, function(e){utility.error(e);self.dispatch("error", e);});}else {this.store.sort(this.order, create, this.where).then(next, function(e){utility.error(e);self.dispatch("error", e);});}return this;}}, remove:{value:function remove(record){var self=this;this.store.del(record).then(null, function(e){utility.error(e);self.dispatch("error", e);});return this;}}, sort:{value:function sort(order){this.order = order;return this.refresh();}}, teardown:{value:function teardown(destroy){destroy = destroy === true;var self=this;var el=this.element;var id=el.id;array.iterate(this.store.lists, function(i, idx){if(i.id === self.id){array.remove(self.store.lists, idx);return false;}});if(this.listFilter){this.listFilter.teardown();}array.iterate(utility.$("#" + id + "-pages-top, #" + id + "-pages-bottom"), function(i){self.observer.unhook(i, "click");if(destroy){element.destroy(i);}});this.observer.unhook(el, "click");if(destroy){element.destroy(el);}this.element = null;return this;}}, update:{value:function update(key, data){var self=this;this.store.update(key, data).then(null, function(e){utility.error(e);self.dispatch("error", e);});return this;}}});return DataList;})(Base);var list={factory:function(target, store, template, options){var ref=[store];var obj=new DataList(element.create("ul", {"class":"list", id:utility.genId(null, true)}, target), ref[0], template);if(options instanceof Object){if(options.listFiltered && options.listFilter){obj.listFilter = filter.factory(element.create("input", {id:obj.element.id + "-filter", "class":"filter", placeholder:"Filter"}, target, "first"), obj, options.listFilter, options.debounce || 250);delete options.listFilter;delete options.listFiltered;delete options.debounce;}utility.merge(obj, options);}obj.store.lists.push(obj);obj.on("beforeRefresh", function(arg){element.dispatch(arg, "beforeRefresh");}, "bubble");obj.on("afterRefresh", function(arg){element.dispatch(arg, "afterRefresh");}, "bubble");obj.on("change", function(arg){element.dispatch(obj.element, "change", arg);}, "change");obj.on("click", function(e){var target=utility.target(e);var page=undefined;utility.stop(e);if(target.nodeName === "A"){page = element.data(target, "page");if(!isNaN(page)){obj.page(page);}}}, "pagination");if(typeof MutationObserver === "function"){obj.mutation = new MutationObserver(function(arg){obj.dispatch("change", arg);});obj.mutation.observe(obj.element, {childList:true, subtree:true});}if(obj.store.uri === null || obj.store.loaded){obj.refresh();}return obj;}, pages:function(obj){if(isNaN(obj.pageSize)){throw new Error(label.invalidArguments);}return Math.ceil((!obj.filter?obj.total:obj.filtered.length) / obj.pageSize);}, range:function(obj){var start=obj.pageIndex * obj.pageSize - obj.pageSize;var end=obj.pageSize;return [start, end];}};var Deferred=(function(){function Deferred(){_classCallCheck(this, Deferred);var self=this;this.promise = promise.factory();this.onDone = [];this.onAlways = [];this.onFail = [];this.promise.then(function(arg){array.iterate(self.onDone, function(i){i(arg);});array.iterate(self.onAlways, function(i){i(arg);});self.onAlways = [];self.onDone = [];self.onFail = [];}, function(arg){array.iterate(self.onFail, function(i){i(arg);});array.iterate(self.onAlways, function(i){i(arg);});self.onAlways = [];self.onDone = [];self.onFail = [];});}_createClass(Deferred, {always:{value:function always(arg){this.onAlways.push(arg);return this;}}, "catch":{value:function _catch(arg){return this.promise["catch"](arg);}}, done:{value:function done(arg){this.onDone.push(arg);return this;}}, fail:{value:function fail(arg){this.onFail.push(arg);return this;}}, reject:{value:function reject(arg){this.promise.reject.call(this.promise, arg);return this;}}, resolve:{value:function resolve(arg){this.promise.resolve.call(this.promise, arg);return this;}}, then:{value:function then(success, failure){return this.promise.then(success, failure);}}});return Deferred;})();var deferred={factory:function(){return new Deferred();}};var element={addClass:function(obj, arg){element.klass(obj, arg, true);}, appendTo:function(obj, child){obj.appendChild(child);return obj;}, attr:function(obj, key, value){var target=undefined, result=undefined;if(regex.svg.test(obj.namespaceURI)){if(value === undefined){result = obj.getAttributeNS(obj.namespaceURI, key);if(result === null || string.isEmpty(result)){result = undefined;}else {result = utility.coerce(result);}}else {obj.setAttributeNS(obj.namespaceURI, key, value);}}else {if(typeof value === "string"){value = string.trim(value);}if(regex.checked_disabled.test(key) && value === undefined){return utility.coerce(obj[key]);}else if(regex.checked_disabled.test(key) && value !== undefined){obj[key] = value;}else if(obj.nodeName === "SELECT" && key === "selected" && value === undefined){return utility.dom("#" + obj.id + " option[selected=\"selected\"]")[0] || utility.dom("#" + obj.id + " option")[0];}else if(obj.nodeName === "SELECT" && key === "selected" && value !== undefined){target = utility.dom("#" + obj.id + " option[selected=\"selected\"]")[0];if(target !== undefined){target.selected = false;target.removeAttribute("selected");}target = utility.dom("#" + obj.id + " option[value=\"" + value + "\"]")[0];target.selected = true;target.setAttribute("selected", "selected");}else if(value === undefined){result = obj.getAttribute(key);if(result === null || string.isEmpty(result)){result = undefined;}else {result = utility.coerce(result);}return result;}else {obj.setAttribute(key, value);}}return obj;}, clear:function(obj){if(typeof obj.reset === "function"){obj.reset();}else if(obj.value !== undefined){element.update(obj, {innerHTML:"", value:""});}else {element.update(obj, {innerHTML:""});}return obj;}, create:function(type, args, obj, pos){var svg=false;var frag=false;var fragment=undefined, result=undefined;type = type.replace(/\t|\n|\r/g, "");if(obj){svg = obj.namespaceURI && regex.svg.test(obj.namespaceURI);}else {obj = document.body;}if(regex.html.test(type)){frag = true;fragment = element.frag(type);result = fragment.childNodes.length === 1?fragment.childNodes[0]:array.cast(fragment.childNodes);}else {if(!svg && !regex.svg.test(type)){fragment = document.createElement(type);}else {fragment = document.createElementNS("http://www.w3.org/2000/svg", type);}if(args instanceof Object){element.update(fragment, args);}}if(!pos || pos === "last"){obj.appendChild(fragment);}else if(pos === "first"){element.prependChild(obj, fragment);}else if(pos === "after"){pos = {after:obj};obj = obj.parentNode;obj.insertBefore(fragment, pos.after.nextSibling);}else if(pos.after){obj.insertBefore(fragment, pos.after.nextSibling);}else if(pos === "before"){pos = {before:obj};obj = obj.parentNode;obj.insertBefore(fragment, pos.before);}else if(pos.before){obj.insertBefore(fragment, pos.before);}else {obj.appendChild(fragment);}return !frag?fragment:result;}, css:function(obj, key, value){if(!regex.caps.test(key)){key = string.toCamelCase(key);}if(value !== undefined){obj.style[key] = value;return obj;}else {return obj.style[key];}}, data:function(obj, key, value){if(value !== undefined){obj.setAttribute("data-" + key, regex.json_wrap.test(value)?json.encode(value):value);return obj;}else {return utility.coerce(obj.getAttribute("data-" + key));}}, destroy:function(obj){if(obj.parentNode !== null){obj.parentNode.removeChild(obj);}return undefined;}, disable:function(obj){if(typeof obj.disabled === "boolean" && !obj.disabled){obj.disabled = true;}return obj;}, dispatch:function(obj, type){var data=arguments[2] === undefined?{}:arguments[2];var bubbles=arguments[3] === undefined?true:arguments[3];var cancelable=arguments[4] === undefined?true:arguments[4];var ev=undefined;if(!obj){return;}try{ev = new CustomEvent(type);}catch(e) {ev = document.createEvent("CustomEvent");}ev.initCustomEvent(type, bubbles, cancelable, data);obj.dispatchEvent(ev);return obj;}, enable:function(obj){if(typeof obj.disabled === "boolean" && obj.disabled){obj.disabled = false;}return obj;}, find:function(obj, arg){var result=[];array.iterate(string.explode(arg), function(i){result = result.concat(array.cast(obj.querySelectorAll(i)));});return result;}, frag:function(arg){var obj=document.createDocumentFragment();if(arg){array.iterate(array.cast(element.create("div", {innerHTML:arg}, obj).childNodes), function(i){obj.appendChild(i);});obj.removeChild(obj.childNodes[0]);}return obj;}, has:function(obj, arg){var result=element.find(obj, arg);return !isNaN(result.length) && result.length > 0;}, hasClass:function(obj, arg){return obj.classList.contains(arg);}, hidden:function(obj){return obj.style.display === "none" || obj.hidden === true;}, html:function(obj, arg){if(arg === undefined){return obj.innerHTML;}else {obj.innerHTML = arg;return obj;}}, is:function(obj, arg){if(regex.selector_is.test(arg)){return element.find(obj.parentNode, obj.nodeName.toLowerCase() + arg).filter(function(i){return i.id === obj.id;}).length === 1;}else {return new RegExp(arg, "i").test(obj.nodeName);}}, klass:function(obj, arg){var add=arguments[2] === undefined?true:arguments[2];arg = string.explode(arg, " ");if(add){array.iterate(arg, function(i){obj.classList.add(i);});}else {array.iterate(arg, function(i){if(i !== "*"){obj.classList.remove(i);}else {array.iterate(obj.classList, function(x){obj.classList.remove(x);});return false;}});}return obj;}, position:function(){var obj=arguments[0] === undefined?document.body:arguments[0];var left=undefined, top=undefined, right=undefined, bottom=undefined, height=undefined, width=undefined;left = top = 0;width = obj.offsetWidth;height = obj.offsetHeight;if(obj.offsetParent){top = obj.offsetTop;left = obj.offsetLeft;while(obj = obj.offsetParent) {left += obj.offsetLeft;top += obj.offsetTop;}right = document.body.offsetWidth - (left + width);bottom = document.body.offsetHeight - (top + height);}else {right = width;bottom = height;}return [left, top, right, bottom];}, prependChild:function(obj, child){return obj.childNodes.length === 0?obj.appendChild(child):obj.insertBefore(child, obj.childNodes[0]);}, removeAttr:function(obj, key){if(regex.svg.test(obj.namespaceURI)){obj.removeAttributeNS(obj.namespaceURI, key);}else {if(obj.nodeName === "SELECT" && key === "selected"){array.iterate(element.find(obj, "option"), function(i){if(i.selected === true){i.selected = false;i.removeAttribute("selected");return false;}});}else {obj.removeAttribute(key);}}return obj;}, removeClass:function(obj, arg){element.klass(obj, arg, false);}, scrollTo:function(obj, ms, offsetTop, offsetLeft){var pos=array.remove(element.position(obj), 2, 3);if(!isNaN(offsetTop)){pos[0] += offsetTop;}if(!isNaN(offsetLeft)){pos[1] += offsetLeft;}return client.scroll(pos, ms);}, serialize:function(obj){var string=arguments[1] === undefined?true:arguments[1];var encode=arguments[2] === undefined?true:arguments[2];var registry={};var children=undefined, result=undefined;children = obj.nodeName === "FORM"?obj.elements?array.cast(obj.elements):obj.find("button, input, select, textarea"):[obj];array.iterate(children, function(i){var id=i.id || i.name || i.type;if(i.nodeName === "FORM"){utility.merge(registry, json.decode(element.serialize(i)));}else if(!registry[id]){registry[id] = element.val(i);}});if(!string){result = registry;}else {result = "";utility.iterate(registry, function(v, k){encode?result += "&" + encodeURIComponent(k) + "=" + encodeURIComponent(v):result += "&" + k + "=" + v;});result = result.replace(regex.and, "?");}return result;}, size:function(obj){return [obj.offsetWidth + number.parse(obj.style.paddingLeft || 0) + number.parse(obj.style.paddingRight || 0) + number.parse(obj.style.borderLeft || 0) + number.parse(obj.style.borderRight || 0), obj.offsetHeight + number.parse(obj.style.paddingTop || 0) + number.parse(obj.style.paddingBottom || 0) + number.parse(obj.style.borderTop || 0) + number.parse(obj.style.borderBottom || 0)];}, text:function(obj, arg){var key=obj.textContent?"textContent":"innerText";var payload={};var set=false;if(typeof arg != "undefined"){set = true;payload[key] = arg;}return set?element.update(obj, payload):obj[key];}, toggleClass:function(obj, arg){obj.classList.toggle(arg);return obj;}, update:function(obj, args){utility.iterate(args, function(v, k){if(regex.element_update.test(k)){obj[k] = v;}else if(k === "class"){!string.isEmpty(v)?element.addClass(obj, v):element.removeClass(obj, "*");}else if(k.indexOf("data-") === 0){element.data(obj, k.replace("data-", ""), v);}else {element.attr(obj, k, v);}});return obj;}, val:function(obj, value){var ev="input";var output=undefined;if(value === undefined){if(regex.radio_checkbox.test(obj.type)){if(string.isEmpty(obj.name)){throw new Error(label.expectedProperty);}array.iterate(utility.dom("input[name='" + obj.name + "']"), function(i){if(i.checked){output = i.value;return false;}});}else if(regex.select.test(obj.type)){output = null;array.iterate(element.find(obj, "option"), function(i){if(i.selected === true){output = i.value;return false;}});}else if(obj.value){output = obj.value;}else {output = element.text(obj);}if(output !== undefined){output = utility.coerce(output);if(typeof output === "string"){output = string.trim(output);}}else {output = "";}}else {value = value.toString();if(regex.radio_checkbox.test(obj.type)){ev = "click";array.iterate(utility.dom("input[name='" + obj.name + "']"), function(i){if(i.value === value){i.checked = true;output = i;return false;}});}else if(regex.select.test(obj.type)){ev = "change";array.iterate(element.find(obj, " option"), function(i){if(i.value === value){i.selected = true;output = i;return false;}});}else {obj.value !== undefined?obj.value = value:element.text(obj, value);}element.dispatch(obj, ev);output = obj;}return output;}};var json={decode:function(arg, silent){try{return JSON.parse(arg);}catch(e) {if(silent !== true){utility.error(e, [arg, silent], undefined);}return undefined;}}, encode:function(arg, silent){try{return JSON.stringify(arg);}catch(e) {if(silent !== true){utility.error(e, [arg, silent], undefined);}return undefined;}}};var label={expectedNumber:"Expected a Number", expectedProperty:"Expected a property, and it was not set", expectedObject:"Expected an Object", invalidArguments:"One or more arguments is invalid", invalidStateNoHeaders:"INVALID_STATE_ERR: Headers have not been received", invalidStateNoSync:"Synchronous XMLHttpRequest requests are not supported", invalidStateNotOpen:"INVALID_STATE_ERR: Object is not open", invalidStateNotSending:"INVALID_STATE_ERR: Object is sending", invalidStateNotUsable:"INVALID_STATE_ERR: Object is not usable", methodNotAllowed:"Method not allowed", noData:"Nothing to display", notAvailable:"Requested method is not available", datastoreNoPrevVersion:"No previous version found", requestTimeout:"Request timed out", serverError:"Server error has occurred", serverForbidden:"Forbidden to access URI", serverInvalidMethod:"Method not allowed", serverUnauthorized:"Authorization required to access URI", upgrade:"Your browser is too old to use keigai, please upgrade"};var math={bezier:function(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}var a=array.cast(args);var t=a.pop();var P=array.chunk(a, 2);var n=P.length;var c=undefined, S0=undefined, Q0=undefined, Q1=undefined, Q2=undefined, C0=undefined, C1=undefined, C2=undefined, C3=undefined;if(n < 2 || n > 4){throw new Error(label.invalidArguments);}c = [];S0 = 1 - t;Q0 = math.sqr(S0);Q1 = 2 * S0 * t;Q2 = math.sqr(t);C0 = Math.pow(S0, 3);C1 = 3 * Q0 * t;C2 = 3 * S0 * Q2;C3 = Math.pow(t, 3);if(n === 2){c.push(S0 * P[0][0] + t * P[1][0]);c.push(S0 * P[0][1] + t * P[1][1]);}else if(n === 3){c.push(Q0 * P[0][0] + Q1 * P[1][0] + (Q2 + P[2][0]));c.push(Q0 * P[0][1] + Q1 * P[1][1] + (Q2 + P[2][1]));}else if(n === 4){c.push(C0 * P[0][0] + C1 * P[1][0] + C2 * P[2][0] + C3 * P[3][0]);c.push(C0 * P[0][1] + C1 * P[1][1] + C2 * P[2][1] + C3 * P[3][1]);}return c;}, dist:function(a, b){return Math.sqrt(math.sqr(b[0] - a[0]) + math.sqr(b[1] - a[1]));}, sqr:function(n){return n * n;}};var number={diff:function(num1, num2){return Math.abs(num1 - num2);}, even:function(arg){return arg % 2 === 0;}, format:function(arg){var delimiter=arguments[1] === undefined?",":arguments[1];var every=arguments[2] === undefined?3:arguments[2];arg = arg.toString();var d=arg.indexOf(".") > -1?"." + arg.replace(regex.number_format_1, ""):"";var a=arg.replace(regex.number_format_2, "").split("").reverse();var p=Math.floor(a.length / every);var i=1;var n=undefined, b=undefined;for(b = 0; b < p; b++) {n = i === 1?every:every * i + (i === 2?1:i - 1);a.splice(n, 0, delimiter);i++;}a = a.reverse().join("");if(a.charAt(0) === delimiter){a = a.substring(1);}return a + d;}, half:function(a, b){return b?a / b === 0.5:a / 2;}, odd:function(arg){return !number.even(arg);}, parse:function(arg, base){return base === undefined?parseFloat(arg):parseInt(arg, base);}, random:function(){var arg=arguments[0] === undefined?100:arguments[0];return Math.floor(Math.random() * (arg + 1));}, round:function(arg, direction){arg = number.parse(arg);if(direction === undefined || string.isEmpty(direction)){return number.parse(arg.toFixed(0));}else if(regex.down.test(direction)){return ~ ~arg;}else {return Math.ceil(arg);}}};var promise={factory:function(){var promise=undefined, pCatch=undefined, pResolve=undefined, pReject=undefined, pThen=undefined;promise = new Promise(function(resolve, reject){pResolve = resolve;pReject = reject;});pCatch = function(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}return promise["catch"].apply(promise, args);};pThen = function(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}return promise.then.apply(promise, args);};return {"catch":pCatch, resolve:pResolve, reject:pReject, then:pThen};}};var DataStore=(function(_Base5){function DataStore(){_classCallCheck(this, DataStore);this.autosave = false;this.callback = null;this.credentials = null;this.lists = [];this.events = true;this.expires = null;this.headers = {Accept:"application/json"};this.ignore = [];this.index = [];this.indexes = {key:{}};this.key = null;this.loaded = false;this.mongodb = "";this.observer = observable.factory();this.records = [];this.source = null;this.total = 0;this.versions = {};this.versioning = true;this.views = {};this.uri = null;}_inherits(DataStore, _Base5);_createClass(DataStore, {batch:{value:function batch(type, data){var sync=arguments[2] === undefined?false:arguments[2];var self=this;var events=this.events;var defer=deferred.factory();var deferreds=[];if(!regex.set_del.test(type) || sync && regex.del.test(type) || typeof data != "object"){defer.reject(new Error(label.invalidArguments));}else {if(events){this.dispatch("beforeBatch", data);}if(sync){this.clear(sync);}if(data.length === 0){this.loaded = true;if(events){this.dispatch("afterBatch", this.records);}defer.resolve(this.records);}else {if(type === "del"){array.iterate(data, function(i){deferreds.push(self.del(i, false, true));});}else {array.iterate(data, function(i){deferreds.push(self.set(null, i, true));});}this.loaded = false;utility.when(deferreds).then(function(args){self.loaded = true;if(events){self.dispatch("afterBatch", args);}array.iterate(self.lists, function(i){i.refresh(true);});if(type === "del"){self.records = array.compact(self.records);self.reindex();}if(self.autosave){self.save();}defer.resolve(args);}, function(e){if(events){self.dispatch("failedBatch", e);}defer.reject(e);});}}return defer;}}, buildUri:{value:function buildUri(key){var parsed=utility.parse(this.uri);return parsed.protocol + "//" + parsed.host + parsed.pathname + (regex.endslash.test(parsed.pathname)?"":"/") + key;}}, clear:{value:function clear(){var sync=arguments[0] === undefined?true:arguments[0];var events=this.events === true;var resave=this.autosave === true;if(!sync){if(events){this.dispatch("beforeClear");}array.iterate(this.lists, function(i){if(i){i.teardown(true);}});this.autosave = false;this.callback = null;this.credentials = null;this.lists = [];this.events = true;this.expires = null;this.headers = {Accept:"application/json"};this.ignore = [];this.index = [];this.indexes = {key:{}};this.key = null;this.loaded = false;this.records = [];this.source = null;this.total = 0;this.versions = {};this.versioning = true;this.views = {};this.uri = null;if(events){this.dispatch("afterClear");}}else {this.indexes = {key:{}};this.loaded = false;this.records = [];this.total = 0;this.views = {};array.iterate(this.lists, function(i){if(i){i.refresh();}});}if(resave){this.save();}return this;}}, del:{value:function del(record){var reindex=arguments[1] === undefined?true:arguments[1];var batch=arguments[2] === undefined?false:arguments[2];record = record.key?record:this.get(record);var self=this;var defer=deferred.factory();if(record === undefined){defer.reject(new Error(label.invalidArguments));}else {if(this.events){self.dispatch("beforeDelete", record);}if(this.uri === null || this.callback !== null){this.delComplete(record, reindex, batch, defer);}else {client.request(this.buildUri(record.key), "DELETE", null, utility.merge({withCredentials:this.credentials}, this.headers)).then(function(){self.delComplete(record, reindex, batch, defer);}, function(e){self.dispatch("failedDelete", e);defer.reject(e);});}}return defer;}}, delComplete:{value:function delComplete(record, reindex, batch, defer){var self=this;delete this.indexes.key[record.key];delete this.versions[record.key];this.total--;this.views = {};if(!batch){array.remove(this.records, record.index);if(reindex){this.reindex();}else {array.iterate(record.indexes, function(i){array.remove(self.indexes[i[0]][i[1]], record.index);if(self.indexes[i[0]][i[1]].length === 0){delete self.indexes[i[0]][i[1]];}});}if(this.autosave){this.purge(record.key);}if(this.events){this.dispatch("afterDelete", record);}array.iterate(this.lists, function(i){i.refresh();});}else {this.records[record.index] = null;}return defer.resolve(record.key);}}, dump:{value:function dump(args, fields){args = args || this.records;var self=this;var custom=fields instanceof Array && fields.length > 0;var key=this.key !== null;var fn=undefined;if(custom){fn = function(i){var record={};array.iterate(fields, function(f){record[f] = f === self.key?isNaN(i.key)?i.key:Number(i.key):utility.clone(i.data[f], true);});return record;};}else {fn = function(i){var record={};if(key){record[self.key] = isNaN(i.key)?i.key:Number(i.key);}utility.iterate(i.data, function(v, k){record[k] = utility.clone(v, true);});return record;};}return args.map(fn);}}, get:{value:function get(record, offset){var type=typeof record;var self=this;var result=undefined;if(type === "undefined"){result = this.records;}else if(type === "string"){if(record.indexOf(",") === -1){result = this.records[this.indexes.key[record]];}else {result = string.explode(record).map(function(i){if(!isNaN(i)){return self.records[parseInt(i, 10)];}else {return self.records[self.indexes.key[i]];}});}}else if(type === "number"){if(isNaN(offset)){result = this.records[parseInt(record, 10)];}else {result = array.limit(this.records, parseInt(record, 10), parseInt(offset, 10));}}return utility.clone(result, true);}}, join:{value:(function(_join){var _joinWrapper=function join(_x, _x2){return _join.apply(this, arguments);};_joinWrapper.toString = function(){return _join.toString();};return _joinWrapper;})(function(arg, field){var join=arguments[2] === undefined?"inner":arguments[2];var self=this;var defer=deferred.factory();var results=[];var deferreds=[];var key=field === this.key;var keys=array.merge(array.keys(this.records[0].data), array.keys(arg.records[0].data));var fn=undefined;if(join === "inner"){fn = function(i){var where={}, record=i.data, defer=deferred.factory();where[field] = key?i.key:record[field];arg.select(where).then(function(match){if(match.length > 2){defer.reject(new Error(label.databaseMoreThanOne));}else if(match.length === 1){results.push(utility.merge(record, match[0].data));defer.resolve(true);}else {defer.resolve(false);}});deferreds.push(defer);};}else if(join === "left"){fn = function(i){var where={}, record=i.data, defer=deferred.factory();where[field] = key?i.key:record[field];arg.select(where).then(function(match){if(match.length > 2){defer.reject(new Error(label.databaseMoreThanOne));}else if(match.length === 1){results.push(utility.merge(record, match[0].data));defer.resolve(true);}else {array.iterate(keys, function(i){if(record[i] === undefined){record[i] = null;}});results.push(record);defer.resolve(true);}});deferreds.push(defer);};}else if(join === "right"){fn = function(i){var where={}, record=i.data, defer=deferred.factory();where[field] = key?i.key:record[field];self.select(where).then(function(match){if(match.length > 2){defer.reject(new Error(label.databaseMoreThanOne));}else if(match.length === 1){results.push(utility.merge(record, match[0].data));defer.resolve(true);}else {array.iterate(keys, function(i){if(record[i] === undefined){record[i] = null;}});results.push(record);defer.resolve(true);}});deferreds.push(defer);};}array.iterate(utility.clone(join === "right"?arg.records:this.records, true), fn);utility.when(deferreds).then(function(){defer.resolve(results);}, function(e){defer.reject(e);});return defer;})}, only:{value:function only(arg){if(arg === this.key){return this.records.map(function(i){return i.key;});}else {return this.records.map(function(i){return i.data[arg];});}}}, purge:{value:function purge(arg){return this.storage(arg || this, "remove");}}, reindex:{value:function reindex(){var self=this;var i=-1;var tmp=[];this.views = {};this.indexes = {key:{}};if(this.total > 0){array.iterate(this.records, function(record){if(record !== undefined){tmp[++i] = record;record.index = i;self.indexes.key[record.key] = i;self.setIndexes(record);}});}this.records = tmp;return this;}}, restore:{value:function restore(arg){return this.storage(arg || this, "get");}}, save:{value:function save(arg){return this.storage(arg || this, "set");}}, select:{value:function select(where){var _this=this;var self=this;var defer=deferred.factory();var functions=[];var clauses=undefined, cond=undefined, index=undefined, result=undefined, sorted=undefined, values=undefined, worker=undefined;if(!(where instanceof Object)){defer.reject(new Error(label.invalidArguments));}else {utility.iterate(where, function(v, k){if(typeof v === "function"){_this[k] = v.toString();functions.push(k);}});if(webWorker){try{worker = utility.worker(defer);worker.postMessage({cmd:"select", indexes:this.indexes, records:this.records, where:json.encode(where), functions:functions});}catch(e) {webWorker = false;this.select(where).then(function(arg){defer.resolve(arg);}, function(e){defer.reject(e);});}}else {clauses = array.fromObject(where);sorted = array.flat(clauses).filter(function(i, idx){return idx % 2 === 0;}).sort(array.sort);index = sorted.join("|");values = sorted.map(function(i){return where[i];}).join("|");cond = "return ( ";if(functions.length === 0 && this.indexes[index]){result = (this.indexes[index][values] || []).map(function(i){return self.records[i];});}else {if(clauses.length > 1){array.iterate(clauses, function(i, idx){var b1="( ";if(idx > 0){b1 = " && ( ";}if(i[1] instanceof Function){cond += b1 + i[1].toString() + "( rec.data[\"" + i[0] + "\"] ) )";}else if(!isNaN(i[1])){cond += b1 + "rec.data[\"" + i[0] + "\"] === " + i[1] + " )";}else {cond += b1 + "rec.data[\"" + i[0] + "\"] === \"" + i[1] + "\" )";}});}else {if(clauses[0][1] instanceof Function){cond += clauses[0][1].toString() + "( rec.data[\"" + clauses[0][0] + "\"] )";}else if(!isNaN(clauses[0][1])){cond += "rec.data[\"" + clauses[0][0] + "\"] === " + clauses[0][1];}else {cond += "rec.data[\"" + clauses[0][0] + "\"] === \"" + clauses[0][1] + "\"";}}cond += " );";result = utility.clone(this.records, true).filter(new Function("rec", cond));}defer.resolve(result);}}return defer;}}, set:{value:function set(key, data){var batch=arguments[2] === undefined?false:arguments[2];var overwrite=arguments[3] === undefined?false:arguments[3];data = utility.clone(data, true);var self=this;var events=this.events;var defer=deferred.factory();var record=key !== null?this.get(key) || null:data[this.key]?this.get(data[this.key]) || null:null;var method="POST";var parsed=utility.parse(self.uri || "");var uri=undefined, odata=undefined, rdefer=undefined;var patch=function(overwrite, data, ogdata){var ndata=[];if(overwrite){array.iterate(array.keys(ogdata), function(k){if(k !== self.key && data[k] === undefined){ndata.push({op:"remove", path:"/" + k});}});}utility.iterate(data, function(v, k){if(k !== self.key && ogdata[k] === undefined){ndata.push({op:"add", path:"/" + k, value:v});}else if(json.encode(ogdata[k]) !== json.encode(v)){ndata.push({op:"replace", path:"/" + k, value:v});}});return ndata;};if(typeof data === "string"){if(data.indexOf("//") === -1){if(data.charAt(0) !== "/"){uri = this.buildUri(data);}else if(self.uri !== null && regex.root.test(data)){uri = parsed.protocol + "//" + parsed.host + data;}else {uri = data;}}else {uri = data;}key = uri.replace(regex.not_endpoint, "");if(string.isEmpty(key)){defer.reject(new Error(label.invalidArguments));}else {if(!batch && events){self.dispatch("beforeSet", {key:key, data:data});}client.request(uri, "GET", null, utility.merge({withCredentials:self.credentials}, self.headers)).then(function(arg){self.setComplete(record, key, self.source?utility.walk(arg, self.source):arg, batch, overwrite, defer);}, function(e){self.dispatch("failedSet", e);defer.reject(e);});}}else {if(!batch && events){self.dispatch("beforeSet", {key:key, data:data});}if(batch || this.uri === null){this.setComplete(record, key, data, batch, overwrite, defer);}else {if(key !== null){uri = this.buildUri(key);method = "PATCH";odata = utility.clone(data, true);data = patch(overwrite, data, this.dump([record])[0]);}else {uri = parsed.protocol + "//" + parsed.host + parsed.pathname;}rdefer = client.request(uri, method, data, utility.merge({withCredentials:this.credentials}, this.headers));rdefer.then(function(arg){var change=undefined;if(rdefer.xhr.status !== 204 && rdefer.xhr.status < 300){change = key === null?self.source?utility.walk(arg, self.source):arg:odata;}else {change = odata;}self.setComplete(record, key, change, batch, overwrite, defer);}, function(e){if(method === "PATCH"){method = "PUT";data = utility.clone(odata, true);utility.iterate(record.data, function(v, k){data[k] = v;});client.request(uri, method, data, utility.merge({withCredentials:self.credentials}, self.headers)).then(function(){self.setComplete(record, key, odata, batch, overwrite, defer);}, function(e){self.dispatch("failedSet", e);defer.reject(e);});}else {self.dispatch("failedSet", e);defer.reject(e);}});}}return defer;}}, setComplete:{value:function setComplete(record, key, data, batch, overwrite, defer){this.views = {};if(key === null){if(this.key !== null && data[this.key] !== undefined && data[this.key] !== null){key = data[this.key].toString();}else {key = utility.uuid();}}if(this.key){delete data[this.key];}if(record === null){record = {index:this.total++, key:key, data:data, indexes:[]};this.indexes.key[key] = record.index;this.records[record.index] = record;if(this.versioning){this.versions[record.key] = lru.factory(VERSIONS);this.versions[record.key].nth = 0;}}else {if(this.versioning){if(this.versions[record.key] === undefined){this.versions[record.key] = lru.factory(VERSIONS);this.versions[record.key].nth = 0;}this.versions[record.key].set("v" + ++this.versions[record.key].nth, this.dump([record])[0]);}record = this.records[record.index];if(overwrite){record.data = {};}utility.iterate(data, function(v, k){record.data[k] = v;});record = utility.clone(record, true);}this.setIndexes(record);if(!batch){if(this.autosave){this.save();}if(this.events){this.dispatch("afterSet", record);}array.iterate(this.lists, function(i){i.refresh();});}defer.resolve(record);return this;}}, setExpires:{value:function setExpires(arg){var id=this.id + "Expire";var expires=arg;var self=this;if(arg !== null && this.uri === null || arg !== null && (isNaN(arg) || arg < 1000)){throw new Error(label.invalidArguments);}if(this.expires === arg){return;}this.expires = arg;utility.clearTimers(id);if(arg === null){return;}utility.repeat(function(){if(self.uri === null){self.setExpires(null);return false;}self.dispatch("beforeExpire");cache.expire(self.uri);self.dispatch("expire");self.dispatch("afterExpire");}, expires, id, false);}}, setIndexes:{value:function setIndexes(arg){var self=this;var delimter="|";arg.indexes = [];array.iterate(this.index, function(i){var keys=i.split(delimter);var values="";if(self.indexes[i] === undefined){self.indexes[i] = {};}array.iterate(keys, function(k, kdx){values += (kdx > 0?delimter:"") + arg.data[k];});if(self.indexes[i][values] === undefined){self.indexes[i][values] = [];}if(!array.contains(self.indexes[i][values], arg.index)){self.indexes[i][values].push(arg.index);arg.indexes.push([i, values]);}});return this;}}, setUri:{value:function setUri(arg){var defer=deferred.factory();var self=this;var parsed=undefined;if(arg !== null && string.isEmpty(arg)){defer.reject(new Error(label.invalidArguments));}if(arg === null){this.uri = arg;}else {parsed = utility.parse(arg);this.uri = parsed.protocol + "//" + parsed.host + parsed.path;if(!string.isEmpty(parsed.auth) && !this.headers.authorization && !this.headers.Authorization){this.headers.Authorization = "Basic " + btoa(decodeURIComponent(parsed.auth));}this.on("expire", function(){self.sync();}, "resync");cache.expire(this.uri);this.sync().then(function(arg){defer.resolve(arg);}, function(e){defer.reject(e);});}return defer;}}, sort:{value:function sort(query, create, where){create = create === true || where instanceof Object;var self=this;var view=string.toCamelCase(string.explode(query).join(" "));var defer=deferred.factory();var next=function(records){var worker=undefined;if(self.total === 0){defer.resolve([]);}else if(!create && self.views[view]){defer.resolve(self.views[view]);}else if(webWorker){defer.then(function(arg){self.views[view] = arg;return self.views[view];}, function(e){utility.error(e);});try{worker = utility.worker(defer);worker.postMessage({cmd:"sort", indexes:self.indexes, records:records, query:query});}catch(e) {webWorker = false;self.views[view] = array.keySort(records, query, "data");defer.resolve(self.views[view]);}}else {self.views[view] = array.keySort(records, query, "data");defer.resolve(self.views[view]);}};if(!where){next(utility.clone(this.records, true));}else {this.select(where).then(next, function(e){defer.reject(e);});}return defer;}}, storage:{value:function storage(obj, op, type){var self=this;var record=false;var mongo=!string.isEmpty(this.mongodb);var session=type === "session" && typeof sessionStorage != "undefined";var defer=deferred.factory();var data=undefined, key=undefined, result=undefined;if(!regex.number_string_object.test(typeof obj) || !regex.get_remove_set.test(op)){defer.reject(new Error(label.invalidArguments));}else {record = regex.number_string.test(typeof obj) || obj.hasOwnProperty("data");if(op !== "remove"){if(record && !(obj instanceof Object)){obj = this.get(obj);}key = record?obj.key:obj.id;}else if(op === "remove" && record){key = obj.key || obj;}if(mongo){mongodb.connect(this.mongodb, function(e, db){if(e){if(db){db.close();}return defer.reject(e);}db.collection(self.id, function(e, collection){if(e){db.close();return defer.reject(e);}if(op === "get"){if(record){collection.find({_id:obj.key}).limit(1).toArray(function(e, recs){db.close();if(e){defer.reject(e);}else if(recs.length === 0){defer.resolve(null);}else {delete recs[0]._id;self.set(key, recs[0], true).then(function(rec){defer.resolve(rec);}, function(e){defer.reject(e);});}});}else {collection.find({}).toArray(function(e, recs){var i=undefined, nth=undefined;if(e){db.close();return defer.reject(e);}i = -1;nth = recs.length;if(nth > 0){self.records = recs.map(function(r){var rec={key:r._id, index:++i, data:{}};self.indexes.key[rec.key] = rec.index;rec.data = r;delete rec.data._id;self.setIndexes(rec);return rec;});self.total = nth;}db.close();defer.resolve(self.records);});}}else if(op === "remove"){collection.remove(record?{_id:key}:{}, {safe:true}, function(e, arg){db.close();if(e){defer.reject(e);}else {defer.resolve(arg);}});}else if(op === "set"){if(record){collection.update({_id:obj.key}, obj.data, {w:1, safe:true, upsert:true}, function(e, arg){db.close();if(e){defer.reject(e);}else {defer.resolve(arg);}});}else {collection.remove({}, {w:1, safe:true}, function(e){var deferreds=undefined;if(e){db.close();return defer.reject(e);}else {deferreds = [];array.iterate(self.records, function(i){var data={};var defer2=deferred.factory();deferreds.push(defer2);utility.iterate(i.data, function(v, k){data[k] = v;});collection.update({_id:i.key}, data, {w:1, safe:true, upsert:true}, function(e, arg){if(e){defer2.reject(e);}else {defer2.resolve(arg);}});});utility.when(deferreds).then(function(result){db.close();defer.resolve(result);}, function(e){db.close();defer.reject(e);});}});}}else {db.close();defer.reject(null);}});});}else {if(op === "get"){result = session?sessionStorage.getItem(key):localStorage.getItem(key);if(result !== null){result = json.decode(result);if(record){self.set(key, result, true).then(function(rec){defer.resolve(rec);}, function(e){defer.reject(e);});}else {utility.merge(self, result);defer.resolve(self);}}else {defer.resolve(self);}defer.then(function(){self.loaded = true;}, function(e){throw e;});}else if(op === "remove"){session?sessionStorage.removeItem(key):localStorage.removeItem(key);defer.resolve(this);}else if(op === "set"){data = json.encode(record?obj.data:{total:this.total, index:this.index, indexes:this.indexes, records:this.records});session?sessionStorage.setItem(key, data):localStorage.setItem(key, data);defer.resolve(this);}else {defer.reject(null);}}}return defer;}}, sync:{value:function sync(){var self=this;var events=this.events === true;var defer=deferred.factory();var success=function(arg){var data=undefined;if(typeof arg != "object"){return failure(new Error(label.expectedObject));}if(self.source !== null){arg = utility.walk(arg, self.source);}if(arg instanceof Array){data = arg;}else {data = [arg];}self.batch("set", data, true).then(function(arg){if(events){self.dispatch("afterSync", arg);}defer.resolve(arg);}, failure);};var failure=function(e){if(events){self.dispatch("failedSync", e);}defer.reject(e);};if(this.uri === null || string.isEmpty(this.uri)){defer.reject(new Error(label.invalidArguments));}else {if(events){this.dispatch("beforeSync", this.uri);}if(this.callback !== null){client.jsonp(this.uri, {callback:this.callback}).then(success, failure);}else {client.request(this.uri, "GET", null, utility.merge({withCredentials:this.credentials}, this.headers)).then(success, failure);}}return defer;}}, teardown:{value:function teardown(){var uri=this.uri;var id=undefined;if(uri !== null){cache.expire(uri, true);id = this.id + "DataExpire";utility.clearTimers(id);array.iterate(this.records, function(i){var recordUri=uri + "/" + i.key;cache.expire(recordUri, true);});}array.iterate(this.lists, function(i){i.teardown(true);});this.clear(true);this.dispatch("afterTeardown");return this;}}, undo:{value:function undo(key, version){var record=this.get(key);var defer=deferred.factory();var versions=this.versions[record.key];var previous=undefined;if(record === undefined){defer.reject(new Error(label.invalidArguments));}else {if(versions){previous = versions.get(version || versions.first);if(previous === undefined){defer.reject(label.datastoreNoPrevVersion);}else {this.set(key, previous).then(function(arg){defer.resolve(arg);}, function(e){defer.reject(e);});}}else {defer.reject(label.datastoreNoPrevVersion);}}return defer;}}, unique:{value:function unique(key){return array.unique(this.records.map(function(i){return i.data[key];}));}}, update:{value:function update(key, data){var record=this.get(key);var defer=deferred.factory();if(record === undefined){defer.reject(new Error(label.invalidArguments));}else {this.set(key, utility.merge(record.data, data)).then(function(arg){defer.resolve(arg);}, function(e){defer.reject(e);});}return defer;}}});return DataStore;})(Base);var store={factory:function(recs, args){var obj=new DataStore();if(args instanceof Object){utility.merge(obj, args);}if(recs !== null && typeof recs === "object"){obj.batch("set", recs);}return obj;}, worker:function(ev){var cmd=ev.data.cmd;var records=ev.data.records;var clauses=undefined, cond=undefined, functions=undefined, indexes=undefined, index=undefined, result=undefined, sorted=undefined, where=undefined, values=undefined;if(cmd === "select"){where = JSON.parse(ev.data.where);functions = ev.data.functions;clauses = array.fromObject(where);sorted = array.flat(clauses).filter(function(i, idx){return idx % 2 === 0;}).sort(array.sort);index = sorted.join("|");values = sorted.map(function(i){return where[i];}).join("|");indexes = ev.data.indexes;cond = "return ( ";if(functions.length === 0 && indexes[index]){result = (indexes[index][values] || []).map(function(i){return records[i];});}else {if(clauses.length > 1){array.iterate(clauses, function(i, idx){var b1="( ";if(idx > 0){b1 = " && ( ";}if(array.contains(functions, i[0])){cond += b1 + i[1] + "( rec.data[\"" + i[0] + "\"] ) )";}else if(!isNaN(i[1])){cond += b1 + "rec.data[\"" + i[0] + "\"] === " + i[1] + " )";}else {cond += b1 + "rec.data[\"" + i[0] + "\"] === \"" + i[1] + "\" )";}});}else {if(array.contains(functions, clauses[0][0])){cond += clauses[0][1] + "( rec.data[\"" + clauses[0][0] + "\"] )";}else if(!isNaN(clauses[0][1])){cond += "rec.data[\"" + clauses[0][0] + "\"] === " + clauses[0][1];}else {cond += "rec.data[\"" + clauses[0][0] + "\"] === \"" + clauses[0][1] + "\"";}}cond += " );";result = records.filter(new Function("rec", cond));}}else if(cmd === "sort"){result = array.keySort(records, ev.data.query, "data");}postMessage(result);}};var string={capitalize:function(obj){var all=arguments[1] === undefined?false:arguments[1];var result=undefined;if(all){result = string.explode(obj, " ").map(function(i){return i.charAt(0).toUpperCase() + i.slice(1);}).join(" ");}else {result = obj.charAt(0).toUpperCase() + obj.slice(1);}return result;}, escape:function(obj){return obj.replace(/[\-\[\]{}()*+?.,\\\/\^\$|#\s]/g, "\\$&");}, explode:function(obj){var arg=arguments[1] === undefined?",":arguments[1];return string.trim(obj).split(new RegExp("\\s*" + arg + "\\s*"));}, fromObject:function(obj, name){var result=(name?name + " = {":"{") + "\n";utility.iterate(obj, function(v, k){result += "\"" + k + "\":" + v.toString() + ",\n";});result = result.replace(/\[object Object\]/g, "{}").replace(/,\n$/, "\n") + "}";return result;}, hyphenate:function(obj){var camel=arguments[1] === undefined?false:arguments[1];var result=string.trim(obj).replace(/\s+/g, "-");if(camel === true){result = result.replace(/([A-Z])/g, "-$1").toLowerCase();}return result;}, isBoolean:function(obj){return regex.bool.test(obj);}, isEmpty:function(obj){return string.trim(obj) === "";}, isNumber:function(obj){return regex.number.test(obj);}, isUrl:function(obj){return regex.url.test(obj);}, toCamelCase:function(obj){var s=string.trim(obj).replace(/\.|_|-|\@|\[|\]|\(|\)|\#|\$|\%|\^|\&|\*|\s+/g, " ").toLowerCase().split(regex.space_hyphen);var r=[];array.iterate(s, function(i, idx){r.push(idx === 0?i:string.capitalize(i));});return r.join("");}, singular:function(obj){return obj.replace(/oe?s$/, "o").replace(/ies$/, "y").replace(/ses$/, "se").replace(/s$/, "");}, toFunction:function(obj){var args=string.trim(obj.replace(/^.*\(/, "").replace(/[\t|\r|\n|\"|\']+/g, "").replace(/\).*/, ""));var body=string.trim(obj.replace(/^.*\{/, "").replace(/\}$/, ""));return Function.apply(Function, string.explode(args).concat([body]));}, trim:function(obj){return obj.replace(/^(\s+|\t+|\n+)|(\s+|\t+|\n+)$/g, "");}, unCamelCase:function(obj){return string.trim(obj.replace(/([A-Z])/g, " $1").toLowerCase());}, uncapitalize:function(obj){var result=string.trim(obj);return result.charAt(0).toLowerCase() + result.slice(1);}, unhyphenate:function(obj){var caps=arguments[1] === undefined?false:arguments[1];if(caps !== true){return string.explode(obj, "-").join(" ");}else {return string.explode(obj, "-").map(function(i){return string.capitalize(i);}).join(" ");}}};var utility={timer:{}, repeating:{}, $:function(arg){var result=undefined;if(!arg){}else if(regex.html.test(arg)){result = [element.create(arg)];}else {arg = string.trim(arg);if(arg.indexOf(",") === -1){result = utility.dom(arg);if(result){if(isNaN(result.length)){result = [result];}}else {result = [];}}else {result = [];array.iterate(string.explode(arg), function(query){var obj=utility.dom(query);if(obj instanceof Array){result = result.concat(obj);}else if(obj){result.push(obj);}});}}return result;}, base:function(arg){var obj=new Base();if(arg instanceof Object){utility.merge(obj, arg);}obj.observer = observable.factory();return obj;}, blob:function(arg){var obj=undefined;try{obj = new Blob([arg], {type:"application/javascript"});}catch(e) {if(!global.BlobBuilder){global.BlobBuilder = global.MSBlobBuilder || global.WebKitBlobBuilder || global.MozBlobBuilder;}obj = new global.BlobBuilder().append(arg).getBlob();}return obj;}, clearTimers:function(id){if(utility.timer[id]){clearTimeout(utility.timer[id]);delete utility.timer[id];}if(utility.repeating[id]){clearTimeout(utility.repeating[id]);delete utility.repeating[id];}}, clone:function(obj){var shallow=arguments[1] === undefined?false:arguments[1];var clone=undefined, result=undefined;if(shallow === true){return obj !== undefined && obj !== null?JSON.parse(JSON.stringify(obj)):obj;}else if(!obj || regex.primitive.test(typeof obj) || obj instanceof RegExp){return obj;}else if(obj instanceof Array){result = [];array.iterate(obj, function(i, idx){result[idx] = utility.clone(i);});return result;}else if(!server && !client.ie && obj instanceof Document){return xml.decode(xml.encode(obj));}else if(typeof obj.__proto__ != "undefined"){return utility.extend(obj.__proto__, obj);}else if(obj instanceof Object){clone = json.encode(obj, true);if(clone !== undefined){clone = json.decode(clone);utility.iterate(obj, function(v, k){if(typeof v === "function"){clone[k] = v;}});}else {clone = obj;}return clone;}else {return obj;}}, coerce:function(value){var tmp=undefined;if(value === null || value === undefined){return undefined;}else if(value === "true"){return true;}else if(value === "false"){return false;}else if(value === "null"){return null;}else if(value === "undefined"){return undefined;}else if(value === ""){return value;}else if(!isNaN(tmp = Number(value))){return tmp;}else if(regex.json_wrap.test(value)){return json.decode(value, true) || value;}else {return value;}}, compile:function(reg, pattern, modifiers){reg.compile(pattern, modifiers);return true;}, curry:function(fn){for(var _len=arguments.length, args=Array(_len > 1?_len - 1:0), _key=1; _key < _len; _key++) {args[_key - 1] = arguments[_key];}var cfn=fn.apply(fn, args);return function(){for(var _len2=arguments.length, args=Array(_len2), _key2=0; _key2 < _len2; _key2++) {args[_key2] = arguments[_key2];}return cfn.apply(cfn, args);};}, defer:function(fn, _x3, id){var ms=arguments[1] === undefined?0:arguments[1];var repeat=arguments[3] === undefined?false:arguments[3];var op=undefined;if(id !== undefined){utility.clearTimers(id);}else {id = utility.uuid(true);}op = function(){utility.clearTimers(id);fn();};utility[repeat?"repeating":"timer"][id] = setTimeout(op, ms);return id;}, delay:(function(){if(typeof setImmediate != "undefined"){return function(arg){setImmediate(arg);};}else if(typeof process != "undefined"){return process.nextTick;}else {return function(arg){setTimeout(arg, 0);};}})(), dom:function(arg){var result=undefined;if(!regex.selector_complex.test(arg)){if(regex.hash.test(arg)){result = document.getElementById(arg.replace(regex.hash, "")) || undefined;}else if(regex.klass.test(arg)){result = array.cast(document.getElementsByClassName(arg.replace(regex.klass, "")));}else if(regex.word.test(arg)){result = array.cast(document.getElementsByTagName(arg));}else {result = array.cast(document.querySelectorAll(arg));}}else {result = array.cast(document.querySelectorAll(arg));}return result;}, domId:function(arg){return "a" + arg.replace(/-/g, "").slice(1);}, equal:function(a, b){return json.encode(a, true) === json.encode(b, true);}, error:function(e, args, scope, warning){var o={arguments:args?array.cast(args):[], message:e.message || e, number:e.number?e.number & 65535:undefined, scope:scope, stack:e.stack || undefined, timestamp:new Date().toUTCString(), type:e.type || "TypeError"};utility.log(o.stack || o.message, warning !== true?"error":"warn");return undefined;}, extend:function(obj, arg){var o=Object.create(obj);if(arg instanceof Object){utility.merge(o, arg);}o["super"] = obj;return o;}, genId:function(obj){var dom=arguments[1] === undefined?false:arguments[1];var id=undefined;if(obj && (obj.id || obj instanceof Array || (typeof obj === "string" || obj instanceof String))){return obj;}if(dom){do{id = utility.domId(utility.uuid(true));}while(utility.dom("#" + id));}else {id = utility.domId(utility.uuid(true));}if(obj && typeof obj === "object"){obj.id = id;return obj;}else {return id;}}, iterate:function(obj, fn){array.iterate(Object.keys(obj), function(i){return fn.call(obj, obj[i], i);});return obj;}, log:(function(){if(typeof console != "undefined"){return function(arg){var target=arguments[1] === undefined?"log":arguments[1];var ts=typeof arg != "object";var msg=ts?"[" + new Date().toLocaleTimeString() + "] " + arg:arg;console[target](msg);};}else {return function(){};}})(), merge:function(obj, arg){var keys=array.keys(obj);utility.iterate(arg, function(v, k){if(!array.contains(keys, k) || v instanceof Function){obj[k] = v;}else if(obj[k] instanceof Array && v instanceof Array){array.merge(obj[k], v);}else if(v instanceof Function){obj[k] = v;}else if(obj[k] instanceof Object && v instanceof Object){utility.iterate(v, function(x, y){obj[k][y] = utility.clone(x);});}else {obj[k] = utility.clone(v);}});return obj;}, parse:function(uri){var obj={};var parsed={};var host=undefined, protocol=undefined;if(uri === undefined){uri = !server?location.href:"";}if(!server){obj = document.createElement("a");obj.href = uri;host = obj.href.match(regex.host)[1];protocol = obj.href.match(regex.protocol)[1];}else {obj = url.parse(uri);}if(server){utility.iterate(obj, function(v, k){if(v === null){obj[k] = undefined;}});}parsed = {auth:server?null:regex.auth.exec(uri), protocol:obj.protocol || protocol, hostname:obj.hostname || host, port:obj.port?number.parse(obj.port, 10):"", pathname:obj.pathname, search:obj.search || "", hash:obj.hash || "", host:obj.host || host};if(client.ie){if(parsed.protocol === ":"){parsed.protocol = location.protocol;}if(string.isEmpty(parsed.hostname)){parsed.hostname = location.hostname;}if(string.isEmpty(parsed.host)){parsed.host = location.host;}if(parsed.pathname.charAt(0) !== "/"){parsed.pathname = "/" + parsed.pathname;}}parsed.auth = obj.auth || (parsed.auth === null?"":parsed.auth[1]);parsed.href = obj.href || parsed.protocol + "//" + (string.isEmpty(parsed.auth)?"":parsed.auth + "@") + parsed.host + parsed.pathname + parsed.search + parsed.hash;parsed.path = obj.path || parsed.pathname + parsed.search;parsed.query = utility.queryString(null, parsed.search);return parsed;}, partial:function(fn){for(var _len=arguments.length, args=Array(_len > 1?_len - 1:0), _key=1; _key < _len; _key++) {args[_key - 1] = arguments[_key];}return function(){for(var _len2=arguments.length, args2=Array(_len2), _key2=0; _key2 < _len2; _key2++) {args2[_key2] = arguments[_key2];}return fn.apply(fn, args.concat(args2));};}, prevent:function(ev){if(typeof ev.preventDefault === "function"){ev.preventDefault();}return ev;}, queryString:function(arg, qstring){var obj={};var result=qstring !== undefined?qstring.indexOf("?") > -1?qstring.replace(/.*\?/, ""):null:server || string.isEmpty(location.search)?null:location.search.replace("?", "");if(result !== null && !string.isEmpty(result)){result = result.split("&");array.iterate(result, function(prop){var item=prop.split("=");if(string.isEmpty(item[0])){return;}if(item[1] === undefined){item[1] = "";}else {item[1] = utility.coerce(decodeURIComponent(item[1]));}if(obj[item[0]] === undefined){obj[item[0]] = item[1];}else if(!(obj[item[0]] instanceof Array)){obj[item[0]] = [obj[item[0]]];obj[item[0]].push(item[1]);}else {obj[item[0]].push(item[1]);}});}if(arg !== null && arg !== undefined){obj = obj[arg];}return obj;}, race:function(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}var defer=deferred.factory();if(args[0] instanceof Array){args = args[0];}if(args.length === 0){defer.resolve(null);}else {Promise.race(args).then(function(results){defer.resolve(results);}, function(e){defer.reject(e);});}return defer;}, render:function(fn){var defer=deferred.factory();RENDER(function(arg){try{defer.resolve(fn(arg));}catch(e) {defer.reject(e);}});return defer;}, repeat:function(fn){var ms=arguments[1] === undefined?10:arguments[1];var id=arguments[2] === undefined?utility.uuid(true):arguments[2];var now=arguments[3] === undefined?true:arguments[3];if(now && fn() === false){return;}utility.defer(function(){var recursive=function(fn, ms, id){if(fn() !== false){utility.repeating[id] = setTimeout(function(){recursive.call(recursive, fn, ms, id);}, ms);}else {delete utility.repeating[id];}};recursive(fn, ms, id);}, ms, id, true);return id;}, stop:function(ev){if(typeof ev.stopPropagation === "function"){ev.stopPropagation();}utility.prevent(ev);return ev;}, target:function(ev){return ev.target || ev.srcElement;}, uuid:function(strip){var r=[8, 9, "a", "b"];var s=function(){return ((1 + Math.random()) * 65536 | 0).toString(16).substring(1);};var o=s() + s() + "-" + s() + "-4" + s().substr(0, 3) + "-" + r[Math.floor(Math.random() * 4)] + s().substr(0, 3) + "-" + s() + s() + s();if(strip === true){o = o.replace(/-/g, "");}return o;}, walk:function(obj, arg){var output=obj;array.iterate(arg.replace(/\]$/, "").replace(/\]/g, ".").replace(/\.\./g, ".").split(/\.|\[/), function(i){if(output[i] === undefined || output[i] === null){output = undefined;return false;}output = output[i];});return output;}, when:function(){for(var _len=arguments.length, args=Array(_len), _key=0; _key < _len; _key++) {args[_key] = arguments[_key];}var defer=deferred.factory();if(args[0] instanceof Array){args = args[0];}if(args.length === 0){defer.resolve(null);}else {Promise.all(args).then(function(results){defer.resolve(results);}, function(e){defer.reject(e);});}return defer;}, worker:function(defer){var obj=new Worker(WORKER);obj.onerror = function(err){defer.reject(err);obj.terminate();};obj.onmessage = function(ev){defer.resolve(ev.data);obj.terminate();};return obj;}};var xhr=function(){var UNSENT=0;var OPENED=1;var HEADERS_RECEIVED=2;var LOADING=3;var DONE=4;var ERR_REFUSED=/ECONNREFUSED/;var ready=new RegExp(HEADERS_RECEIVED + "|" + LOADING);var headers={"user-agent":"keigai/1.2.1 node.js/" + process.versions.node.replace(/^v/, "") + " (" + string.capitalize(process.platform) + " V8/" + process.versions.v8 + " )", "content-type":"text/plain", accept:"*/*"};var dispatch=function(obj, arg){var fn="on" + arg;if(typeof obj[fn] === "function"){obj[fn]();}obj.dispatchEvent(arg);return obj;};var state=function(obj, arg){if(obj.readyState !== arg){obj.readyState = arg;dispatch(obj, "readystatechange");if(obj.readyState === DONE && !obj._error){dispatch(obj, "load");dispatch(obj, "loadend");}}return obj;};var success=function(obj, res){state(obj, HEADERS_RECEIVED);obj.status = res.statusCode;obj._resheaders = res.headers;if(obj._resheaders["set-cookie"] && obj._resheaders["set-cookie"] instanceof Array){obj._resheaders["set-cookie"] = obj._resheaders["set-cookie"].join(";");}res.on("data", function(arg){res.setEncoding("utf8");if(obj._send){if(arg){obj.responseText += arg;}state(obj, LOADING);}});res.on("end", function(){if(obj._send){state(obj, DONE);obj._send = false;}});};var failure=function(obj, e){obj.status = ERR_REFUSED.test(e.message)?503:500;obj.statusText = "";obj.responseText = e.message;obj._error = true;obj._send = false;dispatch(obj, "error");state(obj, DONE);};var XMLHttpRequest=(function(_Base6){function XMLHttpRequest(){_classCallCheck(this, XMLHttpRequest);this.onabort = null;this.onerror = null;this.onload = null;this.onloadend = null;this.onloadstart = null;this.onreadystatechange = null;this.readyState = UNSENT;this.response = null;this.responseText = "";this.responseType = "";this.responseXML = null;this.status = UNSENT;this.statusText = "";this.observer = observable.factory();this._error = false;this._headers = {};this._params = {};this._request = null;this._resheaders = {};this._send = false;}_inherits(XMLHttpRequest, _Base6);_createClass(XMLHttpRequest, {abort:{value:function abort(){if(this._request !== null){this._request.abort();this._request = null;this.responseText = "";this.responseXML = "";this._error = true;this._headers = {};if(this._send === true || ready.test(this.readyState)){this._send = false;state(this, DONE);}dispatch(this, "abort");this.readyState = UNSENT;}return this;}}, getAllResponseHeaders:{value:function getAllResponseHeaders(){var result="";if(this.readyState < HEADERS_RECEIVED){throw new Error(label.invalidStateNoHeaders);}utility.iterate(this._resheaders, function(v, k){result += k + ": " + v + "\n";});return result;}}, getResponseHeader:{value:function getResponseHeader(header){if(this.readyState < HEADERS_RECEIVED || this._error){throw new Error(label.invalidStateNoHeaders);}return this._resheaders[header] || this._resheaders[header.toLowerCase()];}}, open:{value:function open(method, url, async, user, password){var self=this;if(async !== true){throw new Error(label.invalidStateNoSync);}this.abort();this._error = false;this._params = {method:method, url:url, async:async || true, user:user || null, password:password || null};utility.iterate(headers, function(v, k){self._headers[k] = v;});this.readyState = OPENED;return this;}}, overrideMimeType:{value:function overrideMimeType(mime){this._headers["content-type"] = mime;return this;}}, send:{value:function send(){var data=arguments[0] === undefined?null:arguments[0];var self=this;var options=undefined, parsed=undefined, request=undefined, obj=undefined;if(this.readyState < OPENED){throw new Error(label.invalidStateNotOpen);}else if(this._send){throw new Error(label.invalidStateNotSending);}parsed = utility.parse(this._params.url);parsed.port = parsed.port || (parsed.protocol === "https:"?443:80);if(this._params.user !== null && this._params.password !== null){parsed.auth = this._params.user + ":" + this._params.password;}if(regex.put_post.test(this._params.method)){if(data === null){this._headers["content-length"] = 0;}else if(typeof data === "string"){this._headers["content-length"] = Buffer.byteLength(data);}else if(data instanceof Buffer || typeof data.toString === "function"){data = data.toString();this._headers["content-length"] = Buffer.byteLength(data);}else {throw new Error(label.invalidArguments);}}this._headers.host = parsed.host;if(this._headers["x-requested-with"] === "XMLHttpRequest"){delete this._headers["x-requested-with"];}options = {hostname:parsed.hostname, path:parsed.path, port:parsed.port, method:this._params.method, headers:this._headers};if(parsed.protocol === "https:"){options.rejectUnauthorized = false;options.agent = false;}if(parsed.auth){options.auth = parsed.auth;}this._send = true;dispatch(this, "readystatechange");obj = parsed.protocol === "http:"?http:https;request = obj.request(options, function(arg){success(self, arg);}).on("error", function(e){failure(self, e);});data === null?request.setSocketKeepAlive(true):request.write(data, "utf8");this._request = request;request.end();dispatch(this, "loadstart");return this;}}, setRequestHeader:{value:function setRequestHeader(header, value){if(this.readyState !== OPENED){throw new Error(label.invalidStateNotUsable);}else if(this._send){throw new Error(label.invalidStateNotSending);}this._headers[header.toLowerCase()] = value;return this;}}});return XMLHttpRequest;})(Base);return XMLHttpRequest;};var WeakMapShim=(function(){function WeakMapShim(){_classCallCheck(this, WeakMapShim);this.elements = {};}_createClass(WeakMapShim, {clear:{value:function clear(){this.elements = {};}}, "delete":{value:function _delete(arg){delete this.elements[arg];}}, has:{value:function has(arg){return this.elements[arg] !== undefined;}}, get:{value:function get(arg){return this.has(arg)?this.elements[arg].value:undefined;}}, set:{value:function set(arg, value){this.elements[arg] = {value:value};return this;}}});return WeakMapShim;})();var xml={decode:function(arg){return new DOMParser().parseFromString(arg, "text/xml");}, encode:function(arg){var wrap=arguments[1] === undefined?true:arguments[1];var top=arguments[2] === undefined?true:arguments[2];try{var _ret=(function(){var x=wrap?"<xml>":"";var node=function(name, value){var output="<n>v</n>";output = output.replace("v", regex.cdata.test(value)?"<![CDATA[" + value + "]]>":value);return output.replace(/<(\/)?n>/g, "<$1" + name + ">");};if(arg !== null && arg.xml){arg = arg.xml;}if(arg instanceof Document){arg = new XMLSerializer().serializeToString(arg);}if(regex.boolean_number_string.test(typeof arg)){x += node("item", arg);}else if(typeof arg === "object"){utility.iterate(arg, function(v, k){x += xml.encode(v, typeof v === "object", false).replace(/item|xml/g, isNaN(k)?k:"item");});}x += wrap?"</xml>":"";if(top){x = "<?xml version=\"1.0\" encoding=\"UTF8\"?>" + x;}return {v:x};})();if(typeof _ret === "object")return _ret.v;}catch(e) {utility.error(e, [arg, wrap, top], undefined);return undefined;}}, valid:function(arg){return xml.decode(arg).getElementsByTagName("parsererror").length === 0;}};var bootstrap=function(){var defineProperty=Object.defineProperty !== undefined;var target=undefined;Array.from = Array.from || function(arg){return [].slice.call(arg);};Array.keys = Array.keys || function(arg){return Object.keys(arg);};if(!server){client.version = client.version();if(client.ie && client.version < 10){throw new Error(label.upgrade);}}else {XMLHttpRequest = xhr();}if(WeakMap === null){WeakMap = WeakMapShim;}if(webWorker){try{WORKER = global.URL.createObjectURL(utility.blob("var " + string.fromObject(array, "array") + ", " + string.fromObject(regex, "regex") + ", " + string.fromObject(string, "string") + ", " + string.fromObject(utility, "utility") + "; onmessage = " + store.worker.toString() + ";"));}catch(e) {utility.log(e, "error");}}TIME = new Date().getTime();RENDER = global.requestAnimationFrame || function(fn){var offset=new Date().getTime() - TIME;utility.defer(function(){fn(offset);}, 16, offset);};};bootstrap();return {filter:filter.factory, list:list.factory, grid:grid.factory, store:store.factory, util:{$:utility.$, array:array, base:utility.base, clearTimers:utility.clearTimers, clone:utility.clone, coerce:utility.coerce, curry:utility.curry, csv:csv, defer:deferred.factory, delay:utility.defer, element:element, equal:utility.equal, extend:utility.extend, genId:utility.genId, iterate:utility.iterate, json:json, jsonp:client.jsonp, log:utility.log, lru:lru.factory, math:math, merge:utility.merge, number:number, observer:observable.factory, parse:utility.parse, partial:utility.partial, prevent:utility.prevent, race:utility.race, render:utility.render, repeat:utility.repeat, request:client.request, stop:utility.stop, string:string, target:utility.target, uuid:utility.uuid, walk:utility.walk, when:utility.when}, version:"1.2.1"};})();if(typeof exports != "undefined"){module.exports = lib;}else if(typeof define === "function"){define(function(){return lib;});}else {global.keigai = lib;}})(typeof global != "undefined"?global:window);